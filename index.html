<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Collaborative Booking</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Babel for JSX execution -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --primary-dark: #3730a3;
            --secondary: #ec4899;
            --accent: #10b981;
            --bg-slate: #f8fafc;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 95%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 90%, 1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            color: #1e293b;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 50px rgba(31, 38, 135, 0.08);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .cabin-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .cabin-card:hover:not(.disabled) {
            transform: translateY(-8px) scale(1.02);
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-light);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.1);
        }

        .cabin-card.isSelected {
            background: rgba(255, 255, 255, 1);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 4s ease-in-out infinite;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-enter {
            animation: slideUpFade 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        .input-group:focus-within label {
            color: var(--primary);
            transform: scale(0.95) translateX(2px);
        }

        .input-group:focus-within svg {
            color: var(--primary);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border: 2px solid #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .shimmer {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Interactive Placeholders & Inputs */
        input::placeholder,
        textarea::placeholder {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #94a3b8;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0.7;
        }

        input:focus::placeholder,
        textarea:focus::placeholder {
            transform: translateX(12px);
            opacity: 0;
        }

        .input-group select {
            color: #1e293b;
        }

        .input-group select option:first-child {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #94a3b8;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transition: all 0.3s ease;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
        }
    </style>
</head>

<body class="text-slate-800 antialiased selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, User, LogOut, Download, AlertTriangle, CheckCircle, XCircle, Users, BookOpen, Zap, Filter, Info, Star, Briefcase, MessageSquare, ChevronRight, GraduationCap, LayoutDashboard, Lock, Unlock, ShieldCheck, WifiOff, Loader2, Calendar, PlusCircle, Wifi, Monitor, Eraser, VolumeX, BatteryCharging, History, Archive } from 'https://esm.sh/lucide-react@0.263.1';

        // Firebase Imports (Stable Version)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border-l-4 border-red-500">
                                <h1 className="text-2xl font-bold text-slate-800 mb-2 flex items-center">
                                    <AlertTriangle className="w-8 h-8 text-red-500 mr-3" />
                                    System Error
                                </h1>
                                <p className="text-slate-600 mb-4">Something went unexpectedly wrong.</p>
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all">
                                    Reload Page
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
            authDomain: "library-booking-83e2a.firebaseapp.com",
            projectId: "library-booking-83e2a",
            storageBucket: "library-booking-83e2a.firebasestorage.app",
            messagingSenderId: "712017475970",
            appId: "1:712017475970:web:760a61d2bcbde376eff79b",
            measurementId: "G-XEHSTZ2SYD"
        };

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = "cabin_bookings";
        const USERS_COLLECTION = "users";

        const initialCabins = Array.from({ length: CABIN_COUNT }, (_, i) => {
            const num = i + 1;
            let capacity = 4;
            let amenities = ['Wifi', 'Charging'];
            if (num === 1 || num === 2) { capacity = 6; amenities.push('TV', 'Whiteboard'); }
            else if (num === 5 || num === 6) { capacity = 5; amenities.push('Whiteboard'); }
            else if (num > 10) { amenities.push('Quiet'); }
            return { id: `C${num}`, name: `Cabin ${num}`, capacity, amenities };
        });

        const getTimeSlots = () => {
            const slots = [];
            const now = new Date();
            now.setMinutes(now.getMinutes() > 30 ? 60 : 30);
            now.setSeconds(0);
            now.setMilliseconds(0);

            for (let i = 0; i < 24; i++) {
                const time = new Date(now.getTime() + i * 30 * 60000);
                slots.push({
                    value: time.toISOString(),
                    label: time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });
            }
            return slots;
        };

        const AmenityIcon = ({ type, className = "w-3 h-3" }) => {
            switch (type) {
                case 'Wifi': return <Wifi className={className} />;
                case 'TV': return <Monitor className={className} />;
                case 'Whiteboard': return <Eraser className={className} />;
                case 'Quiet': return <VolumeX className={className} />;
                case 'Charging': return <BatteryCharging className={className} />;
                default: return null;
            }
        };

        // --- Hooks & Helpers ---

        const useAlert = () => {
            const [alert, setAlert] = useState({ message: '', classes: '', visible: false });
            const alertUser = useCallback((message, classes) => {
                setAlert({ message, classes, visible: true });
                const timer = setTimeout(() => setAlert(prev => ({ ...prev, visible: false })), 5000);
                return () => clearTimeout(timer);
            }, []);
            const AlertComponent = () => (
                <div className={`fixed top-24 right-6 z-[100] transition-all duration-500 ease-out transform ${alert.visible ? 'translate-x-0 opacity-100' : 'translate-x-10 opacity-0 pointer-events-none'}`}>
                    <div className={`px-6 py-4 rounded-xl shadow-2xl backdrop-blur-md border border-white/20 flex items-center gap-3 font-medium ${alert.classes}`}>
                        {alert.message}
                    </div>
                </div>
            );
            return [alertUser, AlertComponent];
        };

        const useCountdown = (booking) => {
            const [time, setTime] = useState(null);
            const [isFuture, setIsFuture] = useState(false);

            useEffect(() => {
                if (!booking || (booking.status !== 'Approved' && booking.status !== 'Pending') || !booking.timestamp) {
                    setTime(null);
                    setIsFuture(false);
                    return;
                }

                const startTime = booking.timestamp.getTime ? booking.timestamp.getTime() : new Date(booking.timestamp).getTime();
                if (isNaN(startTime)) { setTime("Error"); return; }

                const updateTimer = () => {
                    const now = new Date().getTime();
                    const end = startTime + booking.durationHours * 3600000;

                    if (now < startTime) {
                        setIsFuture(true);
                        const diff = startTime - now;
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        const h = Math.floor(m / 60);
                        setTime(`${h}:${(m % 60).toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
                    } else {
                        setIsFuture(false);
                        const diff = end - now;
                        if (diff < 0) {
                            setTime("00:00:00");
                        } else {
                            const m = Math.floor(diff / 60000);
                            const s = Math.floor((diff % 60000) / 1000);
                            const h = Math.floor(m / 60);
                            setTime(`${h}:${(m % 60).toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
                        }
                    }
                };

                updateTimer();
                const interval = setInterval(updateTimer, 1000);
                return () => clearInterval(interval);
            }, [booking]);
            return { remainingTime: time, isFuture };
        };

        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime &&
                b.timestamp &&
                (b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()) <= now.getTime() &&
                ((b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()) + b.durationHours * 3600000) > now.getTime()
            );

            if (activeBooking) {
                return {
                    status: 'Occupied',
                    name: activeBooking.requesterName,
                    role: activeBooking.role || 'student'
                };
            }

            const pendingBooking = allBookings.find(b => b.cabinId === cabinId && b.status === 'Pending' && (b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()) <= (now.getTime() + 15 * 60000));
            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName, role: pendingBooking.role || 'student' };
            }

            // Find next upcoming booking
            const upcoming = allBookings
                .filter(b => b.cabinId === cabinId && (b.status === 'Approved' || b.status === 'Pending') && !b.completionTime && (b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()) > now.getTime())
                .sort((a, b) => (a.timestamp.getTime ? a.timestamp.getTime() : new Date(a.timestamp).getTime()) - (b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()))[0];

            if (upcoming) {
                return { status: 'Available', name: null, nextTime: upcoming.timestamp };
            }

            return { status: 'Available', name: null };
        };

        // --- Main Component ---

        const ConfirmationModal = ({ modal, setModal }) => {
            if (!modal) return null;
            const closeModal = () => setModal(null);
            return (
                <div className="fixed inset-0 bg-slate-950/80 backdrop-blur-2xl flex justify-center items-center z-[80] transition-all duration-300 p-6">
                    <div className="glass-panel p-10 rounded-[2.5rem] shadow-4xl w-full max-w-md border border-white/10 animate-enter relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 shimmer"></div>
                        <h3 className="text-3xl font-black text-white mb-3">{modal.title}</h3>
                        <p className="text-slate-400 mb-10 leading-relaxed text-sm font-medium">{modal.message}</p>
                        {modal.inputProps && (
                            <div className="mb-8">
                                <input {...modal.inputProps} className="w-full p-4.5 bg-white/5 border border-white/10 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:bg-white/10 outline-none transition-all text-white font-bold" />
                            </div>
                        )}
                        <div className="flex justify-end gap-4">
                            <button onClick={closeModal} className="px-8 py-3.5 rounded-2xl font-black text-xs uppercase tracking-widest text-slate-400 hover:text-white transition-colors bg-white/5 border border-white/5">Cancel</button>
                            <button onClick={() => { if (modal.action) modal.action(); closeModal(); }} className={`px-8 py-3.5 rounded-2xl font-black text-xs uppercase tracking-widest text-white shadow-2xl transition-all transform active:scale-95 btn-primary ${modal.confirmClass || 'bg-indigo-600 hover:bg-indigo-700'}`}>{modal.confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [userProfile, setUserProfile] = useState(null); // { name, role }

            const [studentBookings, setStudentBookings] = useState([]);
            const [facultyBookings, setFacultyBookings] = useState([]);
            const [userBooking, setUserBooking] = useState(null);

            const [selectedCabinId, setSelectedCabinId] = useState('');
            const [selectedCapacity, setSelectedCapacity] = useState(0);
            const [groupMembers, setGroupMembers] = useState([]);

            const [bookingRole, setBookingRole] = useState('student');
            const [isSpecialRequest, setIsSpecialRequest] = useState(false);
            const [specialReason, setSpecialReason] = useState('Interview');
            const [specialSize, setSpecialSize] = useState(1);
            const [specialComment, setSpecialComment] = useState('');

            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [view, setView] = useState('grid'); // 'grid', 'history'
            const [adminHistoryMode, setAdminHistoryMode] = useState(false);
            const [adminViewRole, setAdminViewRole] = useState('student');
            const [capacityFilter, setCapacityFilter] = useState('');
            const [modal, setModal] = useState(null);
            const [alertUser, AlertComponent] = useAlert();

            const [bookingSchedule, setBookingSchedule] = useState('Immediate'); // 'Immediate' or 'Scheduled'
            const [scheduledTime, setScheduledTime] = useState('');

            const { remainingTime, isFuture } = useCountdown(userBooking);

            const allBookings = useMemo(() => [...studentBookings, ...facultyBookings], [studentBookings, facultyBookings]);

            const setDemoModeActive = useCallback((reason = "") => {
                setIsDemoMode(true);
                setUserId("demo-user-123");
                setIsAuthReady(true);

                const saved = localStorage.getItem(`demo_profile_demo-user-123`);
                if (saved) setUserProfile(JSON.parse(saved));

                const mockStudent = { id: 'mock-1', cabinId: 'C1', status: 'Approved', requesterId: 'other', requesterName: 'Alice', groupMembers: ['Alice'], timestamp: new Date(), durationHours: 2, capacity: 6, role: 'student' };
                const mockFaculty = { id: 'mock-2', cabinId: 'C5', status: 'Pending', requesterId: 'prof', requesterName: 'Dr. Smith', groupMembers: ['Dr. Smith'], timestamp: new Date(), durationHours: 2, capacity: 5, role: 'faculty' };

                setStudentBookings([mockStudent]);
                setFacultyBookings([mockFaculty]);
                setIsLoading(false);

                if (reason) alertUser(<span>{reason}</span>, "bg-slate-800 text-white");
            }, [alertUser, isDemoMode]);

            useEffect(() => {
                if (!firebaseConfig) { setDemoModeActive("Local Mode"); return; }
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auther = getAuth(app);
                    setDb(firestore);
                    setAuth(auther);
                    signInAnonymously(auther).catch(e => setDemoModeActive("Auth Failed"));
                    const unsub = onAuthStateChanged(auther, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                            setIsLoading(false);

                            // Fetch Profile
                            try {
                                const userDoc = await getDoc(doc(firestore, USERS_COLLECTION, user.uid));
                                if (userDoc.exists()) {
                                    const data = userDoc.data();
                                    setUserProfile(data);
                                    setBookingRole(data.role);
                                }
                            } catch (e) {
                                console.error("Profile check failed:", e);
                            }
                        }
                    });
                    return () => unsub();
                } catch (err) { setDemoModeActive("Config Error"); }
            }, [setDemoModeActive]);

            useEffect(() => {
                if (isDemoMode) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current || null);
                    return;
                }
                if (!db || !isAuthReady || !userId) return;

                const unsub = onSnapshot(query(collection(db, BOOKINGS_COLLECTION)), (snapshot) => {
                    const students = [];
                    const faculty = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const b = { id: doc.id, ...data };
                        if (b.timestamp?.toDate) b.timestamp = b.timestamp.toDate();
                        if (b.completionTime?.toDate) b.completionTime = b.completionTime.toDate();

                        if (b.role === 'faculty') faculty.push(b);
                        else students.push({ ...b, role: 'student' });
                    });
                    setStudentBookings(students);
                    setFacultyBookings(faculty);
                    setIsLoading(false);
                }, (err) => {
                    if (err.code === 'permission-denied') setDemoModeActive("Database Locked. Using Demo.");
                });
                return () => unsub();
            }, [db, isAuthReady, userId, isDemoMode, setDemoModeActive]);

            useEffect(() => {
                if (!isDemoMode && allBookings.length > 0) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current || null);
                }
            }, [allBookings, userId, isDemoMode]);

            const selectCabin = (cabinId, capacity) => {
                setSelectedCabinId(cabinId);
                setSelectedCapacity(capacity);
                // Reset Special Request State
                setIsSpecialRequest(false);
                setSpecialSize(1);
                setGroupMembers(new Array(capacity).fill(''));

                // Scroll to form
                setTimeout(() => document.getElementById('booking-form-anchor')?.scrollIntoView({ behavior: 'smooth' }), 100);
            };

            const scrollToMap = () => {
                const mapElement = document.getElementById('cabin-map-section');
                if (mapElement) {
                    const yOffset = -120;
                    const y = mapElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
            }

            const saveProfile = async (profileData) => {
                if (!profileData.name || !profileData.name.trim()) return alertUser("Identity required", "bg-red-500 text-white");

                try {
                    const profile = { ...profileData, createdAt: new Date().toISOString() };

                    // Update UI immediately for better UX
                    setUserProfile(profile);
                    setBookingRole(profile.role);

                    if (isDemoMode) {
                        localStorage.setItem(`demo_profile_${userId}`, JSON.stringify(profile));
                    } else if (db) {
                        await setDoc(doc(db, USERS_COLLECTION, userId), profile);
                    }

                    alertUser("Identity Established", "bg-indigo-600 text-white");
                } catch (e) {
                    console.error("Setup error:", e);
                    // We don't revert UI here to let user proceed even if DB fails, 
                    // unless you want high security.
                    alertUser("Cloud sync failed (Local focus)", "bg-amber-500 text-white");
                }
            };

            const submitBooking = async () => {
                if (!selectedCabinId) return alertUser("Select a cabin", "bg-red-500 text-white");
                const filled = groupMembers.map(n => n.trim());
                if (filled.some(n => !n)) return alertUser("Fill all names", "bg-red-500 text-white");

                if (bookingSchedule === 'Scheduled' && !scheduledTime)
                    return alertUser("Select a time slot", "bg-red-500 text-white");

                const startTime = bookingSchedule === 'Scheduled' ? new Date(scheduledTime) : new Date();

                // Conflict Detection
                const hasConflict = allBookings.some(b => {
                    if (b.cabinId !== selectedCabinId) return false;
                    if (b.status === 'Rejected' || b.status === 'Completed' || b.completionTime) return false;

                    const bStart = b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime();
                    const bEnd = bStart + b.durationHours * 3600000;
                    const rStart = startTime.getTime();
                    const rEnd = rStart + BOOKING_DURATION_HOURS * 3600000;

                    return rStart < bEnd && rEnd > bStart;
                });

                if (hasConflict) return alertUser("Time slot unavailable", "bg-red-500 text-white");

                const bookingData = {
                    cabinId: selectedCabinId,
                    capacity: isSpecialRequest ? specialSize : selectedCapacity,
                    requesterName: filled[0],
                    requesterUID: userId,
                    requesterId: userId, // Legacy support
                    groupMembers: filled,
                    timestamp: isDemoMode ? startTime : Timestamp.fromDate(startTime),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    bookingType: isSpecialRequest ? 'Special' : 'Standard',
                    specialReason: isSpecialRequest ? specialReason : null,
                    specialComment: isSpecialRequest ? specialComment : null,
                    role: bookingRole
                };

                if (isDemoMode) {
                    const mock = { ...bookingData, id: `demo-${Date.now()}` };
                    if (bookingRole === 'student') setStudentBookings(p => [...p, mock]);
                    else setFacultyBookings(p => [...p, mock]);
                    alertUser("Submitted (Demo)", "bg-emerald-500 text-white");
                    setSelectedCabinId('');
                    return;
                }

                try {
                    await addDoc(collection(db, BOOKINGS_COLLECTION), bookingData);
                    setSelectedCabinId('');
                    alertUser("Request Submitted", "bg-emerald-500 text-white");
                } catch (e) {
                    if (e.code === 'permission-denied') setDemoModeActive("Permission Denied");
                    else alertUser("Error submitting", "bg-red-500 text-white");
                }
            };

            const cancelBooking = async () => {
                if (!userBooking) return;
                if (isDemoMode) {
                    const setter = userBooking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    setter(prev => prev.filter(b => b.id !== userBooking.id));
                    setUserBooking(null);
                    return;
                }
                try { await deleteDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id)); } catch (e) { console.error(e); }
            };

            const completeBooking = async () => {
                if (!userBooking || isDemoMode) return cancelBooking(); // Simpler logic for demo
                try { await updateDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id), { status: 'Completed', completionTime: Timestamp.now() }); } catch (e) { console.error(e); }
            };

            const updateBookingStatus = async (booking, newStatus) => {
                if (isDemoMode) {
                    const setter = booking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    setter(prev => prev.map(b => b.id === booking.id ? { ...b, status: newStatus, completionTime: newStatus === 'Completed' ? new Date() : b.completionTime } : b));
                    return;
                }
                try {
                    const updates = { status: newStatus };
                    if (newStatus === 'Approved') updates.approvedBy = 'Librarian';
                    if (newStatus === 'Completed') updates.completionTime = Timestamp.now();
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, booking.id), updates);
                } catch (e) { console.error(e); }
            };

            const passwordRef = useRef('');
            const handleLogin = () => {
                passwordRef.current = '';
                setModal({
                    title: "Librarian Login",
                    message: "Enter password:",
                    confirmText: "Access Panel",
                    confirmClass: "bg-indigo-600 hover:bg-indigo-700",
                    inputProps: { type: "password", placeholder: "Password", onChange: e => passwordRef.current = e.target.value },
                    action: () => {
                        if (passwordRef.current === 'admin123') { setIsAdminLoggedIn(true); alertUser("Logged In", "bg-emerald-500 text-white"); }
                        else alertUser("Invalid Password", "bg-red-500 text-white");
                    }
                });
            };

            const filteredCabins = useMemo(() => {
                if (!capacityFilter) return initialCabins;
                return initialCabins.filter(c => c.capacity === parseInt(capacityFilter));
            }, [capacityFilter]);

            if (isLoading) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                    <div className="flex flex-col items-center">
                        <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Initializing Neural Link...</p>
                    </div>
                </div>
            );

            if (isAuthReady && !userProfile && !isAdminLoggedIn) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-50 via-slate-50 to-slate-50">
                        <div className="w-full max-w-md bg-white p-10 rounded-[2.5rem] shadow-2xl border border-slate-100 animate-enter">
                            <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mb-8 mx-auto text-indigo-600 border border-indigo-100 animate-float">
                                <User className="w-10 h-10" />
                            </div>
                            <h2 className="text-3xl font-black text-slate-900 text-center mb-2 tracking-tight">Establish Identity</h2>
                            <p className="text-slate-500 text-center mb-10 font-bold text-[10px] uppercase tracking-[0.2em]">Connect to Library intelligence</p>

                            <div className="space-y-6">
                                <div className="input-group">
                                    <label className="block text-[11px] font-black text-indigo-600 uppercase mb-3 ml-1 tracking-[0.1em]">Operator Name</label>
                                    <input
                                        type="text"
                                        placeholder="ENTER YOUR FULL NAME..."
                                        className="w-full p-5 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20 transition-all font-bold text-slate-800 text-[15px]"
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') saveProfile({ name: e.target.value, role: 'student' });
                                        }}
                                        id="setup-name"
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-4 pt-2">
                                    <button onClick={() => saveProfile({ name: document.getElementById('setup-name').value, role: 'student' })} className="py-5 bg-white border border-slate-100 rounded-2xl font-black text-[11px] uppercase tracking-widest text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm">Student</button>
                                    <button onClick={() => saveProfile({ name: document.getElementById('setup-name').value, role: 'faculty' })} className="py-5 bg-white border border-slate-100 rounded-2xl font-black text-[11px] uppercase tracking-widest text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm">Faculty</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24">
                    <AlertComponent />
                    <ConfirmationModal modal={modal} setModal={setModal} />

                    <header className="glass-header px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-8">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <Zap className="w-5 h-5" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black text-slate-900 tracking-tight">CabinControl</h1>
                                    <p className="text-[10px] text-indigo-600 font-bold uppercase tracking-widest">Library Intelligence</p>
                                </div>
                            </div>

                            {!isAdminLoggedIn && (
                                <nav className="hidden md:flex items-center bg-slate-100 p-1 rounded-xl">
                                    <button onClick={() => setView('grid')} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${view === 'grid' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Grid</button>
                                    <button onClick={() => setView('history')} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${view === 'history' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>History</button>
                                </nav>
                            )}
                        </div>
                        <div className="flex items-center gap-4">
                            {userProfile && !isAdminLoggedIn && (
                                <div className="hidden sm:flex flex-col items-end mr-2">
                                    <span className="text-[11px] font-black text-slate-800 uppercase tracking-tight">{userProfile.name}</span>
                                    <span className="text-[9px] text-indigo-500 font-bold uppercase">{userProfile.role} Operator</span>
                                </div>
                            )}
                            {isDemoMode && <div className="text-[10px] font-bold bg-amber-100 text-amber-700 px-3 py-1 rounded-full border border-amber-200 shadow-sm flex items-center"><WifiOff className="w-3 h-3 mr-1" /> OFFLINE</div>}
                            <button onClick={isAdminLoggedIn ? () => { setIsAdminLoggedIn(false); setView('grid'); } : handleLogin} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-xs font-black transition-all shadow-sm ${isAdminLoggedIn ? 'bg-indigo-50 text-indigo-600 border border-indigo-100' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>
                                {isAdminLoggedIn ? <Unlock className="w-3 h-3" /> : <Lock className="w-3 h-3" />}
                                {isAdminLoggedIn ? "System Logout" : "Agent Login"}
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 pt-10 space-y-12 pb-20">
                        {view === 'history' && !isAdminLoggedIn ? (
                            <section className="animate-enter">
                                <div className="bg-white rounded-[2.5rem] p-10 border border-slate-100 shadow-2xl">
                                    <div className="flex justify-between items-center mb-10">
                                        <h3 className="text-3xl font-black text-slate-900 tracking-tight">Deployment History</h3>
                                        <div className="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest border border-indigo-100">
                                            {allBookings.filter(b => b.requesterUID === userId).length} Total Sessions
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        {allBookings.filter(b => b.requesterUID === userId).length === 0 ? (
                                            <div className="py-20 text-center">
                                                <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                                                    <History className="w-8 h-8" />
                                                </div>
                                                <p className="text-slate-400 font-bold uppercase tracking-widest text-[10px]">No historical data found</p>
                                            </div>
                                        ) : (
                                            allBookings.filter(b => b.requesterUID === userId).sort((a, b) => (b.timestamp?.getTime ? b.timestamp.getTime() : 0) - (a.timestamp?.getTime ? a.timestamp.getTime() : 0)).map(b => (
                                                <div key={b.id} className="p-6 bg-slate-50/50 border border-slate-100 rounded-3xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4 transition-all hover:bg-white hover:shadow-xl hover:border-slate-200 group">
                                                    <div className="flex items-center gap-4">
                                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-black text-lg shadow-sm border ${b.status === 'Approved' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : b.status === 'Rejected' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-amber-50 text-amber-600 border-amber-100'}`}>
                                                            {b.cabinId}
                                                        </div>
                                                        <div>
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="text-[13px] font-black text-slate-900">{b.requesterName}</span>
                                                                <span className={`text-[9px] font-black px-2 py-0.5 rounded-full border uppercase tracking-wider ${b.status === 'Approved' ? 'bg-emerald-100/50 text-emerald-700 border-emerald-200' : b.status === 'Rejected' ? 'bg-red-100/50 text-red-700 border-red-200' : 'bg-amber-100/50 text-amber-700 border-amber-200'}`}>{b.status}</span>
                                                            </div>
                                                            <div className="flex items-center gap-3 text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                                                                <span className="flex items-center"><Calendar className="w-3 h-3 mr-1" /> {b.timestamp ? b.timestamp.toLocaleDateString() : 'N/A'}</span>
                                                                <span className="flex items-center"><Clock className="w-3 h-3 mr-1" /> {b.timestamp ? b.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</span>
                                                                <span className="flex items-center"><Users className="w-3 h-3 mr-1" /> {b.capacity} Cap</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="w-full md:w-auto flex justify-between md:justify-end items-center gap-6">
                                                        <div className="text-right">
                                                            <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-1">Protocol Type</p>
                                                            <p className="text-[11px] font-black text-slate-800 uppercase">{b.bookingType === 'Special' ? 'Special Activation' : 'Standard Core'}</p>
                                                        </div>
                                                        <ChevronRight className="w-5 h-5 text-slate-300 group-hover:text-indigo-400 transition-colors" />
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </section>
                        ) : (
                            <>
                                {/* Status Section */}
                                <section className="animate-enter">
                                    {userBooking ? (
                                        <div className="relative bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden group">
                                            <div className={`absolute top-0 left-0 w-full h-2 shimmer ${userBooking.status === 'Approved' ? 'bg-gradient-to-r from-emerald-400 to-teal-500' : 'bg-gradient-to-r from-amber-400 to-orange-500'}`}></div>
                                            <div className="p-8 md:p-12 relative z-10">
                                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 mb-10">
                                                    <div className="animate-enter">
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white shadow-sm ${userBooking.status === 'Approved' ? 'bg-emerald-500' : 'bg-amber-500'}`}>
                                                                {userBooking.status === 'Approved' ? <CheckCircle className="w-3 h-3 mr-1.5" /> : <Clock className="w-3 h-3 mr-1.5" />}
                                                                {userBooking.status.toUpperCase()}
                                                            </span>
                                                            <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{userBooking.role} Booking</span>
                                                        </div>
                                                        <h2 className="text-5xl font-black text-slate-900 tracking-tighter">{userBooking.cabinId}</h2>
                                                        {userBooking.bookingType === 'Special' && <div className="mt-4 text-xs text-indigo-600 font-black bg-indigo-50 inline-flex items-center px-4 py-1.5 rounded-full border border-indigo-100 uppercase tracking-widest">âœ¨ Special Protocol: {userBooking.specialReason}</div>}
                                                    </div>

                                                    {(userBooking.status === 'Approved' || isFuture) && (
                                                        <div className="bg-white/5 px-8 py-5 rounded-3xl border border-white/10 text-center min-w-[160px] backdrop-blur-md">
                                                            <p className="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-1">{isFuture ? 'Logistics Wait' : 'Time Remaining'}</p>
                                                            <div className="text-4xl font-mono font-black text-slate-900">
                                                                {remainingTime || '--:--'}
                                                                {isFuture && <span className="block text-[8px] mt-1 text-slate-400">STARTS IN</span>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="flex gap-4 pt-8 border-t border-white/5">
                                                    {userBooking.status === 'Approved' && (
                                                        <button onClick={() => setModal({ title: "Deactivate Session?", message: "This will release the node resources immediately.", confirmText: "Initalize Checkout", action: completeBooking, confirmClass: "bg-emerald-600 hover:bg-emerald-700" })}
                                                            className="flex-1 py-4 bg-emerald-600/10 hover:bg-emerald-600 text-emerald-400 hover:text-white font-black rounded-2xl transition-all shadow-xl border border-emerald-500/20 flex items-center justify-center uppercase tracking-widest text-xs active:scale-95">
                                                            <LogOut className="w-4 h-4 mr-2" /> Checkout
                                                        </button>
                                                    )}
                                                    <button onClick={() => setModal({ title: "Abort Request?", message: "This sequence termination cannot be reversed.", confirmText: "Terminate Sequence", action: cancelBooking, confirmClass: "bg-red-600 hover:bg-red-700" })}
                                                        className={`py-4 px-8 rounded-2xl font-black transition-all flex items-center justify-center uppercase tracking-widest text-xs active:scale-95 ${userBooking.status === 'Approved' ? 'bg-white/5 border border-white/10 text-slate-400 hover:text-red-400 hover:bg-red-500/10' : 'w-full bg-white/5 text-slate-400 border border-white/10 hover:bg-red-500/10 hover:text-red-400'}`}>
                                                        Abort
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-white p-16 rounded-[2rem] text-center border border-slate-100 shadow-2xl relative overflow-hidden group">
                                            <div className="absolute inset-0 shimmer opacity-20 pointer-events-none"></div>
                                            <div className="w-24 h-24 bg-indigo-50 rounded-[2rem] flex items-center justify-center mx-auto mb-8 text-indigo-600 border border-indigo-100 shadow-inner group-hover:scale-110 transition-transform duration-500">
                                                <BookOpen className="w-12 h-12 animate-float" />
                                            </div>
                                            <h3 className="text-3xl font-black text-slate-900 mb-3">Initiate Session</h3>
                                            <p className="text-slate-500 max-w-sm mx-auto font-medium leading-relaxed">Select a destination cabin from the logistics matrix below to begin your collaboration sequence.</p>
                                        </div>
                                    )}
                                </section>

                                {/* Cabins Grid */}
                                <section id="cabin-map-section" className="animate-enter" style={{ animationDelay: '0.1s' }}>
                                    <div className="flex flex-col sm:flex-row justify-between items-end mb-8 gap-4 border-b border-slate-200 pb-6">
                                        <div>
                                            <h2 className="text-3xl font-black text-slate-800 flex items-center gap-3"><LayoutDashboard className="w-8 h-8 text-indigo-600" /> Logistics Grid</h2>
                                            <p className="text-slate-400/80 mt-1.5 text-xs font-bold uppercase tracking-widest">Real-time status synchronization</p>
                                        </div>
                                        <div className="relative group">
                                            <Filter className="w-4 h-4 text-indigo-600 absolute left-4 top-3.5 group-hover:text-indigo-800 transition-colors" />
                                            <select value={capacityFilter} onChange={e => setCapacityFilter(e.target.value)} className="pl-12 pr-10 py-3 bg-white border border-slate-200 rounded-2xl text-xs font-black text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 hover:border-indigo-300 transition-all cursor-pointer shadow-sm appearance-none">
                                                <option value="">Filter: All Nodes</option>
                                                <option value="4">Entity: 4 Person</option>
                                                <option value="5">Entity: 5 Person</option>
                                                <option value="6">Entity: 6 Person</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-5">
                                        {filteredCabins.map(cabin => {
                                            const status = getCabinStatus(cabin.id, allBookings);
                                            const isFree = status.status === 'Available';
                                            const isSelected = selectedCabinId === cabin.id;
                                            const isPending = status.status === 'Pending Approval';

                                            return (
                                                <div key={cabin.id} onClick={isFree && !userBooking ? () => selectCabin(cabin.id, cabin.capacity) : undefined}
                                                    className={`cabin-card relative p-6 bg-white rounded-2xl border transition-all duration-300 group
                                                ${isSelected ? 'border-indigo-500 ring-4 ring-indigo-500/10 z-10' :
                                                            isFree ? 'border-slate-200 hover:border-indigo-300 cursor-pointer' :
                                                                'border-slate-100 bg-slate-50/50 cursor-not-allowed disabled'}
                                            `}>

                                                    <div className="flex justify-between items-start mb-6">
                                                        <div className="relative">
                                                            <h3 className={`text-xl font-black transition-colors ${isSelected ? 'text-indigo-600' : 'text-slate-800 group-hover:text-indigo-600'}`}>{cabin.name}</h3>
                                                            <div className="text-[10px] text-slate-500 mt-1.5 flex items-center font-bold uppercase tracking-tighter"><Users className="w-3 h-3 mr-1.5 text-indigo-600/70" /> {cabin.capacity} Capacity</div>
                                                        </div>
                                                        {isFree ? (
                                                            <div className="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shadow-sm border border-emerald-100"><CheckCircle className="w-4 h-4" /></div>
                                                        ) : isPending ? (
                                                            <div className="w-8 h-8 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 shadow-sm border border-amber-100"><Clock className="w-4 h-4" /></div>
                                                        ) : (
                                                            <div className="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-500 border border-red-100"><XCircle className="w-4 h-4" /></div>
                                                        )}
                                                    </div>

                                                    <div className="flex gap-2 mb-4">
                                                        {cabin.amenities.map(a => (
                                                            <div key={a} title={a} className="p-1.5 bg-slate-50 text-slate-400 rounded-lg border border-slate-100">
                                                                <AmenityIcon type={a} className="w-3.5 h-3.5" />
                                                            </div>
                                                        ))}
                                                    </div>

                                                    <div className="mt-4 pt-4 border-t border-slate-50 flex justify-between items-center">
                                                        <div className="flex flex-col">
                                                            <span className={`text-[10px] font-bold uppercase tracking-wider ${isFree ? 'text-emerald-600' : isPending ? 'text-amber-600' : 'text-red-400'}`}>
                                                                {isFree ? 'Available' : isPending ? 'Pending' : 'Occupied'}
                                                            </span>
                                                            {isFree && status.nextTime && (
                                                                <span className="text-[9px] text-slate-400 font-bold uppercase tracking-tighter mt-1">Next: {new Date(status.nextTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                                            )}
                                                        </div>
                                                        {isSelected && <div className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">SELECTED</div>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>

                                {/* Booking Form */}
                                {selectedCabinId && !userBooking && (
                                    <section id="booking-form-anchor" className="animate-enter">
                                        <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-2xl mx-auto border border-slate-100 relative overflow-hidden">
                                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

                                            <h2 className="text-4xl font-black text-slate-900 mb-2">Finalize Protocol</h2>
                                            <p className="text-indigo-600/80 mb-10 text-sm font-bold uppercase tracking-widest">Targeting Node: <span className="text-slate-900">{selectedCabinId}</span></p>

                                            <div className="bg-slate-50 p-2 rounded-2xl mb-10 flex relative border border-slate-100">
                                                <button onClick={() => setBookingRole('student')} className={`flex-1 py-4 rounded-xl text-xs font-black transition-all relative z-10 flex items-center justify-center gap-2 uppercase tracking-widest ${bookingRole === 'student' ? 'bg-indigo-600 text-white shadow-xl' : 'text-slate-500 hover:text-slate-800'}`}>
                                                    <GraduationCap className="w-4 h-4" /> Student Class
                                                </button>
                                                <button onClick={() => setBookingRole('faculty')} className={`flex-1 py-4 rounded-xl text-xs font-black transition-all relative z-10 flex items-center justify-center gap-2 uppercase tracking-widest ${bookingRole === 'faculty' ? 'bg-orange-600 text-white shadow-xl' : 'text-slate-500 hover:text-slate-800'}`}>
                                                    <Briefcase className="w-4 h-4" /> Faculty Expert
                                                </button>
                                            </div>

                                            {/* Booking Type Selection (Admin Restricted) */}
                                            {isAdminLoggedIn && (
                                                <div className="space-y-4 mb-10">
                                                    <div className="flex items-center justify-between px-2 mb-2">
                                                        <span className="text-[11px] font-black text-indigo-600 uppercase tracking-[0.2em]">Protocol Type</span>
                                                    </div>
                                                    <div className="grid grid-cols-1 gap-4">
                                                        <label className={`flex items-center p-4 border rounded-2xl cursor-pointer transition-all ${!isSpecialRequest ? 'border-indigo-500 bg-indigo-50/50 ring-2 ring-indigo-500/20' : 'border-slate-100 hover:border-slate-200 bg-white'}`}>
                                                            <input type="radio" checked={!isSpecialRequest} onChange={() => { setIsSpecialRequest(false); setGroupMembers(new Array(selectedCapacity).fill('')); }} className="hidden" />
                                                            <div className="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center mr-4 text-indigo-600 border border-indigo-100"><Users className="w-5 h-5" /></div>
                                                            <div className="flex-1">
                                                                <span className="font-bold text-slate-900 block text-[15px]">Standard Activation</span>
                                                                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-tight">Full cabin capacity ({selectedCapacity} users)</span>
                                                            </div>
                                                            {!isSpecialRequest && <div className="w-5 h-5 rounded-full bg-indigo-600 flex items-center justify-center"><CheckCircle className="w-3 h-3 text-white" /></div>}
                                                        </label>

                                                        <label className={`flex items-center p-4 border rounded-2xl cursor-pointer transition-all ${isSpecialRequest ? 'border-indigo-600 bg-indigo-50/50 ring-2 ring-indigo-600/20' : 'border-slate-100 hover:border-slate-200 bg-white'}`}>
                                                            <input type="radio" checked={isSpecialRequest} onChange={() => { setIsSpecialRequest(true); setGroupMembers(['']); }} className="hidden" />
                                                            <div className="w-10 h-10 rounded-xl bg-white flex items-center justify-center mr-4 text-indigo-600 border border-indigo-100"><Star className="w-5 h-5" /></div>
                                                            <div className="flex-1">
                                                                <span className="font-bold text-slate-900 block text-[15px]">Special Protocol</span>
                                                                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-tight">1-2 users (Interviews & Meetings)</span>
                                                            </div>
                                                            {isSpecialRequest && <div className="w-5 h-5 rounded-full bg-indigo-600 flex items-center justify-center"><CheckCircle className="w-3 h-3 text-white" /></div>}
                                                        </label>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Advanced Scheduling Toggle */}
                                            <div className="mb-10">
                                                <div className="flex items-center justify-between px-2 mb-4">
                                                    <span className="text-[11px] font-black text-indigo-600 uppercase tracking-[0.2em]">Activation Protocol</span>
                                                    <span className="text-[11px] font-black text-slate-400 uppercase">Set Execution Time</span>
                                                </div>
                                                <div className="bg-slate-50 p-2 rounded-2xl flex border border-slate-100 mb-4">
                                                    <button onClick={() => setBookingSchedule('Immediate')} className={`flex-1 py-3 rounded-xl text-[11px] font-black transition-all flex items-center justify-center gap-2 uppercase tracking-widest ${bookingSchedule === 'Immediate' ? 'bg-white text-indigo-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'}`}>
                                                        <Zap className="w-3 h-3" /> Immediate
                                                    </button>
                                                    <button onClick={() => setBookingSchedule('Scheduled')} className={`flex-1 py-3 rounded-xl text-[11px] font-black transition-all flex items-center justify-center gap-2 uppercase tracking-widest ${bookingSchedule === 'Scheduled' ? 'bg-white text-indigo-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'}`}>
                                                        <Calendar className="w-3 h-3" /> Scheduled
                                                    </button>
                                                </div>

                                                {bookingSchedule === 'Scheduled' && (
                                                    <div className="input-group relative animate-enter">
                                                        <Clock className="w-5 h-5 absolute left-5 top-4.5 text-indigo-600 z-10" />
                                                        <select value={scheduledTime} onChange={e => setScheduledTime(e.target.value)} className="w-full pl-14 p-4.5 bg-white border border-indigo-200 rounded-[1.25rem] outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all text-[15px] font-bold text-slate-800 appearance-none cursor-pointer">
                                                            <option value="">Select Initiation Time...</option>
                                                            {getTimeSlots().map(slot => (
                                                                <option key={slot.value} value={slot.value}>{slot.label}</option>
                                                            ))}
                                                        </select>
                                                        <div className="absolute right-5 top-5 pointer-events-none">
                                                            <ChevronRight className="w-4 h-4 text-slate-400 rotate-90" />
                                                        </div>
                                                    </div>
                                                )}

                                                {bookingSchedule === 'Immediate' && (
                                                    <div className="p-6 bg-indigo-50/50 border border-indigo-100 rounded-3xl flex items-center shadow-sm">
                                                        <div className="w-12 h-12 rounded-2xl bg-white text-indigo-600 flex items-center justify-center mr-4 shadow-sm border border-indigo-50">
                                                            <Zap className="w-6 h-6" />
                                                        </div>
                                                        <div>
                                                            <span className="font-black text-slate-900 block text-[13px] uppercase tracking-widest">Hot Start Enabled</span>
                                                            <span className="text-[11px] text-indigo-600 font-bold uppercase">Activation will trigger upon approval.</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {isSpecialRequest && isAdminLoggedIn && (
                                                <div className="mb-10 p-8 bg-slate-50 rounded-[2rem] border border-slate-100 animate-enter">
                                                    <div className="grid grid-cols-2 gap-6 mb-6">
                                                        <div className="input-group">
                                                            <label className="block text-[11px] font-black text-indigo-600 uppercase mb-2 ml-1 tracking-[0.1em]">Protocol Reason</label>
                                                            <div className="relative">
                                                                <Briefcase className="w-4 h-4 absolute left-4 top-4 text-indigo-400" />
                                                                <select value={specialReason} onChange={e => setSpecialReason(e.target.value)} className="w-full pl-12 p-3.5 bg-white border border-slate-200 rounded-xl text-[15px] font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all appearance-none cursor-pointer">
                                                                    <option>Interview</option><option>Meeting</option><option>Other</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div className="input-group">
                                                            <label className="block text-[11px] font-black text-indigo-600 uppercase mb-2 ml-1 tracking-[0.1em]">Entity Count</label>
                                                            <div className="relative">
                                                                <Users className="w-4 h-4 absolute left-4 top-4 text-indigo-400" />
                                                                <select value={specialSize} onChange={e => { setSpecialSize(parseInt(e.target.value)); setGroupMembers(new Array(parseInt(e.target.value)).fill('')); }} className="w-full pl-12 p-3.5 bg-white border border-slate-200 rounded-xl text-[15px] font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all appearance-none cursor-pointer">
                                                                    <option value="1">1 Person</option><option value="2">2 People</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="input-group">
                                                        <label className="block text-[11px] font-black text-indigo-600 uppercase mb-2 ml-1 tracking-[0.1em]">Protocol Briefing (Optional)</label>
                                                        <textarea value={specialComment} onChange={e => setSpecialComment(e.target.value)} placeholder="ENTER PROTOCOL DETAILS..." className="w-full p-4 bg-white border border-slate-200 rounded-xl text-[15px] font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500/50 h-24 resize-none transition-all"></textarea>
                                                    </div>
                                                </div>
                                            )}

                                            <div className="space-y-5 mb-10">
                                                <div className="flex items-center justify-between px-2">
                                                    <span className="text-[11px] font-black text-indigo-600 uppercase tracking-[0.2em]">Group Directory</span>
                                                    <span className="text-[11px] font-black text-slate-400 uppercase">{groupMembers.length} Active Slots</span>
                                                </div>
                                                {groupMembers.map((name, i) => (
                                                    <div key={i} className="input-group relative group">
                                                        <User className={`w-5 h-5 absolute left-5 top-4.5 transition-colors z-10 ${i === 0 ? 'text-indigo-600' : 'text-slate-400'}`} />
                                                        <input
                                                            value={name}
                                                            onChange={e => { const n = [...groupMembers]; n[i] = e.target.value; setGroupMembers(n); }}
                                                            placeholder={i === 0 ? "LEAD OPERATOR IDENTITY" : `COLLABORATOR ${i + 1} IDENTITY`}
                                                            className={`w-full pl-14 p-5 bg-white border rounded-[1.25rem] outline-none focus:bg-slate-50 focus:ring-2 transition-all text-[15px] font-bold text-slate-800 ${i === 0 ? 'border-indigo-200 focus:ring-indigo-500/50' : 'border-slate-100 hover:border-slate-200 focus:ring-slate-300'}`}
                                                        />
                                                    </div>
                                                ))}
                                            </div>

                                            <button onClick={submitBooking} className="w-full py-5 rounded-[1.25rem] font-black text-white shadow-2xl transition-all transform active:scale-95 flex items-center justify-center gap-3 text-sm btn-primary uppercase tracking-widest">
                                                Authorize Sequence <ChevronRight className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </section>
                                )}

                                {/* Admin Queue */}
                                <section className="bg-white rounded-[2.5rem] p-10 border border-slate-100 shadow-2xl animate-enter">
                                    <div className="flex justify-between items-center mb-10 pb-8 border-b border-slate-50">
                                        <h3 className="text-2xl font-black text-slate-900 flex items-center">
                                            <div className="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mr-4 text-indigo-600 border border-indigo-100">
                                                <ShieldCheck className="w-6 h-6" />
                                            </div>
                                            {isAdminLoggedIn ? 'Command Center' : 'System Terminal'}
                                        </h3>
                                        {isAdminLoggedIn && (
                                            <div className="flex items-center gap-4">
                                                <div className="flex bg-slate-100 p-1 rounded-2xl mr-4">
                                                    <button onClick={() => setAdminHistoryMode(false)} className={`px-4 py-2 rounded-xl text-[10px] font-black tracking-widest uppercase transition-all ${!adminHistoryMode ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Active</button>
                                                    <button onClick={() => setAdminHistoryMode(true)} className={`px-4 py-2 rounded-xl text-[10px] font-black tracking-widest uppercase transition-all ${adminHistoryMode ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Archives</button>
                                                </div>
                                                <div className="flex bg-slate-50 p-1.5 rounded-2xl border border-slate-100">
                                                    <button onClick={() => setAdminViewRole('student')} className={`px-6 py-2.5 text-[10px] font-black rounded-xl transition-all uppercase tracking-widest ${adminViewRole === 'student' ? 'bg-indigo-600 text-white shadow-xl' : 'text-slate-500 hover:text-slate-800'}`}>Students</button>
                                                    <button onClick={() => setAdminViewRole('faculty')} className={`px-6 py-2.5 text-[10px] font-black rounded-xl transition-all uppercase tracking-widest ${adminViewRole === 'faculty' ? 'bg-orange-600 text-white shadow-xl' : 'text-slate-500 hover:text-slate-800'}`}>Faculty</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {isAdminLoggedIn ? (
                                        <div>
                                            <div className="mb-8 flex justify-end">
                                                <button onClick={scrollToMap} className="flex items-center gap-2 px-5 py-3 bg-indigo-500/10 text-indigo-400 rounded-2xl text-xs font-black hover:bg-indigo-500/20 border border-indigo-500/20 transition-all shadow-xl uppercase tracking-widest">
                                                    <PlusCircle className="w-4 h-4" /> New Special Protocol
                                                </button>
                                            </div>

                                            <div className="space-y-4">
                                                {(adminViewRole === 'student' ? studentBookings : facultyBookings).filter(b => adminHistoryMode ? (b.status === 'Completed' || b.status === 'Rejected') : (b.status === 'Pending' || b.status === 'Approved')).map(b => (
                                                    <div key={b.id} className="group flex flex-col md:flex-row justify-between items-center p-6 bg-white border border-slate-100 hover:border-indigo-200 rounded-3xl shadow-sm hover:shadow-xl transition-all duration-300">
                                                        <div className="mb-4 md:mb-0 w-full md:w-auto">
                                                            <div className="flex items-center gap-4 mb-3">
                                                                <span className={`w-3 h-3 rounded-full ${b.status === 'Pending' ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500'}`}></span>
                                                                <span className="font-black text-xl text-slate-900 tracking-tight">{b.cabinId}</span>
                                                                {b.bookingType === 'Special' && <span className="bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-widest flex items-center border border-indigo-100"><Star className="w-3 h-3 mr-1.5" />Special</span>}
                                                            </div>
                                                            <div className="text-sm text-slate-500 flex flex-wrap items-center gap-x-4 gap-y-2 font-bold">
                                                                <span className="flex items-center"><User className="w-4 h-4 mr-2 text-indigo-600/60" /> {b.requesterName}</span>
                                                                <span className="w-1.5 h-1.5 bg-slate-200 rounded-full"></span>
                                                                <span className="flex items-center"><Users className="w-4 h-4 mr-2 text-indigo-600/60" /> {b.groupMembers.length} Entities</span>
                                                                <span className="w-1.5 h-1.5 bg-slate-200 rounded-full"></span>
                                                                <span className="flex items-center text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100">
                                                                    <Clock className="w-4 h-4 mr-2" />
                                                                    {new Date(b.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                                    {new Date(b.timestamp).getDate() !== new Date().getDate() && ` (${new Date(b.timestamp).toLocaleDateString([], { month: 'short', day: 'numeric' })})`}
                                                                </span>
                                                            </div>
                                                            {b.specialComment && <div className="mt-4 text-xs bg-slate-50 p-3 rounded-xl text-slate-600 border border-slate-100 italic max-w-md font-medium">"{b.specialComment}"</div>}
                                                        </div>
                                                        <div className="flex gap-4 w-full md:w-auto">
                                                            {b.status === 'Pending' ? (
                                                                <React.Fragment>
                                                                    <button onClick={() => updateBookingStatus(b, 'Approved')} className="flex-1 md:flex-none px-6 py-3 bg-emerald-500/10 text-emerald-600 border border-emerald-500/20 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-emerald-500 hover:text-white transition-all shadow-sm active:scale-95">Accept</button>
                                                                    <button onClick={() => updateBookingStatus(b, 'Rejected')} className="flex-1 md:flex-none px-6 py-3 bg-red-500/10 text-red-600 border border-red-500/20 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all shadow-sm active:scale-95">Decline</button>
                                                                </React.Fragment>
                                                            ) : !adminHistoryMode && (
                                                                <button onClick={() => updateBookingStatus(b, 'Completed')} className="w-full md:w-auto px-8 py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-800 transition-all shadow-xl active:scale-95 flex items-center gap-2">
                                                                    <Archive className="w-3.5 h-3.5" /> Archive Session
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                                {(adminViewRole === 'student' ? studentBookings : facultyBookings).filter(b => b.status === 'Pending' || b.status === 'Approved').length === 0 && (
                                                    <div className="text-center py-20">
                                                        <div className="w-20 h-20 bg-slate-50 rounded-[2rem] flex items-center justify-center mx-auto mb-6 text-slate-200 border border-slate-100">
                                                            <div className="relative">
                                                                <History className="w-10 h-10" />
                                                                <CheckCircle className="w-5 h-5 absolute -right-1 -bottom-1 text-emerald-400 bg-white rounded-full" />
                                                            </div>
                                                        </div>
                                                        <h4 className="text-sm font-black text-slate-900 uppercase tracking-tight mb-2">Protocol All Clear</h4>
                                                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">{adminHistoryMode ? "No historical logs found" : "No active collaboration sessions"}</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-20 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200">
                                            <div className="w-20 h-20 bg-white rounded-3xl shadow-sm flex items-center justify-center mx-auto mb-6 text-indigo-600/40 border border-slate-100">
                                                <ShieldCheck className="w-10 h-10" />
                                            </div>
                                            <h4 className="text-xl font-black text-slate-900 mb-2 uppercase tracking-tight">Access Restricted</h4>
                                            <p className="text-sm text-slate-500 mb-8 font-medium">Elevated permissions are required to access this terminal.</p>
                                            <button onClick={handleLogin} className="px-10 py-4 bg-slate-900 text-white font-black rounded-2xl hover:bg-slate-800 transition-all shadow-xl text-xs uppercase tracking-widest active:scale-95">
                                                Initialize Login
                                            </button>
                                        </div>
                                    )}
                                </section>
                            </>
                        )}
                    </main>

                    <footer className="mt-20 py-12 text-center text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] border-t border-slate-100 bg-white/50 backdrop-blur-md">
                        <p>Â© {new Date().getFullYear()} CabinControl Neural Net â€¢ Engine: Vivek Yadav</p>
                    </footer>
                </div >
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>