<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Collaborative Booking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX execution -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes shadow-pulse {
            0% { text-shadow: 0 0 5px rgba(253, 186, 116, 0.4); }
            50% { text-shadow: 0 0 15px rgba(253, 186, 116, 0.8), 0 0 25px rgba(253, 186, 116, 0.6); }
            100% { text-shadow: 0 0 5px rgba(253, 186, 116, 0.4); }
        }
        
        .header-glow {
            animation: shadow-pulse 3s infinite ease-in-out;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, User, LogOut, Download, AlertTriangle, CheckCircle, XCircle, Users, BookOpen, Zap, Filter, Info, Star, Briefcase } from 'https://esm.sh/lucide-react@0.263.1';
        
        // Firebase Imports (Stable Version)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp, setLogLevel } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Global Constants and Firebase Initialization ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // UPDATED: User's Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
          authDomain: "library-booking-83e2a.firebaseapp.com",
          projectId: "library-booking-83e2a",
          storageBucket: "library-booking-83e2a.firebasestorage.app",
          messagingSenderId: "712017475970",
          appId: "1:712017475970:web:760a61d2bcbde376eff79b",
          measurementId: "G-XEHSTZ2SYD"
        };
        
        // Removed __initial_auth_token usage because it conflicts with custom project config
        
        // Demo Mode Detection
        const isDemoMode = false;

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = `artifacts/${appId}/public/data/cabinBookings`;

        const cabinCapacities = [4, 5, 6];
        const initialCabins = Array.from({ length: CABIN_COUNT }, (_, i) => ({
            id: `C${i + 1}`,
            name: `Cabin ${i + 1}`,
            capacity: cabinCapacities[i % 3],
        }));

        // --- Helper Functions ---

        const useAlert = () => {
            const [alert, setAlert] = useState({ message: '', classes: '', visible: false });

            const alertUser = useCallback((message, classes) => {
                setAlert({ message, classes, visible: true });
                const timer = setTimeout(() => setAlert(prev => ({ ...prev, visible: false })), 6000);
                return () => clearTimeout(timer);
            }, []);

            const AlertComponent = () => (
                <div
                    className={`fixed top-6 right-6 p-5 rounded-xl text-left font-semibold shadow-2xl transition-all duration-700 ease-out z-50 
                        ${alert.classes} ${alert.visible ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-full pointer-events-none'}
                        flex items-center space-x-3 backdrop-blur-md border border-white/20
                    `}
                    role="alert"
                >
                    {alert.message}
                </div>
            );

            return [alertUser, AlertComponent];
        };

        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime && 
                b.timestamp && 
                typeof b.timestamp.getTime === 'function' && 
                (b.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000) > now.getTime()
            );

            if (activeBooking) {
                return { 
                    status: 'Occupied', 
                    name: activeBooking.requesterName, 
                    endTime: activeBooking.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000 
                };
            }

            const pendingBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Pending'
            );

            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName };
            }

            return { status: 'Available', name: null };
        };

        // --- Components ---

        const ConfirmationModal = ({ modal, setModal }) => {
            if (!modal) return null;

            const closeModal = () => setModal(null);
            const handleConfirm = () => {
                if (modal.action) modal.action();
                closeModal();
            };

            return (
                <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex justify-center items-center z-50 transition-all duration-300">
                    <div className="bg-white text-gray-900 p-8 rounded-3xl shadow-2xl w-full max-w-md mx-4 border border-gray-100 animate-in fade-in zoom-in-95 duration-200">
                        <h3 className="text-2xl font-bold text-gray-800 mb-3">{modal.title}</h3>
                        <p className="text-gray-600 mb-8 leading-relaxed">{modal.message}</p>
                        <div className="flex justify-end space-x-3">
                            <button 
                                onClick={closeModal} 
                                className="py-2.5 px-5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={handleConfirm} 
                                className="py-2.5 px-5 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg shadow-red-600/20 transition-all transform active:scale-95"
                            >
                                {modal.confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);

            const [allBookings, setAllBookings] = useState([]);
            const [userBooking, setUserBooking] = useState(null);
            
            const [selectedCabinId, setSelectedCabinId] = useState('');
            const [selectedCapacity, setSelectedCapacity] = useState(0);
            const [groupMembers, setGroupMembers] = useState([]);
            
            // New States for Special Request
            const [isSpecialRequest, setIsSpecialRequest] = useState(false);
            const [specialReason, setSpecialReason] = useState('Interview');
            const [specialSize, setSpecialSize] = useState(1);
            
            const [capacityFilter, setCapacityFilter] = useState(''); 

            const [modal, setModal] = useState(null);
            const [alertUser, AlertComponent] = useAlert();

            // Init Effect
            useEffect(() => {
                if (isDemoMode) {
                    console.warn("Running in Demo Mode: No Firebase Config found.");
                    setUserId("demo-user-123");
                    setIsAuthReady(true);
                    
                    setAllBookings([
                        {
                            id: 'mock-1',
                            cabinId: 'C1',
                            status: 'Approved',
                            requesterId: 'other-user',
                            requesterName: 'Alice Johnson',
                            groupMembers: ['Alice Johnson', 'Bob Smith'],
                            timestamp: new Date(Date.now() - 30 * 60 * 1000), 
                            durationHours: 2,
                            capacity: 4
                        },
                        {
                            id: 'mock-2',
                            cabinId: 'C5',
                            status: 'Pending',
                            requesterId: 'other-user-2',
                            requesterName: 'Charlie Brown',
                            groupMembers: ['Charlie Brown', 'Lucy'],
                            timestamp: new Date(),
                            durationHours: 2,
                            capacity: 5
                        }
                    ]);
                    
                    alertUser(<><Info className="w-5 h-5"/> <span>Demo Mode Active (Local Data)</span></>, 'bg-blue-600 text-white');
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auther = getAuth(app);
                    
                    setDb(firestore);
                    setAuth(auther);

                    const initAuth = async () => {
                        // Use only anonymous auth when custom config is provided
                        await signInAnonymously(auther);
                    };

                    initAuth().catch(error => {
                        console.error("Auth failed:", error);
                        alertUser(<><XCircle className="w-5 h-5"/> <span>Auth failed. Refresh page.</span></>, 'bg-red-600 text-white');
                    });

                    const unsubscribe = onAuthStateChanged(auther, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                        }
                    });

                    return () => unsubscribe();
                } catch (err) {
                    console.error("Firebase init failed:", err);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>App Initialization Failed</span></>, 'bg-red-600 text-white');
                }
            }, [alertUser]);

            // Realtime Listener / Demo Data
            useEffect(() => {
                if (isDemoMode) {
                    const currentBooking = allBookings.find(b => 
                        b.requesterId === userId && 
                        b.status !== 'Completed' && 
                        b.status !== 'Rejected' && 
                        !b.completionTime
                    );
                    setUserBooking(currentBooking);
                    return;
                }

                if (!db || !isAuthReady || !userId) return;

                const q = query(collection(db, BOOKINGS_COLLECTION));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const bookings = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const booking = { id: doc.id, ...data };
                        
                        if (booking.timestamp && typeof booking.timestamp.toDate === 'function') {
                            booking.timestamp = booking.timestamp.toDate();
                        }
                        if (booking.completionTime && typeof booking.completionTime.toDate === 'function') {
                            booking.completionTime = booking.completionTime.toDate();
                        }
                        bookings.push(booking);
                    });
                    
                    setAllBookings(bookings);
                    
                    const currentBooking = bookings.find(b => 
                        b.requesterId === userId && 
                        b.status !== 'Completed' && 
                        b.status !== 'Rejected' && 
                        !b.completionTime
                    );
                    setUserBooking(currentBooking);

                }, (error) => {
                    console.error("Error fetching bookings:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Connection error. Retrying...</span></>, 'bg-red-600 text-white');
                });

                return () => unsubscribe();
            }, [db, isAuthReady, userId, alertUser, isDemoMode, allBookings]);

            // Logic
            const selectCabin = useCallback((cabinId, capacity) => {
                setSelectedCabinId(cabinId);
                setSelectedCapacity(capacity);
                // Reset to standard mode when selecting new cabin
                setIsSpecialRequest(false);
                setSpecialSize(1);
                setGroupMembers(new Array(capacity).fill(''));
                
                setTimeout(() => {
                    document.getElementById('student-request-form')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100); 
            }, []);

            const toggleSpecialRequest = () => {
                const newMode = !isSpecialRequest;
                setIsSpecialRequest(newMode);
                if (newMode) {
                    setSpecialSize(1);
                    setGroupMembers(['']); // Default 1 slot for special request
                } else {
                    setGroupMembers(new Array(selectedCapacity).fill('')); // Reset to full capacity
                }
            };

            const handleSpecialSizeChange = (e) => {
                const size = parseInt(e.target.value);
                setSpecialSize(size);
                // Preserve existing name if shrinking, or add empty if growing
                setGroupMembers(prev => {
                    const newArr = new Array(size).fill('');
                    for(let i=0; i<Math.min(prev.length, size); i++) newArr[i] = prev[i];
                    return newArr;
                });
            };

            const submitBooking = useCallback(async () => {
                if (!isAuthReady || userBooking) {
                    alertUser(<><AlertTriangle className="w-5 h-5"/> <span>Active request exists. Wait for completion.</span></>, 'bg-amber-500 text-gray-900');
                    return;
                }

                if (!selectedCabinId || selectedCapacity === 0) {
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Please select a cabin.</span></>, 'bg-red-600 text-white');
                    return;
                }
                
                const filledMembers = (groupMembers || []).map(name => (name || '').trim());
                
                if (filledMembers.length === 0 || filledMembers.some(name => !name)) {
                     alertUser(<><XCircle className="w-5 h-5"/> <span>All member names are required.</span></>, 'bg-red-600 text-white');
                     return;
                }

                if (getCabinStatus(selectedCabinId, allBookings).status !== 'Available') {
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Cabin taken! Please select another.</span></>, 'bg-red-600 text-white');
                    return;
                }
                
                const newBookingData = {
                    cabinId: selectedCabinId,
                    // Use special size if in special mode, otherwise full capacity
                    capacity: isSpecialRequest ? specialSize : selectedCapacity,
                    requesterName: filledMembers[0],
                    requesterId: userId,
                    groupMembers: filledMembers,
                    timestamp: isDemoMode ? new Date() : Timestamp.now(),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    exportTimestamp: new Date().toISOString(),
                    // Add Special Request Metadata
                    bookingType: isSpecialRequest ? 'Special' : 'Standard',
                    specialReason: isSpecialRequest ? specialReason : null
                };

                if (isDemoMode) {
                    setAllBookings(prev => [...prev, { ...newBookingData, id: `demo-${Date.now()}` }]);
                    setSelectedCabinId('');
                    setSelectedCapacity(0);
                    setGroupMembers([]);
                    setIsSpecialRequest(false);
                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Request submitted (Demo)!</span></>, 'bg-emerald-600 text-white');
                    return;
                }
                
                try {
                    await addDoc(collection(db, BOOKINGS_COLLECTION), newBookingData);
                    
                    setSelectedCabinId('');
                    setSelectedCapacity(0);
                    setGroupMembers([]);
                    setIsSpecialRequest(false);

                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Request submitted for approval!</span></>, 'bg-emerald-600 text-white');
                } catch (error) {
                    console.error("Submission error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Submission failed.</span></>, 'bg-red-600 text-white');
                }
            }, [isAuthReady, userBooking, selectedCabinId, selectedCapacity, groupMembers, allBookings, alertUser, db, userId, isSpecialRequest, specialSize, specialReason]);

            const cancelBooking = useCallback(async () => {
                if (!userBooking) return;
                
                if (isDemoMode) {
                    setAllBookings(prev => prev.filter(b => b.id !== userBooking.id));
                    alertUser(<><LogOut className="w-5 h-5"/> <span>Request cancelled (Demo).</span></>, 'bg-sky-600 text-white');
                    return;
                }

                if (!db) return;
                try {
                    await deleteDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id));
                    alertUser(<><LogOut className="w-5 h-5"/> <span>Request cancelled.</span></>, 'bg-sky-600 text-white');
                } catch (error) {
                    console.error("Cancel error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Error cancelling request.</span></>, 'bg-red-600 text-white');
                }
            }, [userBooking, alertUser, db]);
            
            const completeBookingEarly = useCallback(async () => {
                if (!userBooking || userBooking.status !== 'Approved') return;
                
                if (isDemoMode) {
                    setAllBookings(prev => prev.map(b => b.id === userBooking.id ? { ...b, status: 'Completed', completionTime: new Date() } : b));
                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Checked out (Demo).</span></>, 'bg-emerald-600 text-white');
                    return;
                }

                if (!db) return;
                try {
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id), {
                        status: 'Completed',
                        completionTime: Timestamp.now(),
                    });
                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Checked out. Session complete.</span></>, 'bg-emerald-600 text-white');
                } catch (error) {
                    console.error("Checkout error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Checkout failed.</span></>, 'bg-red-600 text-white');
                }
            }, [userBooking, alertUser, db]);

            const confirmCancelBooking = useCallback(() => {
                setModal({
                    title: "Terminate Request?",
                    message: "This will permanently remove your booking request. You will need to start over.",
                    confirmText: "Yes, Terminate",
                    action: cancelBooking,
                });
            }, [cancelBooking]);
            
            const confirmCheckOut = useCallback(() => {
                setModal({
                    title: "End Session Early?",
                    message: "This will free up the cabin for other groups immediately.",
                    confirmText: "Yes, Check Out",
                    action: completeBookingEarly,
                });
            }, [completeBookingEarly]);
            
            const updateBookingStatus = useCallback(async (bookingId, newStatus) => {
                if (!isAuthReady) return;
                
                const facultyName = 'Faculty Admin';
                
                if (isDemoMode) {
                     setAllBookings(prev => prev.map(b => {
                        if (b.id === bookingId) {
                            const updates = { status: newStatus };
                            if (newStatus === 'Approved') {
                                updates.approvedBy = facultyName;
                                updates.timestamp = new Date();
                            }
                            return { ...b, ...updates };
                        }
                        return b;
                     }));
                     return;
                }

                if (!db) return;

                const updateData = { status: newStatus };
                if (newStatus === 'Approved') {
                    updateData.approvedBy = facultyName;
                    updateData.timestamp = Timestamp.now();
                }

                try {
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, bookingId), updateData);
                } catch (error) {
                    console.error("Update error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Action failed.</span></>, 'bg-red-600 text-white');
                }
            }, [isAuthReady, db, alertUser]);

            const useCountdown = (booking) => {
                const [remainingTime, setRemainingTime] = useState(null);
                const [isCritical, setIsCritical] = useState(false);

                useEffect(() => {
                    if (!booking || booking.status !== 'Approved' || booking.completionTime || !booking.timestamp) {
                        setRemainingTime(null);
                        return;
                    }
                    if (typeof booking.timestamp.getTime !== 'function') return;

                    const updateTimer = () => {
                        const startTime = booking.timestamp.getTime();
                        const endTime = startTime + booking.durationHours * 60 * 60 * 1000;
                        const now = new Date().getTime();
                        const distance = endTime - now;

                        if (distance < 0) {
                            setRemainingTime('EXPIRED');
                            setIsCritical(false);
                        } else {
                            const minutesLeft = Math.floor(distance / (1000 * 60));
                            setIsCritical(minutesLeft <= 5);

                            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                            setRemainingTime(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                        }
                    };

                    updateTimer(); 
                    const interval = setInterval(updateTimer, 1000);
                    return () => clearInterval(interval);
                }, [booking]);

                return { remainingTime, isCritical };
            };

            const filteredCabins = useMemo(() => {
                let list = initialCabins;
                if (capacityFilter) {
                    list = list.filter(c => c.capacity === parseInt(capacityFilter));
                }
                return list;
            }, [capacityFilter]);

            const CabinGrid = useMemo(() => {
                return filteredCabins.map(cabin => {
                    const statusInfo = getCabinStatus(cabin.id, allBookings);
                    const isAvailable = statusInfo.status === 'Available';
                    const isOccupied = statusInfo.status === 'Occupied';
                    const isSelected = selectedCabinId === cabin.id;
                    
                    let statusText, statusRing, statusIcon, borderColor;
                    
                    if (isAvailable) {
                        statusText = 'Available';
                        statusRing = 'ring-emerald-400';
                        statusIcon = <CheckCircle className="w-5 h-5 text-emerald-600 mr-2"/>;
                        borderColor = isSelected ? 'border-amber-500' : 'border-emerald-400/30';
                    } else if (statusInfo.status === 'Pending Approval') {
                        statusText = 'Pending';
                        statusRing = 'ring-amber-400';
                        statusIcon = <Clock className="w-5 h-5 text-amber-600 mr-2"/>;
                        borderColor = 'border-amber-200';
                    } else {
                        statusText = 'Occupied';
                        statusRing = 'ring-red-400';
                        statusIcon = <XCircle className="w-5 h-5 text-red-600 mr-2"/>;
                        borderColor = 'border-red-200';
                    }

                    const isDisabled = !isAvailable || !!userBooking;
                    
                    return (
                        <div 
                            key={cabin.id}
                            className={`
                                relative p-5 bg-white rounded-2xl shadow-sm transition-all duration-300 
                                border-2 ${borderColor}
                                ${isSelected ? `ring-2 ${statusRing} shadow-lg scale-[1.02]` : ''}
                                ${isDisabled ? 'opacity-60 grayscale-[0.3]' : 'hover:shadow-md hover:-translate-y-1 cursor-pointer'}
                            `}
                            onClick={!isDisabled ? () => selectCabin(cabin.id, cabin.capacity) : undefined}
                        >
                            <div className="flex justify-between items-start mb-2">
                                <h3 className="text-xl font-bold text-gray-800">{cabin.name}</h3>
                                <div className="bg-indigo-50 text-indigo-600 p-1.5 rounded-lg">
                                    <Users className="w-4 h-4"/>
                                </div>
                            </div>
                            
                            <div className="flex items-center text-sm text-gray-500 mb-4">
                                <span className="font-medium">{cabin.capacity} Seats</span>
                            </div>

                            <div className="flex items-center text-sm font-semibold mb-2">
                                 {statusIcon}
                                 <span className={`${isOccupied ? 'text-red-600' : isAvailable ? 'text-emerald-600' : 'text-amber-600'}`}>
                                    {statusText}
                                 </span>
                            </div>

                            {statusInfo.name && (
                                <div className="text-xs bg-gray-100 p-2 rounded-lg text-gray-600 truncate">
                                    By: {statusInfo.name}
                                </div>
                            )}
                            
                            <button 
                                className={`
                                    mt-4 w-full py-2 rounded-lg font-bold text-sm transition-colors
                                    ${isSelected ? 'bg-amber-500 text-white' : 
                                      isDisabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 
                                      'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'}
                                `}
                                disabled={isDisabled}
                            >
                                {isSelected ? 'Selected' : isAvailable ? 'Select' : 'Unavailable'}
                            </button>
                        </div>
                    );
                });
            }, [selectedCabinId, allBookings, userBooking, selectCabin, filteredCabins]);


            const UserStatusCard = () => {
                const { remainingTime, isCritical } = useCountdown(userBooking);

                if (!userBooking) {
                    return (
                        <div className="p-8 bg-white border-2 border-dashed border-gray-300 rounded-2xl text-center">
                            <BookOpen className="w-10 h-10 mx-auto text-gray-400 mb-3"/>
                            <h3 className="text-lg font-semibold text-gray-700">No Active Sessions</h3>
                            <p className="text-sm text-gray-500">Select a cabin below to start booking.</p>
                        </div>
                    );
                }
                
                const isApproved = userBooking.status === 'Approved';
                const statusColor = isApproved ? 'bg-emerald-500' : 'bg-amber-500';
                const isSpecial = userBooking.bookingType === 'Special';

                return (
                    <div className="bg-white border-l-4 border-indigo-600 rounded-r-2xl shadow-lg overflow-hidden">
                        <div className="p-6 sm:p-8">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white ${statusColor}`}>
                                            {isApproved ? <CheckCircle className="w-3 h-3 mr-1"/> : <Clock className="w-3 h-3 mr-1"/>}
                                            {userBooking.status.toUpperCase()}
                                        </span>
                                        {isSpecial && (
                                            <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">
                                                <Star className="w-3 h-3 mr-1"/> Special Request
                                            </span>
                                        )}
                                    </div>
                                    <h2 className="text-3xl font-bold text-gray-900">
                                        {userBooking.cabinId} 
                                        <span className="text-lg font-normal text-gray-500 ml-2">({userBooking.capacity} Pax)</span>
                                    </h2>
                                    {isSpecial && <div className="text-sm text-gray-500 mt-1">Reason: {userBooking.specialReason}</div>}
                                </div>
                                {isApproved && (
                                    <div className={`text-right ${isCritical ? 'animate-pulse' : ''}`}>
                                        <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Time Remaining</p>
                                        <div className={`text-3xl font-mono font-bold ${isCritical ? 'text-red-600' : 'text-emerald-600'}`}>
                                            {remainingTime || '--:--'}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-gray-50 rounded-xl p-4 mb-6">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {(userBooking.groupMembers || []).map((name, i) => (
                                        <div key={i} className="flex items-center text-sm text-gray-700">
                                            <div className={`w-2 h-2 rounded-full mr-2 ${i===0 ? 'bg-indigo-500' : 'bg-gray-400'}`}></div>
                                            <span className={i===0 ? 'font-semibold' : ''}>{name} {i===0 && '(Host)'}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-3">
                                {isApproved && (
                                    <button 
                                        onClick={confirmCheckOut}
                                        className="flex-1 py-3 px-4 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-bold rounded-xl transition-colors flex items-center justify-center"
                                    >
                                        <LogOut className="w-4 h-4 mr-2"/> Check Out
                                    </button>
                                )}
                                <button 
                                    onClick={confirmCancelBooking}
                                    className={`
                                        py-3 px-4 bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 font-bold rounded-xl transition-colors flex items-center justify-center
                                        ${!isApproved ? 'w-full' : 'flex-1'}
                                    `}
                                >
                                    Cancel Request
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const FacultyView = useMemo(() => {
                const active = allBookings
                    .filter(b => b.status === 'Pending' || b.status === 'Approved')
                    .sort((a, b) => {
                        const timeA = a.timestamp?.getTime ? a.timestamp.getTime() : 0;
                        const timeB = b.timestamp?.getTime ? b.timestamp.getTime() : 0;
                        return timeA - timeB;
                    });

                if (active.length === 0) return <div className="text-center text-gray-400 py-8">No active queue.</div>;

                return active.map(b => (
                    <div key={b.id} className="flex flex-col md:flex-row justify-between items-center p-4 bg-white border border-gray-100 rounded-xl shadow-sm mb-3 hover:shadow-md transition-shadow">
                        <div className="mb-3 md:mb-0 w-full md:w-auto">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`w-2 h-2 rounded-full ${b.status === 'Pending' ? 'bg-amber-500' : 'bg-emerald-500'}`}></span>
                                <span className="font-bold text-gray-800">{b.cabinId}</span>
                                {b.bookingType === 'Special' && (
                                    <span className="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded-full font-bold flex items-center">
                                        <Star className="w-3 h-3 mr-1"/> Special
                                    </span>
                                )}
                                <span className="text-sm text-gray-500">- {b.requesterName}</span>
                            </div>
                            <div className="text-xs text-gray-400 pl-4">
                                {(b.groupMembers || []).length} Members â€¢ {b.bookingType === 'Special' ? `Reason: ${b.specialReason}` : `${b.capacity} Seat Booking`}
                            </div>
                        </div>
                        
                        <div className="flex gap-2 w-full md:w-auto">
                            {b.status === 'Pending' ? (
                                <>
                                    <button onClick={() => updateBookingStatus(b.id, 'Approved')} className="flex-1 md:flex-none py-1.5 px-3 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-semibold hover:bg-emerald-200">Approve</button>
                                    <button onClick={() => updateBookingStatus(b.id, 'Rejected')} className="flex-1 md:flex-none py-1.5 px-3 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200">Reject</button>
                                </>
                            ) : (
                                <button onClick={() => updateBookingStatus(b.id, 'Completed')} className="w-full md:w-auto py-1.5 px-3 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Force Complete</button>
                            )}
                        </div>
                    </div>
                ));
            }, [allBookings, updateBookingStatus]);

            const exportCSV = () => {
                if (!allBookings.length) return;
                const headers = ["ID,Cabin,Status,Type,Reason,Requester,Time"];
                const rows = allBookings.map(b => {
                     const timeStr = b.timestamp?.toISOString ? b.timestamp.toISOString() : '';
                     const reason = b.specialReason || 'Standard';
                     const type = b.bookingType || 'Standard';
                     return `${b.id},${b.cabinId},${b.status},${type},"${reason}","${b.requesterName}",${timeStr}`;
                });
                const csvContent = headers.concat(rows).join('\n');
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv' }));
                link.download = `bookings-${Date.now()}.csv`;
                link.click();
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 pb-20">
                    <AlertComponent />
                    <ConfirmationModal modal={modal} setModal={setModal} />

                    {/* Header */}
                    <header className="bg-indigo-600 text-white pt-12 pb-24 px-4 sm:px-8 shadow-xl">
                        <div className="max-w-7xl mx-auto flex justify-between items-end">
                            <div>
                                <h1 className="text-3xl sm:text-4xl font-extrabold tracking-tight header-glow">CabinControl</h1>
                                <p className="text-indigo-200 mt-2">Campus Study Space Management</p>
                                {isDemoMode && <div className="mt-2 text-xs bg-blue-500/30 border border-blue-400/50 rounded px-2 py-1 inline-block">Local Demo Mode</div>}
                            </div>
                            <div className="hidden sm:block text-right">
                                <div className="text-xs font-mono bg-indigo-700/50 px-3 py-1 rounded-full text-indigo-200">
                                    ID: {userId ? userId.substring(0, 8) + '...' : 'Connecting...'}
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-8 -mt-16 space-y-12">
                        
                        {/* 1. Status Section */}
                        <section>
                            <UserStatusCard />
                        </section>

                        {/* 2. Selection Section */}
                        <section>
                            <div className="flex flex-col sm:flex-row justify-between items-end mb-6 border-b border-gray-200 pb-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800">Available Spaces</h2>
                                    <p className="text-gray-500">Select a cabin to view details</p>
                                </div>
                                <div className="mt-4 sm:mt-0 relative">
                                    <Filter className="w-4 h-4 text-gray-500 absolute left-3 top-3"/>
                                    <select 
                                        value={capacityFilter}
                                        onChange={(e) => setCapacityFilter(e.target.value)}
                                        className="pl-9 pr-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm"
                                    >
                                        <option value="">All Capacities</option>
                                        <option value="4">4 Person</option>
                                        <option value="5">5 Person</option>
                                        <option value="6">6 Person</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                                {CabinGrid}
                            </div>
                        </section>

                        {/* 3. Booking Form (Only visible if cabin selected and no active booking) */}
                        {selectedCabinId && !userBooking && (
                            <section id="student-request-form" className="animate-in slide-in-from-bottom-10 fade-in duration-500">
                                <div className="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 max-w-3xl mx-auto">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                                        <div className="flex items-center gap-4">
                                            <div className={`p-3 rounded-xl transition-colors ${isSpecialRequest ? 'bg-purple-100 text-purple-600' : 'bg-amber-100 text-amber-600'}`}>
                                                {isSpecialRequest ? <Star className="w-6 h-6"/> : <Zap className="w-6 h-6"/>}
                                            </div>
                                            <div>
                                                <h2 className="text-2xl font-bold text-gray-900">{isSpecialRequest ? 'Special Request' : 'Standard Booking'}</h2>
                                                <p className="text-gray-500">
                                                    Booking <span className="font-bold text-gray-900">{selectedCabinId}</span> 
                                                    {isSpecialRequest ? ' for limited occupancy' : ' for full capacity'}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <button 
                                            onClick={toggleSpecialRequest}
                                            className={`px-4 py-2 rounded-lg text-sm font-bold border transition-all
                                                ${isSpecialRequest 
                                                    ? 'bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200' 
                                                    : 'bg-purple-50 text-purple-700 border-purple-200 hover:bg-purple-100'}
                                            `}
                                        >
                                            {isSpecialRequest ? 'Back to Standard Booking' : 'Need Special Booking (1-2 ppl)?'}
                                        </button>
                                    </div>

                                    {/* Special Request Inputs */}
                                    {isSpecialRequest && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100">
                                            <div>
                                                <label className="block text-xs font-bold text-purple-700 uppercase mb-1 ml-1">Reason for Request</label>
                                                <div className="relative">
                                                    <Briefcase className="w-4 h-4 absolute left-3 top-3 text-purple-400"/>
                                                    <select 
                                                        value={specialReason}
                                                        onChange={(e) => setSpecialReason(e.target.value)}
                                                        className="w-full pl-9 p-2.5 bg-white border border-purple-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none"
                                                    >
                                                        <option value="Interview">Interview</option>
                                                        <option value="Meeting">Meeting</option>
                                                        <option value="Medical">Medical/Health</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-purple-700 uppercase mb-1 ml-1">Group Size</label>
                                                <div className="relative">
                                                    <Users className="w-4 h-4 absolute left-3 top-3 text-purple-400"/>
                                                    <select 
                                                        value={specialSize}
                                                        onChange={handleSpecialSizeChange}
                                                        className="w-full pl-9 p-2.5 bg-white border border-purple-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none"
                                                    >
                                                        <option value="1">1 Person</option>
                                                        <option value="2">2 People</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="space-y-4 mb-8">
                                        {groupMembers.map((name, idx) => (
                                            <div key={idx} className="group">
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">
                                                    {idx === 0 ? 'Primary Requester' : `Member ${idx + 1}`}
                                                </label>
                                                <input 
                                                    type="text"
                                                    value={name}
                                                    onChange={(e) => {
                                                        const newM = [...groupMembers];
                                                        newM[idx] = e.target.value;
                                                        setGroupMembers(newM);
                                                    }}
                                                    placeholder="Full Name"
                                                    className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    <button 
                                        onClick={submitBooking}
                                        className={`w-full py-4 font-bold rounded-xl shadow-lg transition-all transform active:scale-[0.99] text-white
                                            ${isSpecialRequest 
                                                ? 'bg-purple-600 hover:bg-purple-700 shadow-purple-200' 
                                                : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200'}
                                        `}
                                    >
                                        {isSpecialRequest ? 'Submit Special Request' : 'Submit Standard Request'}
                                    </button>
                                </div>
                            </section>
                        )}

                        {/* 4. Admin Panel */}
                        <section className="bg-white rounded-2xl p-8 border border-gray-200">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                                    <Users className="w-5 h-5 mr-2 text-indigo-500"/> 
                                    Admin Queue
                                </h3>
                                <button onClick={exportCSV} className="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                                    <Download className="w-4 h-4 mr-1"/> Export Data
                                </button>
                            </div>
                            <div className="space-y-2">
                                {FacultyView}
                            </div>
                        </section>

                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>