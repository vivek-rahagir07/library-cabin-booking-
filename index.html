<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Collaborative Booking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX execution -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .animate-enter {
            animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen flex flex-col">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, User, LogOut, Download, AlertTriangle, CheckCircle, XCircle, Users, BookOpen, Zap, Filter, Info, Star, Briefcase, MessageSquare, ChevronRight, Calendar } from 'https://esm.sh/lucide-react@0.263.1';
        
        // Firebase Imports (Stable Version)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp, setLogLevel } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Global Constants and Firebase Initialization ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // UPDATED: User's Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
          authDomain: "library-booking-83e2a.firebaseapp.com",
          projectId: "library-booking-83e2a",
          storageBucket: "library-booking-83e2a.firebasestorage.app",
          messagingSenderId: "712017475970",
          appId: "1:712017475970:web:760a61d2bcbde376eff79b",
          measurementId: "G-XEHSTZ2SYD"
        };
        
        // Demo Mode Detection
        const isDemoMode = false;

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = `artifacts/${appId}/public/data/cabinBookings`;

        const cabinCapacities = [4, 5, 6];
        const initialCabins = Array.from({ length: CABIN_COUNT }, (_, i) => ({
            id: `C${i + 1}`,
            name: `Cabin ${i + 1}`,
            capacity: cabinCapacities[i % 3],
        }));

        // --- Helper Functions ---

        const useAlert = () => {
            const [alert, setAlert] = useState({ message: '', classes: '', visible: false });

            const alertUser = useCallback((message, classes) => {
                setAlert({ message, classes, visible: true });
                const timer = setTimeout(() => setAlert(prev => ({ ...prev, visible: false })), 6000);
                return () => clearTimeout(timer);
            }, []);

            const AlertComponent = () => (
                <div
                    className={`fixed top-20 right-6 px-6 py-4 rounded-xl text-left font-medium shadow-2xl transition-all duration-500 ease-out z-[60] 
                        ${alert.classes} ${alert.visible ? 'opacity-100 translate-x-0 scale-100' : 'opacity-0 translate-x-10 scale-95 pointer-events-none'}
                        flex items-center space-x-3 backdrop-blur-xl border border-white/10
                    `}
                    role="alert"
                >
                    {alert.message}
                </div>
            );

            return [alertUser, AlertComponent];
        };

        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime && 
                b.timestamp && 
                typeof b.timestamp.getTime === 'function' && 
                (b.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000) > now.getTime()
            );

            if (activeBooking) {
                return { 
                    status: 'Occupied', 
                    name: activeBooking.requesterName, 
                    endTime: activeBooking.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000 
                };
            }

            const pendingBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Pending'
            );

            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName };
            }

            return { status: 'Available', name: null };
        };

        // --- Components ---

        const ConfirmationModal = ({ modal, setModal }) => {
            if (!modal) return null;

            const closeModal = () => setModal(null);
            const handleConfirm = () => {
                if (modal.action) modal.action();
                closeModal();
            };

            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex justify-center items-center z-[70] transition-all duration-300 px-4">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-enter">
                        <h3 className="text-2xl font-bold text-slate-800 mb-3">{modal.title}</h3>
                        <p className="text-slate-600 mb-8 leading-relaxed">{modal.message}</p>
                        <div className="flex justify-end space-x-3">
                            <button 
                                onClick={closeModal} 
                                className="py-2.5 px-6 rounded-xl font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={handleConfirm} 
                                className={`py-2.5 px-6 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 ${modal.confirmClass || 'bg-red-600 hover:bg-red-700 shadow-red-600/20'}`}
                            >
                                {modal.confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);

            const [allBookings, setAllBookings] = useState([]);
            const [userBooking, setUserBooking] = useState(null);
            
            const [selectedCabinId, setSelectedCabinId] = useState('');
            const [selectedCapacity, setSelectedCapacity] = useState(0);
            const [groupMembers, setGroupMembers] = useState([]);
            
            // New States for Special Request
            const [isSpecialRequest, setIsSpecialRequest] = useState(false);
            const [specialReason, setSpecialReason] = useState('Interview');
            const [specialSize, setSpecialSize] = useState(1);
            const [specialComment, setSpecialComment] = useState('');
            
            const [capacityFilter, setCapacityFilter] = useState(''); 

            const [modal, setModal] = useState(null);
            const [alertUser, AlertComponent] = useAlert();

            // Init Effect
            useEffect(() => {
                if (isDemoMode) {
                    console.warn("Running in Demo Mode: No Firebase Config found.");
                    setUserId("demo-user-123");
                    setIsAuthReady(true);
                    
                    setAllBookings([
                        {
                            id: 'mock-1',
                            cabinId: 'C1',
                            status: 'Approved',
                            requesterId: 'other-user',
                            requesterName: 'Alice Johnson',
                            groupMembers: ['Alice Johnson', 'Bob Smith'],
                            timestamp: new Date(Date.now() - 30 * 60 * 1000), 
                            durationHours: 2,
                            capacity: 4
                        },
                        {
                            id: 'mock-2',
                            cabinId: 'C5',
                            status: 'Pending',
                            requesterId: 'other-user-2',
                            requesterName: 'Charlie Brown',
                            groupMembers: ['Charlie Brown', 'Lucy'],
                            timestamp: new Date(),
                            durationHours: 2,
                            capacity: 5
                        }
                    ]);
                    
                    alertUser(<><Info className="w-5 h-5"/> <span>Demo Mode Active (Local Data)</span></>, 'bg-blue-600 text-white');
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auther = getAuth(app);
                    
                    setDb(firestore);
                    setAuth(auther);

                    const initAuth = async () => {
                        // Use only anonymous auth when custom config is provided
                        await signInAnonymously(auther);
                    };

                    initAuth().catch(error => {
                        console.error("Auth failed:", error);
                        alertUser(<><XCircle className="w-5 h-5"/> <span>Auth failed. Refresh page.</span></>, 'bg-red-600 text-white');
                    });

                    const unsubscribe = onAuthStateChanged(auther, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                        }
                    });

                    return () => unsubscribe();
                } catch (err) {
                    console.error("Firebase init failed:", err);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>App Initialization Failed</span></>, 'bg-red-600 text-white');
                }
            }, [alertUser]);

            // Realtime Listener / Demo Data
            useEffect(() => {
                if (isDemoMode) {
                    const currentBooking = allBookings.find(b => 
                        b.requesterId === userId && 
                        b.status !== 'Completed' && 
                        b.status !== 'Rejected' && 
                        !b.completionTime
                    );
                    setUserBooking(currentBooking);
                    return;
                }

                if (!db || !isAuthReady || !userId) return;

                const q = query(collection(db, BOOKINGS_COLLECTION));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const bookings = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const booking = { id: doc.id, ...data };
                        
                        if (booking.timestamp && typeof booking.timestamp.toDate === 'function') {
                            booking.timestamp = booking.timestamp.toDate();
                        }
                        if (booking.completionTime && typeof booking.completionTime.toDate === 'function') {
                            booking.completionTime = booking.completionTime.toDate();
                        }
                        bookings.push(booking);
                    });
                    
                    setAllBookings(bookings);
                    
                    const currentBooking = bookings.find(b => 
                        b.requesterId === userId && 
                        b.status !== 'Completed' && 
                        b.status !== 'Rejected' && 
                        !b.completionTime
                    );
                    setUserBooking(currentBooking);

                }, (error) => {
                    console.error("Error fetching bookings:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Connection error. Retrying...</span></>, 'bg-red-600 text-white');
                });

                return () => unsubscribe();
            }, [db, isAuthReady, userId, alertUser, isDemoMode, allBookings]);

            // Logic
            const selectCabin = useCallback((cabinId, capacity) => {
                setSelectedCabinId(cabinId);
                setSelectedCapacity(capacity);
                // Reset to standard mode when selecting new cabin
                setIsSpecialRequest(false);
                setSpecialSize(1);
                setSpecialComment('');
                setGroupMembers(new Array(capacity).fill(''));
                
                // Smooth scroll
                const formElement = document.getElementById('booking-form-anchor');
                if (formElement) {
                    const yOffset = -120; // Offset for sticky header
                    const y = formElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                    window.scrollTo({top: y, behavior: 'smooth'});
                }
            }, []);

            // Handle Tab Switching
            const handleModeSwitch = (mode) => {
                const isSpecial = mode === 'special';
                setIsSpecialRequest(isSpecial);
                if (isSpecial) {
                    setSpecialSize(1);
                    setSpecialComment('');
                    setGroupMembers(['']);
                } else {
                    setGroupMembers(new Array(selectedCapacity).fill(''));
                }
            };

            const handleSpecialSizeChange = (e) => {
                const size = parseInt(e.target.value);
                setSpecialSize(size);
                // Preserve existing name if shrinking, or add empty if growing
                setGroupMembers(prev => {
                    const newArr = new Array(size).fill('');
                    for(let i=0; i<Math.min(prev.length, size); i++) newArr[i] = prev[i];
                    return newArr;
                });
            };

            const submitBooking = useCallback(async () => {
                if (!isAuthReady || userBooking) {
                    alertUser(<><AlertTriangle className="w-5 h-5"/> <span>Active request exists. Wait for completion.</span></>, 'bg-amber-500 text-slate-900 border-amber-400/20');
                    return;
                }

                if (!selectedCabinId || selectedCapacity === 0) {
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Please select a cabin.</span></>, 'bg-red-500 text-white border-red-400/20');
                    return;
                }
                
                const filledMembers = (groupMembers || []).map(name => (name || '').trim());
                
                if (filledMembers.length === 0 || filledMembers.some(name => !name)) {
                     alertUser(<><XCircle className="w-5 h-5"/> <span>All member names are required.</span></>, 'bg-red-500 text-white border-red-400/20');
                     return;
                }

                if (getCabinStatus(selectedCabinId, allBookings).status !== 'Available') {
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Cabin taken! Please select another.</span></>, 'bg-red-500 text-white border-red-400/20');
                    return;
                }
                
                const newBookingData = {
                    cabinId: selectedCabinId,
                    // Use special size if in special mode, otherwise full capacity
                    capacity: isSpecialRequest ? specialSize : selectedCapacity,
                    requesterName: filledMembers[0],
                    requesterId: userId,
                    groupMembers: filledMembers,
                    timestamp: isDemoMode ? new Date() : Timestamp.now(),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    exportTimestamp: new Date().toISOString(),
                    // Add Special Request Metadata
                    bookingType: isSpecialRequest ? 'Special' : 'Standard',
                    specialReason: isSpecialRequest ? specialReason : null,
                    specialComment: isSpecialRequest ? specialComment : null
                };

                if (isDemoMode) {
                    setAllBookings(prev => [...prev, { ...newBookingData, id: `demo-${Date.now()}` }]);
                    setSelectedCabinId('');
                    setSelectedCapacity(0);
                    setGroupMembers([]);
                    setIsSpecialRequest(false);
                    setSpecialComment('');
                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Request submitted (Demo)!</span></>, 'bg-emerald-500 text-white border-emerald-400/20');
                    return;
                }
                
                try {
                    await addDoc(collection(db, BOOKINGS_COLLECTION), newBookingData);
                    
                    setSelectedCabinId('');
                    setSelectedCapacity(0);
                    setGroupMembers([]);
                    setIsSpecialRequest(false);
                    setSpecialComment('');

                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Request submitted for approval!</span></>, 'bg-emerald-500 text-white border-emerald-400/20');
                } catch (error) {
                    console.error("Submission error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Submission failed.</span></>, 'bg-red-500 text-white border-red-400/20');
                }
            }, [isAuthReady, userBooking, selectedCabinId, selectedCapacity, groupMembers, allBookings, alertUser, db, userId, isSpecialRequest, specialSize, specialReason, specialComment]);

            const cancelBooking = useCallback(async () => {
                if (!userBooking) return;
                
                if (isDemoMode) {
                    setAllBookings(prev => prev.filter(b => b.id !== userBooking.id));
                    alertUser(<><LogOut className="w-5 h-5"/> <span>Request cancelled (Demo).</span></>, 'bg-sky-500 text-white border-sky-400/20');
                    return;
                }

                if (!db) return;
                try {
                    await deleteDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id));
                    alertUser(<><LogOut className="w-5 h-5"/> <span>Request cancelled.</span></>, 'bg-sky-500 text-white border-sky-400/20');
                } catch (error) {
                    console.error("Cancel error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Error cancelling request.</span></>, 'bg-red-500 text-white border-red-400/20');
                }
            }, [userBooking, alertUser, db]);
            
            const completeBookingEarly = useCallback(async () => {
                if (!userBooking || userBooking.status !== 'Approved') return;
                
                if (isDemoMode) {
                    setAllBookings(prev => prev.map(b => b.id === userBooking.id ? { ...b, status: 'Completed', completionTime: new Date() } : b));
                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Checked out (Demo).</span></>, 'bg-emerald-500 text-white border-emerald-400/20');
                    return;
                }

                if (!db) return;
                try {
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id), {
                        status: 'Completed',
                        completionTime: Timestamp.now(),
                    });
                    alertUser(<><CheckCircle className="w-5 h-5"/> <span>Checked out. Session complete.</span></>, 'bg-emerald-500 text-white border-emerald-400/20');
                } catch (error) {
                    console.error("Checkout error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Checkout failed.</span></>, 'bg-red-500 text-white border-red-400/20');
                }
            }, [userBooking, alertUser, db]);

            const confirmCancelBooking = useCallback(() => {
                setModal({
                    title: "Terminate Request?",
                    message: "This will permanently remove your booking request. You will need to start over.",
                    confirmText: "Yes, Terminate",
                    action: cancelBooking,
                    confirmClass: "bg-red-600 hover:bg-red-700 shadow-red-600/20"
                });
            }, [cancelBooking]);
            
            const confirmCheckOut = useCallback(() => {
                setModal({
                    title: "End Session Early?",
                    message: "This will free up the cabin for other groups immediately.",
                    confirmText: "Yes, Check Out",
                    action: completeBookingEarly,
                    confirmClass: "bg-emerald-600 hover:bg-emerald-700 shadow-emerald-600/20"
                });
            }, [completeBookingEarly]);
            
            const updateBookingStatus = useCallback(async (bookingId, newStatus) => {
                if (!isAuthReady) return;
                
                const facultyName = 'Faculty Admin';
                
                if (isDemoMode) {
                     setAllBookings(prev => prev.map(b => {
                        if (b.id === bookingId) {
                            const updates = { status: newStatus };
                            if (newStatus === 'Approved') {
                                updates.approvedBy = facultyName;
                                updates.timestamp = new Date();
                            }
                            return { ...b, ...updates };
                        }
                        return b;
                     }));
                     return;
                }

                if (!db) return;

                const updateData = { status: newStatus };
                if (newStatus === 'Approved') {
                    updateData.approvedBy = facultyName;
                    updateData.timestamp = Timestamp.now();
                }

                try {
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, bookingId), updateData);
                } catch (error) {
                    console.error("Update error:", error);
                    alertUser(<><XCircle className="w-5 h-5"/> <span>Action failed.</span></>, 'bg-red-500 text-white');
                }
            }, [isAuthReady, db, alertUser]);

            const useCountdown = (booking) => {
                const [remainingTime, setRemainingTime] = useState(null);
                const [isCritical, setIsCritical] = useState(false);

                useEffect(() => {
                    if (!booking || booking.status !== 'Approved' || booking.completionTime || !booking.timestamp) {
                        setRemainingTime(null);
                        return;
                    }
                    if (typeof booking.timestamp.getTime !== 'function') return;

                    const updateTimer = () => {
                        const startTime = booking.timestamp.getTime();
                        const endTime = startTime + booking.durationHours * 60 * 60 * 1000;
                        const now = new Date().getTime();
                        const distance = endTime - now;

                        if (distance < 0) {
                            setRemainingTime('00:00:00');
                            setIsCritical(false);
                        } else {
                            const minutesLeft = Math.floor(distance / (1000 * 60));
                            setIsCritical(minutesLeft <= 5);

                            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                            setRemainingTime(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                        }
                    };

                    updateTimer(); 
                    const interval = setInterval(updateTimer, 1000);
                    return () => clearInterval(interval);
                }, [booking]);

                return { remainingTime, isCritical };
            };

            const filteredCabins = useMemo(() => {
                let list = initialCabins;
                if (capacityFilter) {
                    list = list.filter(c => c.capacity === parseInt(capacityFilter));
                }
                return list;
            }, [capacityFilter]);

            const CabinGrid = useMemo(() => {
                return filteredCabins.map(cabin => {
                    const statusInfo = getCabinStatus(cabin.id, allBookings);
                    const isAvailable = statusInfo.status === 'Available';
                    const isOccupied = statusInfo.status === 'Occupied';
                    const isSelected = selectedCabinId === cabin.id;
                    const isPending = statusInfo.status === 'Pending Approval';
                    
                    let borderColor, statusBadge;
                    
                    if (isAvailable) {
                        borderColor = isSelected ? 'ring-2 ring-indigo-500 border-transparent bg-indigo-50/50' : 'border-slate-200 hover:border-indigo-300 hover:shadow-lg hover:-translate-y-1';
                        statusBadge = <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></div>Available</span>;
                    } else if (isPending) {
                        borderColor = 'border-amber-200 bg-amber-50/30 opacity-80 cursor-not-allowed';
                        statusBadge = <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700"><Clock className="w-3 h-3 mr-1"/>Pending</span>;
                    } else {
                        borderColor = 'border-red-100 bg-red-50/30 opacity-70 grayscale-[0.5] cursor-not-allowed';
                        statusBadge = <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700"><XCircle className="w-3 h-3 mr-1"/>Occupied</span>;
                    }

                    const isDisabled = !isAvailable || !!userBooking;
                    
                    return (
                        <div 
                            key={cabin.id}
                            className={`
                                relative p-6 bg-white rounded-2xl shadow-sm transition-all duration-300 border
                                ${borderColor} ${isSelected ? 'shadow-indigo-100 shadow-xl scale-[1.02]' : ''}
                            `}
                            onClick={!isDisabled ? () => selectCabin(cabin.id, cabin.capacity) : undefined}
                        >
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h3 className="text-xl font-bold text-slate-800">{cabin.name}</h3>
                                    <div className="text-xs text-slate-500 mt-1 flex items-center">
                                        <Users className="w-3 h-3 mr-1"/> {cabin.capacity} Seats
                                    </div>
                                </div>
                                {statusBadge}
                            </div>

                            {statusInfo.name && (
                                <div className="mt-2 text-xs bg-white/50 border border-slate-100 p-2 rounded-lg text-slate-600 truncate flex items-center">
                                    <User className="w-3 h-3 mr-1.5 text-slate-400"/> {statusInfo.name}
                                </div>
                            )}
                            
                            <div className="mt-6 flex items-center justify-between">
                                <span className={`text-xs font-semibold uppercase tracking-wider ${isSelected ? 'text-indigo-600' : 'text-slate-400'}`}>
                                    {isSelected ? 'Selected' : 'Tap to Select'}
                                </span>
                                {isSelected && <div className="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>}
                            </div>
                        </div>
                    );
                });
            }, [selectedCabinId, allBookings, userBooking, selectCabin, filteredCabins]);


            const UserStatusCard = () => {
                const { remainingTime, isCritical } = useCountdown(userBooking);

                if (!userBooking) {
                    return (
                        <div className="glass-panel p-10 rounded-3xl text-center border-dashed border-2 border-slate-300">
                            <div className="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-500">
                                <BookOpen className="w-8 h-8"/>
                            </div>
                            <h3 className="text-xl font-bold text-slate-800">No Active Sessions</h3>
                            <p className="text-slate-500 mt-2 max-w-md mx-auto">Browse the available cabins below and select one to start your booking request.</p>
                        </div>
                    );
                }
                
                const isApproved = userBooking.status === 'Approved';
                const statusColor = isApproved ? 'bg-emerald-500' : 'bg-amber-500';
                const isSpecial = userBooking.bookingType === 'Special';

                return (
                    <div className="relative overflow-hidden bg-white rounded-3xl shadow-2xl shadow-indigo-200/50 border border-slate-100 group animate-enter">
                        {/* Decorative Top Border */}
                        <div className={`absolute top-0 left-0 right-0 h-1.5 ${isApproved ? 'bg-gradient-to-r from-emerald-400 to-teal-500' : 'bg-gradient-to-r from-amber-400 to-orange-500'}`}></div>
                        
                        <div className="p-8 md:p-10 relative z-10">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
                                <div>
                                    <div className="flex flex-wrap items-center gap-3 mb-3">
                                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white shadow-md ${statusColor}`}>
                                            {isApproved ? <CheckCircle className="w-3.5 h-3.5 mr-1.5"/> : <Clock className="w-3.5 h-3.5 mr-1.5"/>}
                                            {userBooking.status.toUpperCase()}
                                        </span>
                                        {isSpecial && (
                                            <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200">
                                                <Star className="w-3.5 h-3.5 mr-1.5"/> Special Request
                                            </span>
                                        )}
                                        <span className="text-xs text-slate-400 font-mono">ID: {userBooking.id.slice(-6)}</span>
                                    </div>
                                    <h2 className="text-4xl font-extrabold text-slate-800 tracking-tight">
                                        {userBooking.cabinId} 
                                        <span className="text-xl font-medium text-slate-400 ml-3">
                                            ({userBooking.capacity} Pax)
                                        </span>
                                    </h2>
                                    {isSpecial && <div className="text-sm text-purple-600 mt-2 font-medium bg-purple-50 inline-block px-3 py-1 rounded-lg border border-purple-100">Reason: {userBooking.specialReason}</div>}
                                </div>

                                {isApproved && (
                                    <div className="flex flex-col items-end">
                                        <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Time Remaining</p>
                                        <div className={`text-5xl font-mono font-bold tracking-tighter ${isCritical ? 'text-red-500 animate-pulse' : 'text-slate-800'}`}>
                                            {remainingTime || '--:--'}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-slate-50 rounded-2xl p-6 mb-8 border border-slate-100">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {(userBooking.groupMembers || []).map((name, i) => (
                                        <div key={i} className="flex items-center space-x-3 bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${i===0 ? 'bg-indigo-500' : 'bg-slate-300'}`}>
                                                {name.charAt(0)}
                                            </div>
                                            <span className={`text-sm ${i===0 ? 'font-semibold text-slate-800' : 'text-slate-600'}`}>
                                                {name} {i===0 && <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded ml-1">HOST</span>}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-4">
                                {isApproved && (
                                    <button 
                                        onClick={confirmCheckOut}
                                        className="flex-1 py-4 px-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-200 flex items-center justify-center group"
                                    >
                                        <LogOut className="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform"/> Check Out Now
                                    </button>
                                )}
                                <button 
                                    onClick={confirmCancelBooking}
                                    className={`
                                        py-4 px-6 rounded-xl font-bold transition-all flex items-center justify-center
                                        ${!isApproved 
                                            ? 'w-full bg-slate-100 hover:bg-red-50 text-slate-600 hover:text-red-600 border border-slate-200 hover:border-red-200' 
                                            : 'flex-1 bg-white border-2 border-slate-100 hover:border-red-100 text-slate-500 hover:text-red-500'}
                                    `}
                                >
                                    Cancel Request
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const FacultyView = useMemo(() => {
                const active = allBookings
                    .filter(b => b.status === 'Pending' || b.status === 'Approved')
                    .sort((a, b) => {
                        const timeA = a.timestamp?.getTime ? a.timestamp.getTime() : 0;
                        const timeB = b.timestamp?.getTime ? b.timestamp.getTime() : 0;
                        return timeA - timeB;
                    });

                if (active.length === 0) return <div className="text-center text-slate-400 py-12 italic">Queue is currently empty</div>;

                return active.map(b => (
                    <div key={b.id} className="flex flex-col md:flex-row justify-between items-center p-5 bg-white border border-slate-100 rounded-xl shadow-sm mb-3 hover:shadow-md transition-all duration-200 group">
                        <div className="mb-4 md:mb-0 w-full md:w-auto">
                            <div className="flex items-center gap-3 mb-2">
                                <span className={`w-2.5 h-2.5 rounded-full ${b.status === 'Pending' ? 'bg-amber-500' : 'bg-emerald-500'}`}></span>
                                <span className="font-bold text-lg text-slate-800">{b.cabinId}</span>
                                {b.bookingType === 'Special' && (
                                    <span className="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider flex items-center">
                                        <Star className="w-3 h-3 mr-1"/> Special
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center text-sm text-slate-500">
                                <User className="w-3.5 h-3.5 mr-1.5"/> {b.requesterName}
                                <span className="mx-2 text-slate-300">|</span>
                                <Users className="w-3.5 h-3.5 mr-1.5"/> {b.groupMembers.length} Ppl
                                <span className="mx-2 text-slate-300">|</span>
                                <Clock className="w-3.5 h-3.5 mr-1.5"/> {b.timestamp?.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                            {b.bookingType === 'Special' && (
                                <div className="mt-2 text-xs bg-purple-50 text-purple-700 p-2 rounded-lg border border-purple-100 max-w-md">
                                    <span className="font-bold">{b.specialReason}</span>
                                    {b.specialComment && <span className="text-purple-600 block mt-1 italic">"{b.specialComment}"</span>}
                                </div>
                            )}
                        </div>
                        
                        <div className="flex gap-2 w-full md:w-auto">
                            {b.status === 'Pending' ? (
                                <>
                                    <button onClick={() => updateBookingStatus(b.id, 'Approved')} className="flex-1 md:flex-none py-2 px-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-lg text-sm font-bold hover:bg-emerald-100 transition-colors">Approve</button>
                                    <button onClick={() => updateBookingStatus(b.id, 'Rejected')} className="flex-1 md:flex-none py-2 px-4 bg-red-50 text-red-700 border border-red-100 rounded-lg text-sm font-bold hover:bg-red-100 transition-colors">Reject</button>
                                </>
                            ) : (
                                <button onClick={() => updateBookingStatus(b.id, 'Completed')} className="w-full md:w-auto py-2 px-4 bg-slate-100 text-slate-600 border border-slate-200 rounded-lg text-sm font-bold hover:bg-slate-200 transition-colors">Force Complete</button>
                            )}
                        </div>
                    </div>
                ));
            }, [allBookings, updateBookingStatus]);

            const exportCSV = () => {
                if (!allBookings.length) return;
                const headers = ["ID,Cabin,Status,Type,Reason,Comment,Requester,Time"];
                const rows = allBookings.map(b => {
                     const timeStr = b.timestamp?.toISOString ? b.timestamp.toISOString() : '';
                     const reason = b.specialReason || 'Standard';
                     const type = b.bookingType || 'Standard';
                     const comment = b.specialComment ? b.specialComment.replace(/"/g, '""') : '';
                     return `${b.id},${b.cabinId},${b.status},${type},"${reason}","${comment}","${b.requesterName}",${timeStr}`;
                });
                const csvContent = headers.concat(rows).join('\n');
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv' }));
                link.download = `bookings-${Date.now()}.csv`;
                link.click();
            };

            return (
                <div className="min-h-screen pb-20">
                    <AlertComponent />
                    <ConfirmationModal modal={modal} setModal={setModal} />

                    {/* Glass Header */}
                    <header className="glass-header sticky top-0 z-40 px-6 py-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <Zap className="w-6 h-6"/>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-slate-900 tracking-tight">CabinControl</h1>
                                    <p className="text-xs text-slate-500 hidden sm:block">Campus Study Space Management</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                {isDemoMode && <div className="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200">DEMO MODE</div>}
                                <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200">
                                    <div className={`w-2 h-2 rounded-full ${isAuthReady ? 'bg-emerald-500' : 'bg-amber-500 animate-pulse'}`}></div>
                                    <span className="text-xs font-mono text-slate-600">
                                        {userId ? userId.substring(0, 6) + '...' : 'Connecting...'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 pt-8 space-y-12">
                        
                        {/* 1. Status Section */}
                        <section className="animate-enter" style={{animationDelay: '0.1s'}}>
                            <UserStatusCard />
                        </section>

                        {/* 2. Selection Section */}
                        <section className="animate-enter" style={{animationDelay: '0.2s'}}>
                            <div className="flex flex-col sm:flex-row justify-between items-end mb-6 border-b border-slate-200 pb-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Available Spaces</h2>
                                    <p className="text-slate-500 mt-1">Select a cabin to view details</p>
                                </div>
                                <div className="mt-4 sm:mt-0 relative">
                                    <Filter className="w-4 h-4 text-slate-500 absolute left-3 top-3"/>
                                    <select 
                                        value={capacityFilter}
                                        onChange={(e) => setCapacityFilter(e.target.value)}
                                        className="pl-9 pr-10 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm appearance-none cursor-pointer hover:border-indigo-300 transition-colors"
                                    >
                                        <option value="">All Capacities</option>
                                        <option value="4">4 Person</option>
                                        <option value="5">5 Person</option>
                                        <option value="6">6 Person</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                                {CabinGrid}
                            </div>
                        </section>

                        {/* 3. Booking Form */}
                        {selectedCabinId && !userBooking && (
                            <section id="booking-form-anchor" className="animate-enter" style={{animationDelay: '0s'}}>
                                <div className="glass-panel p-8 rounded-3xl shadow-xl max-w-3xl mx-auto relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-2 h-full bg-indigo-600"></div>
                                    
                                    <div className="mb-8">
                                        <h2 className="text-2xl font-bold text-slate-900">Finalize Request</h2>
                                        <p className="text-slate-500 mt-1">
                                            Booking <span className="font-bold text-slate-900">{selectedCabinId}</span> 
                                            {isSpecialRequest ? ' for limited occupancy' : ' for full capacity'}
                                        </p>
                                    </div>

                                    {/* Custom Tab Switcher */}
                                    <div className="flex bg-slate-100 p-1.5 rounded-xl mb-8 relative">
                                        <button 
                                            onClick={() => handleModeSwitch('standard')}
                                            className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all relative z-10 flex items-center justify-center gap-2 ${!isSpecialRequest ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <Zap className="w-4 h-4"/> Standard Booking
                                        </button>
                                        <button 
                                            onClick={() => handleModeSwitch('special')}
                                            className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all relative z-10 flex items-center justify-center gap-2 ${isSpecialRequest ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <Star className="w-4 h-4"/> Special Request
                                        </button>
                                    </div>

                                    <div id="student-request-form" className="transition-all duration-300">
                                        {/* Special Request Inputs */}
                                        {isSpecialRequest && (
                                            <div className="mb-8 p-5 bg-purple-50/50 rounded-2xl border border-purple-100 animate-enter">
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-4">
                                                    <div>
                                                        <label className="block text-xs font-bold text-purple-800 uppercase mb-1.5 ml-1">Reason</label>
                                                        <div className="relative group">
                                                            <Briefcase className="w-4 h-4 absolute left-3 top-3.5 text-purple-400 group-focus-within:text-purple-600 transition-colors"/>
                                                            <select 
                                                                value={specialReason}
                                                                onChange={(e) => setSpecialReason(e.target.value)}
                                                                className="w-full pl-10 p-3 bg-white border border-purple-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                                            >
                                                                <option value="Interview">Interview</option>
                                                                <option value="Meeting">Meeting</option>
                                                                <option value="Medical">Medical/Health</option>
                                                                <option value="Other">Other</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-purple-800 uppercase mb-1.5 ml-1">Occupancy</label>
                                                        <div className="relative group">
                                                            <Users className="w-4 h-4 absolute left-3 top-3.5 text-purple-400 group-focus-within:text-purple-600 transition-colors"/>
                                                            <select 
                                                                value={specialSize}
                                                                onChange={handleSpecialSizeChange}
                                                                className="w-full pl-10 p-3 bg-white border border-purple-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                                            >
                                                                <option value="1">1 Person</option>
                                                                <option value="2">2 People</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                     <label className="block text-xs font-bold text-purple-800 uppercase mb-1.5 ml-1">Additional Details (Optional)</label>
                                                     <div className="relative group">
                                                         <MessageSquare className="w-4 h-4 absolute left-3 top-3.5 text-purple-400 group-focus-within:text-purple-600 transition-colors"/>
                                                         <textarea
                                                             value={specialComment}
                                                             onChange={(e) => setSpecialComment(e.target.value)}
                                                             className="w-full pl-10 p-3 bg-white border border-purple-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all resize-none"
                                                             placeholder="Briefly explain your request..."
                                                             rows="2"
                                                         />
                                                     </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="space-y-4 mb-8">
                                            {groupMembers.map((name, idx) => (
                                                <div key={idx} className="group">
                                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1 flex justify-between">
                                                        {idx === 0 ? 'Primary Requester' : `Member ${idx + 1}`}
                                                        {idx === 0 && <span className="text-indigo-500">Required</span>}
                                                    </label>
                                                    <div className="relative">
                                                        <input 
                                                            type="text"
                                                            value={name}
                                                            onChange={(e) => {
                                                                const newM = [...groupMembers];
                                                                newM[idx] = e.target.value;
                                                                setGroupMembers(newM);
                                                            }}
                                                            placeholder={idx === 0 ? "Your Full Name" : "Member Name"}
                                                            className={`
                                                                w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none transition-all
                                                                focus:bg-white focus:ring-2 focus:border-transparent
                                                                ${isSpecialRequest ? 'focus:ring-purple-500' : 'focus:ring-indigo-500'}
                                                            `}
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <button 
                                            onClick={submitBooking}
                                            className={`
                                                w-full py-4 font-bold rounded-xl shadow-lg transition-all transform active:scale-[0.99] text-white flex items-center justify-center text-lg
                                                ${isSpecialRequest 
                                                    ? 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:shadow-purple-200' 
                                                    : 'bg-gradient-to-r from-indigo-600 to-blue-600 hover:shadow-indigo-200'}
                                            `}
                                        >
                                            Submit Request <ChevronRight className="w-5 h-5 ml-2"/>
                                        </button>
                                    </div>
                                </div>
                            </section>
                        )}

                        {/* 4. Admin Panel */}
                        <section className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                            <div className="flex justify-between items-center mb-8 pb-4 border-b border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center">
                                    <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center mr-3 text-slate-600">
                                        <Users className="w-5 h-5"/>
                                    </div>
                                    Live Queue
                                </h3>
                                <button onClick={exportCSV} className="text-sm text-indigo-600 hover:text-indigo-800 font-bold flex items-center px-4 py-2 hover:bg-indigo-50 rounded-lg transition-colors">
                                    <Download className="w-4 h-4 mr-2"/> Export CSV
                                </button>
                            </div>
                            <div className="space-y-3">
                                {FacultyView}
                            </div>
                        </section>

                    </main>
                    
                    <footer className="mt-12 py-8 text-center text-slate-400 text-sm border-t border-slate-200/50">
                        <p> {new Date().getFullYear()} CabinControl System. Optimized for Collaborative Learning.</p>
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>