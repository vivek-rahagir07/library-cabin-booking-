<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Collaborative Booking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX execution -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .animate-enter {
            animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen flex flex-col">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, User, LogOut, Download, AlertTriangle, CheckCircle, XCircle, Users, BookOpen, Zap, Filter, Info, Star, Briefcase, MessageSquare, ChevronRight, GraduationCap, LayoutDashboard, Lock, Unlock, ShieldCheck, WifiOff, Loader2 } from 'https://esm.sh/lucide-react@0.263.1';
        
        // Firebase Imports (Stable Version)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border-l-4 border-red-500">
                                <h1 className="text-2xl font-bold text-slate-800 mb-2 flex items-center">
                                    <AlertTriangle className="w-8 h-8 text-red-500 mr-3"/>
                                    App Error
                                </h1>
                                <p className="text-slate-600 mb-4">The application encountered a critical error.</p>
                                <div className="bg-slate-100 p-4 rounded-lg overflow-auto text-xs font-mono text-red-600 mb-6 max-h-40">
                                    {this.state.error?.toString()}
                                </div>
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700">
                                    Reload
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const firebaseConfig = {
          apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
          authDomain: "library-booking-83e2a.firebaseapp.com",
          projectId: "library-booking-83e2a",
          storageBucket: "library-booking-83e2a.firebasestorage.app",
          messagingSenderId: "712017475970",
          appId: "1:712017475970:web:760a61d2bcbde376eff79b",
          measurementId: "G-XEHSTZ2SYD"
        };

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = "cabin_bookings";

        const initialCabins = Array.from({ length: CABIN_COUNT }, (_, i) => {
            const num = i + 1;
            let capacity = 4;
            if (num === 1 || num === 2) capacity = 6;
            else if (num === 5 || num === 6) capacity = 5;
            return { id: `C${num}`, name: `Cabin ${num}`, capacity };
        });

        // --- Hooks & Helpers ---

        const useAlert = () => {
            const [alert, setAlert] = useState({ message: '', classes: '', visible: false });
            const alertUser = useCallback((message, classes) => {
                setAlert({ message, classes, visible: true });
                const timer = setTimeout(() => setAlert(prev => ({ ...prev, visible: false })), 6000);
                return () => clearTimeout(timer);
            }, []);
            const AlertComponent = () => (
                <div className={`fixed top-20 right-6 px-6 py-4 rounded-xl text-left font-medium shadow-2xl transition-all duration-500 ease-out z-[60] ${alert.classes} ${alert.visible ? 'opacity-100 translate-x-0 scale-100' : 'opacity-0 translate-x-10 scale-95 pointer-events-none'} flex items-center space-x-3 backdrop-blur-xl border border-white/10`} role="alert">
                    {alert.message}
                </div>
            );
            return [alertUser, AlertComponent];
        };

        const useCountdown = (booking) => {
            const [time, setTime] = useState(null);
            useEffect(() => {
                if (!booking || booking.status !== 'Approved' || !booking.timestamp) { 
                    setTime(null); 
                    return; 
                }
                
                // Safe check for timestamp method
                const startTime = booking.timestamp.getTime ? booking.timestamp.getTime() : new Date(booking.timestamp).getTime();
                if (isNaN(startTime)) { setTime("Error"); return; }

                const updateTimer = () => {
                    const end = startTime + booking.durationHours * 3600000;
                    const diff = end - new Date().getTime();
                    if (diff < 0) {
                        setTime("00:00:00");
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        const h = Math.floor(m / 60);
                        setTime(`${h}:${(m % 60).toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
                    }
                };
                
                updateTimer();
                const interval = setInterval(updateTimer, 1000);
                return () => clearInterval(interval);
            }, [booking]);
            return { remainingTime: time };
        };

        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime && 
                b.timestamp &&
                ((b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()) + BOOKING_DURATION_HOURS * 3600000) > now.getTime()
            );

            if (activeBooking) {
                return { 
                    status: 'Occupied', 
                    name: activeBooking.requesterName, 
                    role: activeBooking.role || 'student'
                };
            }

            const pendingBooking = allBookings.find(b => b.cabinId === cabinId && b.status === 'Pending');
            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName, role: pendingBooking.role || 'student' };
            }

            return { status: 'Available', name: null };
        };

        // --- Main Component ---

        const ConfirmationModal = ({ modal, setModal }) => {
            if (!modal) return null;
            const closeModal = () => setModal(null);
            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex justify-center items-center z-[70] transition-all duration-300 px-4">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-enter">
                        <h3 className="text-2xl font-bold text-slate-800 mb-3">{modal.title}</h3>
                        <p className="text-slate-600 mb-8 leading-relaxed">{modal.message}</p>
                        {modal.inputProps && (
                            <div className="mb-6">
                                <input {...modal.inputProps} className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all"/>
                            </div>
                        )}
                        <div className="flex justify-end space-x-3">
                            <button onClick={closeModal} className="py-2.5 px-6 rounded-xl font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">Cancel</button>
                            <button onClick={() => { if(modal.action) modal.action(); closeModal(); }} className={`py-2.5 px-6 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 ${modal.confirmClass || 'bg-red-600 hover:bg-red-700'}`}>{modal.confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            const [studentBookings, setStudentBookings] = useState([]);
            const [facultyBookings, setFacultyBookings] = useState([]);
            const [userBooking, setUserBooking] = useState(null);
            
            const [selectedCabinId, setSelectedCabinId] = useState('');
            const [selectedCapacity, setSelectedCapacity] = useState(0);
            const [groupMembers, setGroupMembers] = useState([]);
            
            const [bookingRole, setBookingRole] = useState('student');
            const [isSpecialRequest, setIsSpecialRequest] = useState(false);
            const [specialReason, setSpecialReason] = useState('Interview');
            const [specialSize, setSpecialSize] = useState(1);
            const [specialComment, setSpecialComment] = useState('');
            
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [adminViewRole, setAdminViewRole] = useState('student');
            const [capacityFilter, setCapacityFilter] = useState(''); 
            const [modal, setModal] = useState(null);
            const [alertUser, AlertComponent] = useAlert();

            // FIX: Call hooks unconditionally at top level
            const { remainingTime } = useCountdown(userBooking);

            const allBookings = useMemo(() => [...studentBookings, ...facultyBookings], [studentBookings, facultyBookings]);

            const setDemoModeActive = useCallback((reason = "") => {
                if(isDemoMode) return;
                console.log("Switching to Demo Mode:", reason);
                setIsDemoMode(true);
                setUserId("demo-user-123");
                setIsAuthReady(true);
                
                const mockStudent = { id: 'mock-1', cabinId: 'C1', status: 'Approved', requesterId: 'other', requesterName: 'Alice', groupMembers: ['Alice'], timestamp: new Date(), durationHours: 2, capacity: 6, role: 'student' };
                const mockFaculty = { id: 'mock-2', cabinId: 'C5', status: 'Pending', requesterId: 'prof', requesterName: 'Dr. Smith', groupMembers: ['Dr. Smith'], timestamp: new Date(), durationHours: 2, capacity: 5, role: 'faculty' };
                
                setStudentBookings([mockStudent]);
                setFacultyBookings([mockFaculty]);
                setIsLoading(false);
                
                if (reason) alertUser(<span>{reason}</span>, "bg-slate-700 text-white");
            }, [alertUser, isDemoMode]);

            useEffect(() => {
                if (!firebaseConfig) { setDemoModeActive("Local Mode"); return; }
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auther = getAuth(app);
                    setDb(firestore);
                    setAuth(auther);
                    signInAnonymously(auther).catch(e => setDemoModeActive("Auth Failed"));
                    const unsub = onAuthStateChanged(auther, (user) => {
                        if (user) { setUserId(user.uid); setIsAuthReady(true); setIsLoading(false); }
                    });
                    return () => unsub();
                } catch (err) { setDemoModeActive("Config Error"); }
            }, [setDemoModeActive]);

            useEffect(() => {
                if (isDemoMode) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current || null);
                    return;
                }
                if (!db || !isAuthReady || !userId) return;

                const unsub = onSnapshot(query(collection(db, BOOKINGS_COLLECTION)), (snapshot) => {
                    const students = [];
                    const faculty = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const b = { id: doc.id, ...data };
                        if (b.timestamp?.toDate) b.timestamp = b.timestamp.toDate();
                        if (b.completionTime?.toDate) b.completionTime = b.completionTime.toDate();
                        
                        if (b.role === 'faculty') faculty.push(b);
                        else students.push({ ...b, role: 'student' });
                    });
                    setStudentBookings(students);
                    setFacultyBookings(faculty);
                    setIsLoading(false);
                }, (err) => {
                    if (err.code === 'permission-denied') setDemoModeActive("Database Locked. Using Demo.");
                });
                return () => unsub();
            }, [db, isAuthReady, userId, isDemoMode, setDemoModeActive]);

            useEffect(() => {
                if (!isDemoMode && allBookings.length > 0) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current || null);
                }
            }, [allBookings, userId, isDemoMode]);

            const selectCabin = (cabinId, capacity) => {
                setSelectedCabinId(cabinId);
                setSelectedCapacity(capacity);
                setIsSpecialRequest(false);
                setSpecialSize(1);
                setGroupMembers(new Array(capacity).fill(''));
                setTimeout(() => document.getElementById('booking-form-anchor')?.scrollIntoView({behavior: 'smooth'}), 100);
            };

            const submitBooking = async () => {
                if (!selectedCabinId) return alertUser("Select a cabin", "bg-red-500 text-white");
                const filled = groupMembers.map(n => n.trim());
                if (filled.some(n => !n)) return alertUser("Fill all names", "bg-red-500 text-white");
                
                const bookingData = {
                    cabinId: selectedCabinId,
                    capacity: isSpecialRequest ? specialSize : selectedCapacity,
                    requesterName: filled[0],
                    requesterId: userId,
                    groupMembers: filled,
                    timestamp: isDemoMode ? new Date() : Timestamp.now(),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    bookingType: isSpecialRequest ? 'Special' : 'Standard',
                    specialReason: isSpecialRequest ? specialReason : null,
                    specialComment: isSpecialRequest ? specialComment : null,
                    role: bookingRole
                };

                if (isDemoMode) {
                    const mock = { ...bookingData, id: `demo-${Date.now()}` };
                    if (bookingRole === 'student') setStudentBookings(p => [...p, mock]);
                    else setFacultyBookings(p => [...p, mock]);
                    alertUser("Submitted (Demo)", "bg-emerald-500 text-white");
                    setSelectedCabinId('');
                    return;
                }

                try {
                    await addDoc(collection(db, BOOKINGS_COLLECTION), bookingData);
                    setSelectedCabinId('');
                    alertUser("Request Submitted", "bg-emerald-500 text-white");
                } catch (e) {
                    if (e.code === 'permission-denied') setDemoModeActive("Permission Denied");
                    else alertUser("Error submitting", "bg-red-500 text-white");
                }
            };

            const cancelBooking = async () => {
                if (!userBooking) return;
                if (isDemoMode) {
                    const setter = userBooking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    setter(prev => prev.filter(b => b.id !== userBooking.id));
                    setUserBooking(null);
                    return;
                }
                try { await deleteDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id)); } catch(e) { console.error(e); }
            };

            const completeBooking = async () => {
                if (!userBooking || isDemoMode) return cancelBooking(); // Simpler logic for demo
                try { await updateDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id), { status: 'Completed', completionTime: Timestamp.now() }); } catch(e) { console.error(e); }
            };

            const updateBookingStatus = async (booking, newStatus) => {
                if (isDemoMode) {
                    const setter = booking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    setter(prev => prev.map(b => b.id === booking.id ? { ...b, status: newStatus } : b));
                    return;
                }
                try { await updateDoc(doc(db, BOOKINGS_COLLECTION, booking.id), { status: newStatus, approvedBy: 'Librarian', timestamp: Timestamp.now() }); } catch(e) { console.error(e); }
            };

            const passwordRef = useRef('');
            const handleLogin = () => {
                passwordRef.current = '';
                setModal({
                    title: "Librarian Login",
                    message: "Enter password:",
                    confirmText: "Login",
                    confirmClass: "bg-indigo-600",
                    inputProps: { type: "password", placeholder: "Password", onChange: e => passwordRef.current = e.target.value },
                    action: () => {
                        if(passwordRef.current === 'admin123') { setIsAdminLoggedIn(true); alertUser("Logged In", "bg-emerald-500 text-white"); }
                        else alertUser("Invalid Password", "bg-red-500 text-white");
                    }
                });
            };

            const filteredCabins = useMemo(() => {
                if (!capacityFilter) return initialCabins;
                return initialCabins.filter(c => c.capacity === parseInt(capacityFilter));
            }, [capacityFilter]);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-10 h-10 animate-spin text-indigo-600"/></div>;

            return (
                <div className="min-h-screen pb-20">
                    <AlertComponent />
                    <ConfirmationModal modal={modal} setModal={setModal} />
                    
                    <header className="glass-header sticky top-0 z-40 px-6 py-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><Zap className="w-6 h-6"/></div>
                                <h1 className="text-xl font-bold text-slate-900">CabinControl</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                {isDemoMode && <span className="text-xs font-bold bg-slate-200 px-2 py-1 rounded">OFFLINE</span>}
                                <button onClick={isAdminLoggedIn ? () => setIsAdminLoggedIn(false) : handleLogin} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-200">
                                    {isAdminLoggedIn ? <Unlock className="w-3 h-3"/> : <Lock className="w-3 h-3"/>}
                                    {isAdminLoggedIn ? "Logout" : "Librarian"}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 pt-8 space-y-12">
                        {/* Status Section */}
                        <section className="animate-enter">
                            {userBooking ? (
                                <div className="bg-white rounded-3xl shadow-xl border border-slate-100 p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <div>
                                            <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold text-white mb-2 ${userBooking.status === 'Approved' ? 'bg-emerald-500' : 'bg-amber-500'}`}>{userBooking.status}</span>
                                            <h2 className="text-3xl font-bold text-slate-800">{userBooking.cabinId}</h2>
                                        </div>
                                        {userBooking.status === 'Approved' && (
                                            <div className="text-right">
                                                <p className="text-xs font-bold text-slate-400">REMAINING</p>
                                                <div className="text-3xl font-mono font-bold text-slate-800">{remainingTime || '--:--'}</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex gap-4">
                                        {userBooking.status === 'Approved' && <button onClick={() => setModal({title:"End Session?", message:"Finish booking?", confirmText:"End", action: completeBooking, confirmClass:"bg-emerald-600"})} className="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl">Check Out</button>}
                                        <button onClick={() => setModal({title:"Cancel?", message:"Delete request?", confirmText:"Cancel", action: cancelBooking, confirmClass:"bg-red-600"})} className="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl">Cancel</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="glass-panel p-8 rounded-3xl text-center border-dashed border-2 border-slate-300">
                                    <BookOpen className="w-10 h-10 mx-auto text-indigo-400 mb-4"/>
                                    <h3 className="text-lg font-bold text-slate-700">Ready to Book</h3>
                                    <p className="text-slate-500">Select a cabin to begin.</p>
                                </div>
                            )}
                        </section>

                        {/* Cabins Grid */}
                        <section className="animate-enter">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-slate-800">Spaces</h2>
                                <select value={capacityFilter} onChange={e => setCapacityFilter(e.target.value)} className="bg-white border p-2 rounded-lg text-sm"><option value="">All</option><option value="4">4 Pax</option><option value="5">5 Pax</option><option value="6">6 Pax</option></select>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                                {filteredCabins.map(cabin => {
                                    const status = getCabinStatus(cabin.id, allBookings);
                                    const isFree = status.status === 'Available';
                                    const isSelected = selectedCabinId === cabin.id;
                                    return (
                                        <div key={cabin.id} onClick={isFree && !userBooking ? () => selectCabin(cabin.id, cabin.capacity) : undefined} 
                                            className={`p-6 bg-white rounded-2xl border transition-all ${isSelected ? 'ring-2 ring-indigo-500' : isFree ? 'hover:shadow-lg cursor-pointer' : 'opacity-70 grayscale'}`}>
                                            <h3 className="font-bold text-slate-800">{cabin.name}</h3>
                                            <div className="text-xs text-slate-500 mt-1">{cabin.capacity} Seats</div>
                                            <div className={`mt-4 text-xs font-bold ${isFree ? 'text-emerald-600' : 'text-red-500'}`}>{isFree ? 'Available' : 'Occupied'}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* Booking Form */}
                        {selectedCabinId && !userBooking && (
                            <section id="booking-form-anchor" className="animate-enter glass-panel p-8 rounded-3xl shadow-xl max-w-2xl mx-auto border-l-4 border-indigo-600">
                                <h2 className="text-2xl font-bold text-slate-900 mb-6">Booking {selectedCabinId}</h2>
                                
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                                    <button onClick={() => setBookingRole('student')} className={`flex-1 py-2 rounded-lg text-sm font-bold ${bookingRole === 'student' ? 'bg-white shadow' : ''}`}>Student</button>
                                    <button onClick={() => setBookingRole('faculty')} className={`flex-1 py-2 rounded-lg text-sm font-bold ${bookingRole === 'faculty' ? 'bg-white shadow' : ''}`}>Faculty</button>
                                </div>

                                <div className="flex gap-4 mb-6 text-sm">
                                    <label className="flex items-center"><input type="radio" checked={!isSpecialRequest} onChange={() => { setIsSpecialRequest(false); setGroupMembers(new Array(selectedCapacity).fill('')); }} className="mr-2"/> Standard</label>
                                    <label className="flex items-center"><input type="radio" checked={isSpecialRequest} onChange={() => { setIsSpecialRequest(true); setGroupMembers(['']); }} className="mr-2"/> Special</label>
                                </div>

                                {isSpecialRequest && (
                                    <div className="mb-6 p-4 bg-purple-50 rounded-xl">
                                        <select value={specialReason} onChange={e => setSpecialReason(e.target.value)} className="w-full mb-3 p-2 rounded border"><option>Interview</option><option>Meeting</option></select>
                                        <select value={specialSize} onChange={e => { setSpecialSize(parseInt(e.target.value)); setGroupMembers(new Array(parseInt(e.target.value)).fill('')); }} className="w-full mb-3 p-2 rounded border"><option value="1">1 Person</option><option value="2">2 People</option></select>
                                        <textarea value={specialComment} onChange={e => setSpecialComment(e.target.value)} placeholder="Details..." className="w-full p-2 rounded border h-20"></textarea>
                                    </div>
                                )}

                                <div className="space-y-3 mb-6">
                                    {groupMembers.map((name, i) => (
                                        <input key={i} value={name} onChange={e => { const n = [...groupMembers]; n[i] = e.target.value; setGroupMembers(n); }} placeholder={`Name ${i+1}`} className="w-full p-3 bg-slate-50 border rounded-xl"/>
                                    ))}
                                </div>
                                <button onClick={submitBooking} className="w-full py-4 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg">Confirm</button>
                            </section>
                        )}

                        {/* Admin Queue */}
                        <section className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm animate-enter">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center">
                                    <LayoutDashboard className="w-5 h-5 mr-2 text-slate-500"/> 
                                    {isAdminLoggedIn ? 'Live Queue' : 'Admin Access Required'}
                                </h3>
                                {isAdminLoggedIn && (
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        <button onClick={() => setAdminViewRole('student')} className={`px-3 py-1 text-xs font-bold rounded ${adminViewRole === 'student' ? 'bg-white shadow' : ''}`}>Students</button>
                                        <button onClick={() => setAdminViewRole('faculty')} className={`px-3 py-1 text-xs font-bold rounded ${adminViewRole === 'faculty' ? 'bg-white shadow' : ''}`}>Faculty</button>
                                    </div>
                                )}
                            </div>

                            {isAdminLoggedIn ? (
                                <div className="space-y-3">
                                    {(adminViewRole === 'student' ? studentBookings : facultyBookings).filter(b => b.status === 'Pending' || b.status === 'Approved').map(b => (
                                        <div key={b.id} className="flex justify-between items-center p-4 bg-white border rounded-xl shadow-sm">
                                            <div>
                                                <div className="font-bold">{b.cabinId} <span className="text-slate-400 text-xs font-normal">({b.requesterName})</span></div>
                                                {b.bookingType === 'Special' && <span className="text-xs bg-purple-100 text-purple-700 px-1 rounded">Special: {b.specialReason}</span>}
                                            </div>
                                            <div className="flex gap-2">
                                                {b.status === 'Pending' ? (
                                                    <><button onClick={() => updateBookingStatus(b, 'Approved')} className="px-3 py-1 bg-emerald-100 text-emerald-700 rounded font-bold text-xs">Approve</button>
                                                    <button onClick={() => updateBookingStatus(b, 'Rejected')} className="px-3 py-1 bg-red-100 text-red-700 rounded font-bold text-xs">Reject</button></>
                                                ) : (
                                                    <button onClick={() => updateBookingStatus(b, 'Completed')} className="px-3 py-1 bg-slate-100 text-slate-600 rounded font-bold text-xs">End</button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {(adminViewRole === 'student' ? studentBookings : facultyBookings).filter(b => b.status === 'Pending' || b.status === 'Approved').length === 0 && <div className="text-center text-slate-400 text-sm">No requests</div>}
                                </div>
                            ) : (
                                <div className="text-center py-8 bg-slate-50 rounded-xl border border-dashed">
                                    <ShieldCheck className="w-8 h-8 mx-auto text-slate-300 mb-2"/>
                                    <p className="text-sm text-slate-500 mb-4">Librarian access only.</p>
                                    <button onClick={handleLogin} className="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold">Login</button>
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>