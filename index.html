<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Collaborative Booking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX execution -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .cabin-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .cabin-card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-enter {
            animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0; 
        }

        .input-group:focus-within label {
            color: #4f46e5;
        }
        
        .input-group:focus-within svg {
            color: #4f46e5;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3); 
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, User, LogOut, Download, AlertTriangle, CheckCircle, XCircle, Users, BookOpen, Zap, Filter, Info, Star, Briefcase, MessageSquare, ChevronRight, GraduationCap, LayoutDashboard, Lock, Unlock, ShieldCheck, WifiOff, Loader2, Calendar } from 'https://esm.sh/lucide-react@0.263.1';
        
        // Firebase Imports (Stable Version)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border-l-4 border-red-500">
                                <h1 className="text-2xl font-bold text-slate-800 mb-2 flex items-center">
                                    <AlertTriangle className="w-8 h-8 text-red-500 mr-3"/>
                                    System Error
                                </h1>
                                <p className="text-slate-600 mb-4">Something went unexpectedly wrong.</p>
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all">
                                    Reload Page
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const firebaseConfig = {
          apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
          authDomain: "library-booking-83e2a.firebaseapp.com",
          projectId: "library-booking-83e2a",
          storageBucket: "library-booking-83e2a.firebasestorage.app",
          messagingSenderId: "712017475970",
          appId: "1:712017475970:web:760a61d2bcbde376eff79b",
          measurementId: "G-XEHSTZ2SYD"
        };

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = "cabin_bookings";

        const initialCabins = Array.from({ length: CABIN_COUNT }, (_, i) => {
            const num = i + 1;
            let capacity = 4;
            if (num === 1 || num === 2) capacity = 6;
            else if (num === 5 || num === 6) capacity = 5;
            return { id: `C${num}`, name: `Cabin ${num}`, capacity };
        });

        // --- Hooks & Helpers ---

        const useAlert = () => {
            const [alert, setAlert] = useState({ message: '', classes: '', visible: false });
            const alertUser = useCallback((message, classes) => {
                setAlert({ message, classes, visible: true });
                const timer = setTimeout(() => setAlert(prev => ({ ...prev, visible: false })), 5000);
                return () => clearTimeout(timer);
            }, []);
            const AlertComponent = () => (
                <div className={`fixed top-24 right-6 z-[100] transition-all duration-500 ease-out transform ${alert.visible ? 'translate-x-0 opacity-100' : 'translate-x-10 opacity-0 pointer-events-none'}`}>
                    <div className={`px-6 py-4 rounded-xl shadow-2xl backdrop-blur-md border border-white/20 flex items-center gap-3 font-medium ${alert.classes}`}>
                        {alert.message}
                    </div>
                </div>
            );
            return [alertUser, AlertComponent];
        };

        const useCountdown = (booking) => {
            const [time, setTime] = useState(null);
            useEffect(() => {
                if (!booking || booking.status !== 'Approved' || !booking.timestamp) { 
                    setTime(null); 
                    return; 
                }
                
                const startTime = booking.timestamp.getTime ? booking.timestamp.getTime() : new Date(booking.timestamp).getTime();
                if (isNaN(startTime)) { setTime("Error"); return; }

                const updateTimer = () => {
                    const end = startTime + booking.durationHours * 3600000;
                    const diff = end - new Date().getTime();
                    if (diff < 0) {
                        setTime("00:00:00");
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        const h = Math.floor(m / 60);
                        setTime(`${h}:${(m % 60).toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
                    }
                };
                
                updateTimer();
                const interval = setInterval(updateTimer, 1000);
                return () => clearInterval(interval);
            }, [booking]);
            return { remainingTime: time };
        };

        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime && 
                b.timestamp &&
                ((b.timestamp.getTime ? b.timestamp.getTime() : new Date(b.timestamp).getTime()) + BOOKING_DURATION_HOURS * 3600000) > now.getTime()
            );

            if (activeBooking) {
                return { 
                    status: 'Occupied', 
                    name: activeBooking.requesterName, 
                    role: activeBooking.role || 'student'
                };
            }

            const pendingBooking = allBookings.find(b => b.cabinId === cabinId && b.status === 'Pending');
            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName, role: pendingBooking.role || 'student' };
            }

            return { status: 'Available', name: null };
        };

        // --- Main Component ---

        const ConfirmationModal = ({ modal, setModal }) => {
            if (!modal) return null;
            const closeModal = () => setModal(null);
            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex justify-center items-center z-[80] transition-all duration-300 p-4">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-enter relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">{modal.title}</h3>
                        <p className="text-slate-600 mb-8 leading-relaxed text-sm">{modal.message}</p>
                        {modal.inputProps && (
                            <div className="mb-6">
                                <input {...modal.inputProps} className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all"/>
                            </div>
                        )}
                        <div className="flex justify-end gap-3">
                            <button onClick={closeModal} className="px-6 py-2.5 rounded-xl font-semibold text-slate-600 hover:bg-slate-100 transition-colors">Cancel</button>
                            <button onClick={() => { if(modal.action) modal.action(); closeModal(); }} className={`px-6 py-2.5 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 ${modal.confirmClass || 'bg-slate-900 hover:bg-slate-800'}`}>{modal.confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // ... (State logic same as before, focusing on visual changes below)
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            const [studentBookings, setStudentBookings] = useState([]);
            const [facultyBookings, setFacultyBookings] = useState([]);
            const [userBooking, setUserBooking] = useState(null);
            
            const [selectedCabinId, setSelectedCabinId] = useState('');
            const [selectedCapacity, setSelectedCapacity] = useState(0);
            const [groupMembers, setGroupMembers] = useState([]);
            
            const [bookingRole, setBookingRole] = useState('student');
            const [isSpecialRequest, setIsSpecialRequest] = useState(false);
            const [specialReason, setSpecialReason] = useState('Interview');
            const [specialSize, setSpecialSize] = useState(1);
            const [specialComment, setSpecialComment] = useState('');
            
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [adminViewRole, setAdminViewRole] = useState('student');
            const [capacityFilter, setCapacityFilter] = useState(''); 
            const [modal, setModal] = useState(null);
            const [alertUser, AlertComponent] = useAlert();

            const { remainingTime } = useCountdown(userBooking);

            const allBookings = useMemo(() => [...studentBookings, ...facultyBookings], [studentBookings, facultyBookings]);

            const setDemoModeActive = useCallback((reason = "") => {
                if(isDemoMode) return;
                console.log("Switching to Demo Mode:", reason);
                setIsDemoMode(true);
                setUserId("demo-user-123");
                setIsAuthReady(true);
                
                const mockStudent = { id: 'mock-1', cabinId: 'C1', status: 'Approved', requesterId: 'other', requesterName: 'Alice', groupMembers: ['Alice'], timestamp: new Date(), durationHours: 2, capacity: 6, role: 'student' };
                const mockFaculty = { id: 'mock-2', cabinId: 'C5', status: 'Pending', requesterId: 'prof', requesterName: 'Dr. Smith', groupMembers: ['Dr. Smith'], timestamp: new Date(), durationHours: 2, capacity: 5, role: 'faculty' };
                
                setStudentBookings([mockStudent]);
                setFacultyBookings([mockFaculty]);
                setIsLoading(false);
                
                if (reason) alertUser(<span>{reason}</span>, "bg-slate-800 text-white");
            }, [alertUser, isDemoMode]);

            useEffect(() => {
                if (!firebaseConfig) { setDemoModeActive("Local Mode"); return; }
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auther = getAuth(app);
                    setDb(firestore);
                    setAuth(auther);
                    signInAnonymously(auther).catch(e => setDemoModeActive("Auth Failed"));
                    const unsub = onAuthStateChanged(auther, (user) => {
                        if (user) { setUserId(user.uid); setIsAuthReady(true); setIsLoading(false); }
                    });
                    return () => unsub();
                } catch (err) { setDemoModeActive("Config Error"); }
            }, [setDemoModeActive]);

            useEffect(() => {
                if (isDemoMode) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current || null);
                    return;
                }
                if (!db || !isAuthReady || !userId) return;

                const unsub = onSnapshot(query(collection(db, BOOKINGS_COLLECTION)), (snapshot) => {
                    const students = [];
                    const faculty = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const b = { id: doc.id, ...data };
                        if (b.timestamp?.toDate) b.timestamp = b.timestamp.toDate();
                        if (b.completionTime?.toDate) b.completionTime = b.completionTime.toDate();
                        
                        if (b.role === 'faculty') faculty.push(b);
                        else students.push({ ...b, role: 'student' });
                    });
                    setStudentBookings(students);
                    setFacultyBookings(faculty);
                    setIsLoading(false);
                }, (err) => {
                    if (err.code === 'permission-denied') setDemoModeActive("Database Locked. Using Demo.");
                });
                return () => unsub();
            }, [db, isAuthReady, userId, isDemoMode, setDemoModeActive]);

            useEffect(() => {
                if (!isDemoMode && allBookings.length > 0) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current || null);
                }
            }, [allBookings, userId, isDemoMode]);

            const selectCabin = (cabinId, capacity) => {
                setSelectedCabinId(cabinId);
                setSelectedCapacity(capacity);
                setIsSpecialRequest(false);
                setSpecialSize(1);
                setGroupMembers(new Array(capacity).fill(''));
                setTimeout(() => document.getElementById('booking-form-anchor')?.scrollIntoView({behavior: 'smooth'}), 100);
            };

            const submitBooking = async () => {
                if (!selectedCabinId) return alertUser("Select a cabin", "bg-red-500 text-white");
                const filled = groupMembers.map(n => n.trim());
                if (filled.some(n => !n)) return alertUser("Fill all names", "bg-red-500 text-white");
                
                const bookingData = {
                    cabinId: selectedCabinId,
                    capacity: isSpecialRequest ? specialSize : selectedCapacity,
                    requesterName: filled[0],
                    requesterId: userId,
                    groupMembers: filled,
                    timestamp: isDemoMode ? new Date() : Timestamp.now(),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    bookingType: isSpecialRequest ? 'Special' : 'Standard',
                    specialReason: isSpecialRequest ? specialReason : null,
                    specialComment: isSpecialRequest ? specialComment : null,
                    role: bookingRole
                };

                if (isDemoMode) {
                    const mock = { ...bookingData, id: `demo-${Date.now()}` };
                    if (bookingRole === 'student') setStudentBookings(p => [...p, mock]);
                    else setFacultyBookings(p => [...p, mock]);
                    alertUser("Submitted (Demo)", "bg-emerald-500 text-white");
                    setSelectedCabinId('');
                    return;
                }

                try {
                    await addDoc(collection(db, BOOKINGS_COLLECTION), bookingData);
                    setSelectedCabinId('');
                    alertUser("Request Submitted", "bg-emerald-500 text-white");
                } catch (e) {
                    if (e.code === 'permission-denied') setDemoModeActive("Permission Denied");
                    else alertUser("Error submitting", "bg-red-500 text-white");
                }
            };

            const cancelBooking = async () => {
                if (!userBooking) return;
                if (isDemoMode) {
                    const setter = userBooking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    setter(prev => prev.filter(b => b.id !== userBooking.id));
                    setUserBooking(null);
                    return;
                }
                try { await deleteDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id)); } catch(e) { console.error(e); }
            };

            const completeBooking = async () => {
                if (!userBooking || isDemoMode) return cancelBooking(); // Simpler logic for demo
                try { await updateDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id), { status: 'Completed', completionTime: Timestamp.now() }); } catch(e) { console.error(e); }
            };

            const updateBookingStatus = async (booking, newStatus) => {
                if (isDemoMode) {
                    const setter = booking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    setter(prev => prev.map(b => b.id === booking.id ? { ...b, status: newStatus } : b));
                    return;
                }
                try { await updateDoc(doc(db, BOOKINGS_COLLECTION, booking.id), { status: newStatus, approvedBy: 'Librarian', timestamp: Timestamp.now() }); } catch(e) { console.error(e); }
            };

            const passwordRef = useRef('');
            const handleLogin = () => {
                passwordRef.current = '';
                setModal({
                    title: "Librarian Login",
                    message: "Enter password:",
                    confirmText: "Access Panel",
                    confirmClass: "bg-indigo-600 hover:bg-indigo-700",
                    inputProps: { type: "password", placeholder: "Password", onChange: e => passwordRef.current = e.target.value },
                    action: () => {
                        if(passwordRef.current === 'admin123') { setIsAdminLoggedIn(true); alertUser("Logged In", "bg-emerald-500 text-white"); }
                        else alertUser("Invalid Password", "bg-red-500 text-white");
                    }
                });
            };

            const filteredCabins = useMemo(() => {
                if (!capacityFilter) return initialCabins;
                return initialCabins.filter(c => c.capacity === parseInt(capacityFilter));
            }, [capacityFilter]);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white"><div className="flex flex-col items-center"><Loader2 className="w-12 h-12 animate-spin text-indigo-400 mb-4"/><p className="font-medium animate-pulse">Initializing System...</p></div></div>;

            return (
                <div className="min-h-screen pb-24">
                    <AlertComponent />
                    <ConfirmationModal modal={modal} setModal={setModal} />
                    
                    <header className="glass-header px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                <Zap className="w-5 h-5"/>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800 tracking-tight">CabinControl</h1>
                                <p className="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Collaborative Space</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            {isDemoMode && <div className="text-[10px] font-bold bg-amber-100 text-amber-700 px-3 py-1 rounded-full border border-amber-200 shadow-sm flex items-center"><WifiOff className="w-3 h-3 mr-1"/> OFFLINE</div>}
                            <button onClick={isAdminLoggedIn ? () => setIsAdminLoggedIn(false) : handleLogin} className={`flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold transition-all shadow-sm ${isAdminLoggedIn ? 'bg-indigo-50 text-indigo-600 border border-indigo-100' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>
                                {isAdminLoggedIn ? <Unlock className="w-3 h-3"/> : <Lock className="w-3 h-3"/>}
                                {isAdminLoggedIn ? "Logout" : "Admin"}
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 pt-10 space-y-12">
                        {/* Status Section */}
                        <section className="animate-enter">
                            {userBooking ? (
                                <div className="relative bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                                    <div className={`absolute top-0 left-0 w-full h-1.5 ${userBooking.status === 'Approved' ? 'bg-gradient-to-r from-emerald-400 to-teal-500' : 'bg-gradient-to-r from-amber-400 to-orange-500'}`}></div>
                                    <div className="p-8 md:p-10">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8">
                                            <div>
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white shadow-sm ${userBooking.status === 'Approved' ? 'bg-emerald-500' : 'bg-amber-500'}`}>
                                                        {userBooking.status === 'Approved' ? <CheckCircle className="w-3 h-3 mr-1.5"/> : <Clock className="w-3 h-3 mr-1.5"/>}
                                                        {userBooking.status.toUpperCase()}
                                                    </span>
                                                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{userBooking.role} Booking</span>
                                                </div>
                                                <h2 className="text-4xl font-black text-slate-800 tracking-tight">{userBooking.cabinId}</h2>
                                                {userBooking.bookingType === 'Special' && <div className="mt-2 text-sm text-purple-600 font-medium bg-purple-50 inline-block px-3 py-1 rounded-lg border border-purple-100">âœ¨ Special Request: {userBooking.specialReason}</div>}
                                            </div>
                                            
                                            {userBooking.status === 'Approved' && (
                                                <div className="bg-slate-50 px-6 py-4 rounded-2xl border border-slate-100 text-center min-w-[140px]">
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Time Left</p>
                                                    <div className="text-3xl font-mono font-bold text-slate-800">{remainingTime || '--:--'}</div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-4 pt-6 border-t border-slate-100">
                                            {userBooking.status === 'Approved' && (
                                                <button onClick={() => setModal({title:"Check Out?", message:"This will free up the cabin immediately.", confirmText:"Confirm Check Out", action: completeBooking, confirmClass:"bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200"})} 
                                                    className="flex-1 py-3.5 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-100 flex items-center justify-center">
                                                    <LogOut className="w-4 h-4 mr-2"/> Check Out
                                                </button>
                                            )}
                                            <button onClick={() => setModal({title:"Cancel Request?", message:"This action cannot be undone.", confirmText:"Yes, Cancel", action: cancelBooking, confirmClass:"bg-red-600 hover:bg-red-700 shadow-red-200"})} 
                                                className={`py-3.5 px-6 rounded-xl font-bold transition-all flex items-center justify-center ${userBooking.status === 'Approved' ? 'bg-white border-2 border-slate-100 text-slate-500 hover:text-red-600 hover:border-red-100' : 'w-full bg-slate-100 text-slate-600 hover:bg-red-50 hover:text-red-600'}`}>
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="glass-panel p-12 rounded-3xl text-center border border-white/40 shadow-xl shadow-indigo-100/50">
                                    <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-indigo-500 shadow-inner">
                                        <BookOpen className="w-10 h-10"/>
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-800 mb-2">Ready to Collaborate?</h3>
                                    <p className="text-slate-500 max-w-md mx-auto">Select an available cabin from the grid below to start your booking session.</p>
                                </div>
                            )}
                        </section>

                        {/* Cabins Grid */}
                        <section className="animate-enter" style={{animationDelay: '0.1s'}}>
                            <div className="flex flex-col sm:flex-row justify-between items-end mb-8 gap-4 border-b border-slate-200 pb-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><LayoutDashboard className="w-6 h-6 text-indigo-500"/> Available Spaces</h2>
                                    <p className="text-slate-500 mt-1 text-sm">Real-time availability status</p>
                                </div>
                                <div className="relative group">
                                    <Filter className="w-4 h-4 text-slate-400 absolute left-3 top-3 group-hover:text-indigo-500 transition-colors"/>
                                    <select value={capacityFilter} onChange={e => setCapacityFilter(e.target.value)} className="pl-10 pr-8 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500 hover:border-indigo-300 transition-all cursor-pointer shadow-sm">
                                        <option value="">All Capacities</option>
                                        <option value="4">4 Person</option>
                                        <option value="5">5 Person</option>
                                        <option value="6">6 Person</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-5">
                                {filteredCabins.map(cabin => {
                                    const status = getCabinStatus(cabin.id, allBookings);
                                    const isFree = status.status === 'Available';
                                    const isSelected = selectedCabinId === cabin.id;
                                    const isPending = status.status === 'Pending Approval';
                                    
                                    return (
                                        <div key={cabin.id} onClick={isFree && !userBooking ? () => selectCabin(cabin.id, cabin.capacity) : undefined} 
                                            className={`cabin-card relative p-6 bg-white rounded-2xl border transition-all duration-300 group
                                                ${isSelected ? 'border-indigo-500 ring-4 ring-indigo-500/10 z-10' : 
                                                  isFree ? 'border-slate-200 hover:border-indigo-300 cursor-pointer' : 
                                                  'border-slate-100 bg-slate-50/50 cursor-not-allowed disabled'}
                                            `}>
                                            
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className={`text-lg font-bold ${isSelected ? 'text-indigo-700' : 'text-slate-700'}`}>{cabin.name}</h3>
                                                    <div className="text-xs text-slate-400 mt-1 flex items-center font-medium"><Users className="w-3 h-3 mr-1"/> {cabin.capacity} Seats</div>
                                                </div>
                                                {isFree ? (
                                                    <div className="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 shadow-sm"><CheckCircle className="w-4 h-4"/></div>
                                                ) : isPending ? (
                                                    <div className="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 shadow-sm"><Clock className="w-4 h-4"/></div>
                                                ) : (
                                                    <div className="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-400"><XCircle className="w-4 h-4"/></div>
                                                )}
                                            </div>
                                            
                                            <div className="mt-4 pt-4 border-t border-slate-50 flex justify-between items-center">
                                                <span className={`text-[10px] font-bold uppercase tracking-wider ${isFree ? 'text-emerald-600' : isPending ? 'text-amber-600' : 'text-red-400'}`}>
                                                    {isFree ? 'Available' : isPending ? 'Pending' : 'Occupied'}
                                                </span>
                                                {isSelected && <div className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">SELECTED</div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* Booking Form */}
                        {selectedCabinId && !userBooking && (
                            <section id="booking-form-anchor" className="animate-enter">
                                <div className="glass-panel p-8 rounded-3xl shadow-2xl shadow-indigo-200/40 max-w-2xl mx-auto border border-white/60 relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                                    
                                    <h2 className="text-3xl font-bold text-slate-800 mb-1">Finalize Booking</h2>
                                    <p className="text-slate-500 mb-8">You are requesting <span className="font-bold text-indigo-600">{selectedCabinId}</span></p>
                                    
                                    <div className="bg-slate-50 p-1.5 rounded-xl mb-8 flex relative">
                                        <button onClick={() => setBookingRole('student')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all relative z-10 flex items-center justify-center gap-2 ${bookingRole === 'student' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-500 hover:text-slate-700'}`}>
                                            <GraduationCap className="w-4 h-4"/> Student
                                        </button>
                                        <button onClick={() => setBookingRole('faculty')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all relative z-10 flex items-center justify-center gap-2 ${bookingRole === 'faculty' ? 'bg-white text-orange-600 shadow-md' : 'text-slate-500 hover:text-slate-700'}`}>
                                            <Briefcase className="w-4 h-4"/> Faculty
                                        </button>
                                    </div>

                                    <div className="space-y-4 mb-8">
                                        <label className={`flex items-center p-4 border rounded-xl cursor-pointer transition-all ${!isSpecialRequest ? 'border-indigo-500 bg-indigo-50/30 ring-1 ring-indigo-500' : 'border-slate-200 hover:border-slate-300'}`}>
                                            <input type="radio" checked={!isSpecialRequest} onChange={() => { setIsSpecialRequest(false); setGroupMembers(new Array(selectedCapacity).fill('')); }} className="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500 mr-3"/>
                                            <div className="flex-1">
                                                <span className="font-bold text-slate-700 block">Standard Booking</span>
                                                <span className="text-xs text-slate-500">Full cabin capacity ({selectedCapacity} people)</span>
                                            </div>
                                            <Users className={`w-5 h-5 ${!isSpecialRequest ? 'text-indigo-500' : 'text-slate-300'}`}/>
                                        </label>
                                        
                                        <label className={`flex items-center p-4 border rounded-xl cursor-pointer transition-all ${isSpecialRequest ? 'border-purple-500 bg-purple-50/30 ring-1 ring-purple-500' : 'border-slate-200 hover:border-slate-300'}`}>
                                            <input type="radio" checked={isSpecialRequest} onChange={() => { setIsSpecialRequest(true); setGroupMembers(['']); }} className="w-5 h-5 text-purple-600 border-gray-300 focus:ring-purple-500 mr-3"/>
                                            <div className="flex-1">
                                                <span className="font-bold text-slate-700 block">Special Request</span>
                                                <span className="text-xs text-slate-500">1-2 people (Interview, Meeting, etc.)</span>
                                            </div>
                                            <Star className={`w-5 h-5 ${isSpecialRequest ? 'text-purple-500' : 'text-slate-300'}`}/>
                                        </label>
                                    </div>

                                    {isSpecialRequest && (
                                        <div className="mb-8 p-6 bg-purple-50/50 rounded-2xl border border-purple-100 animate-enter">
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div className="input-group">
                                                    <label className="block text-xs font-bold text-purple-700 uppercase mb-2 ml-1">Reason</label>
                                                    <div className="relative">
                                                        <Briefcase className="w-4 h-4 absolute left-3 top-3 text-purple-400"/>
                                                        <select value={specialReason} onChange={e => setSpecialReason(e.target.value)} className="w-full pl-10 p-2.5 bg-white border border-purple-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-purple-500 transition-all appearance-none cursor-pointer">
                                                            <option>Interview</option><option>Meeting</option><option>Other</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="input-group">
                                                    <label className="block text-xs font-bold text-purple-700 uppercase mb-2 ml-1">People</label>
                                                    <div className="relative">
                                                        <Users className="w-4 h-4 absolute left-3 top-3 text-purple-400"/>
                                                        <select value={specialSize} onChange={e => { setSpecialSize(parseInt(e.target.value)); setGroupMembers(new Array(parseInt(e.target.value)).fill('')); }} className="w-full pl-10 p-2.5 bg-white border border-purple-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-purple-500 transition-all appearance-none cursor-pointer">
                                                            <option value="1">1 Person</option><option value="2">2 People</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="input-group">
                                                <label className="block text-xs font-bold text-purple-700 uppercase mb-2 ml-1">Details (Optional)</label>
                                                <textarea value={specialComment} onChange={e => setSpecialComment(e.target.value)} placeholder="Additional context..." className="w-full p-3 bg-white border border-purple-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-purple-500 h-20 resize-none transition-all"></textarea>
                                            </div>
                                        </div>
                                    )}

                                    <div className="space-y-4 mb-8">
                                        <div className="flex items-center justify-between px-1">
                                            <span className="text-xs font-bold text-slate-400 uppercase">Group Members</span>
                                            <span className="text-xs text-slate-400">{groupMembers.length} Slots</span>
                                        </div>
                                        {groupMembers.map((name, i) => (
                                            <div key={i} className="input-group relative">
                                                <User className={`w-4 h-4 absolute left-4 top-4 transition-colors ${i===0 ? 'text-indigo-500' : 'text-slate-400'}`}/>
                                                <input 
                                                    value={name} 
                                                    onChange={e => { const n = [...groupMembers]; n[i] = e.target.value; setGroupMembers(n); }} 
                                                    placeholder={i===0 ? "Primary Requester Name" : `Member ${i+1} Name`} 
                                                    className={`w-full pl-12 p-3.5 bg-slate-50 border rounded-xl outline-none focus:bg-white focus:ring-2 transition-all ${i===0 ? 'border-indigo-200 focus:ring-indigo-500' : 'border-slate-200 focus:ring-slate-400'}`}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    <button onClick={submitBooking} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-200 transition-all transform active:scale-[0.99] flex items-center justify-center gap-2 text-lg
                                        ${bookingRole === 'student' 
                                            ? 'bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700' 
                                            : 'bg-gradient-to-r from-orange-500 to-amber-600 hover:from-orange-600 hover:to-amber-700'}`}>
                                        Submit Request <ChevronRight className="w-5 h-5"/>
                                    </button>
                                </div>
                            </section>
                        )}

                        {/* Admin Queue */}
                        <section className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm animate-enter">
                            <div className="flex justify-between items-center mb-8 pb-6 border-b border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center">
                                    <div className="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center mr-3 text-slate-500">
                                        <LayoutDashboard className="w-5 h-5"/> 
                                    </div>
                                    {isAdminLoggedIn ? 'Live Queue' : 'Admin Access'}
                                </h3>
                                {isAdminLoggedIn && (
                                    <div className="flex bg-slate-100 p-1 rounded-xl">
                                        <button onClick={() => setAdminViewRole('student')} className={`px-4 py-2 text-xs font-bold rounded-lg transition-all ${adminViewRole === 'student' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}>Students</button>
                                        <button onClick={() => setAdminViewRole('faculty')} className={`px-4 py-2 text-xs font-bold rounded-lg transition-all ${adminViewRole === 'faculty' ? 'bg-white shadow text-orange-600' : 'text-slate-500 hover:text-slate-700'}`}>Faculty</button>
                                    </div>
                                )}
                            </div>

                            {isAdminLoggedIn ? (
                                <div className="space-y-4">
                                    {(adminViewRole === 'student' ? studentBookings : facultyBookings).filter(b => b.status === 'Pending' || b.status === 'Approved').map(b => (
                                        <div key={b.id} className="group flex flex-col md:flex-row justify-between items-center p-5 bg-white border border-slate-100 hover:border-indigo-100 rounded-2xl shadow-sm hover:shadow-md transition-all">
                                            <div className="mb-4 md:mb-0 w-full md:w-auto">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className={`w-2.5 h-2.5 rounded-full ${b.status === 'Pending' ? 'bg-amber-500' : 'bg-emerald-500'}`}></span>
                                                    <span className="font-bold text-lg text-slate-800">{b.cabinId}</span>
                                                    {b.bookingType === 'Special' && <span className="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider flex items-center"><Star className="w-3 h-3 mr-1"/>Special</span>}
                                                </div>
                                                <div className="text-sm text-slate-500 flex items-center gap-3">
                                                    <span className="flex items-center"><User className="w-3.5 h-3.5 mr-1.5 text-slate-400"/> {b.requesterName}</span>
                                                    <span className="w-1 h-1 bg-slate-300 rounded-full"></span>
                                                    <span className="flex items-center"><Users className="w-3.5 h-3.5 mr-1.5 text-slate-400"/> {b.groupMembers.length}</span>
                                                </div>
                                                {b.specialComment && <div className="mt-2 text-xs bg-purple-50 p-2 rounded-lg text-purple-700 border border-purple-100 italic max-w-md">"{b.specialComment}"</div>}
                                            </div>
                                            <div className="flex gap-3 w-full md:w-auto">
                                                {b.status === 'Pending' ? (
                                                    <React.Fragment>
                                                        <button onClick={() => updateBookingStatus(b, 'Approved')} className="flex-1 md:flex-none px-4 py-2 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-xl font-bold text-xs hover:bg-emerald-100 transition-colors">Approve</button>
                                                        <button onClick={() => updateBookingStatus(b, 'Rejected')} className="flex-1 md:flex-none px-4 py-2 bg-red-50 text-red-700 border border-red-100 rounded-xl font-bold text-xs hover:bg-red-100 transition-colors">Reject</button>
                                                    </React.Fragment>
                                                ) : (
                                                    <button onClick={() => updateBookingStatus(b, 'Completed')} className="w-full md:w-auto px-5 py-2 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl font-bold text-xs hover:bg-slate-200 transition-colors">Force End</button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {(adminViewRole === 'student' ? studentBookings : facultyBookings).filter(b => b.status === 'Pending' || b.status === 'Approved').length === 0 && (
                                        <div className="text-center py-12">
                                            <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300">
                                                <CheckCircle className="w-8 h-8"/>
                                            </div>
                                            <p className="text-slate-400 font-medium">All caught up! No active requests.</p>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="text-center py-12 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                                    <div className="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 text-slate-400">
                                        <ShieldCheck className="w-8 h-8"/>
                                    </div>
                                    <h4 className="text-lg font-bold text-slate-700 mb-1">Restricted Area</h4>
                                    <p className="text-sm text-slate-500 mb-6">Librarian access is required to view the queue.</p>
                                    <button onClick={handleLogin} className="px-6 py-2.5 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-all shadow-lg shadow-slate-200 hover:shadow-xl hover:-translate-y-0.5">
                                        Login as Librarian
                                    </button>
                                </div>
                            )}
                        </section>
                    </main>
                    
                    <footer className="mt-20 py-8 text-center text-slate-400 text-xs font-medium border-t border-slate-200/60 bg-white/50 backdrop-blur-sm">
                        <p>Â© {new Date().getFullYear()} CabinControl System â€¢ Optimized for Collaborative Learning</p>
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>