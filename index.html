<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Collaborative Booking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX execution -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .animate-enter {
            animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen flex flex-col">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, User, LogOut, Download, AlertTriangle, CheckCircle, XCircle, Users, BookOpen, Zap, Filter, Info, Star, Briefcase, MessageSquare, ChevronRight, GraduationCap, LayoutDashboard, Lock, Unlock, ShieldCheck, WifiOff, Loader2 } from 'https://esm.sh/lucide-react@0.263.1';
        
        // Firebase Imports (Stable Version)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Error Boundary Component ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("React Error Boundary caught:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border-l-4 border-red-500">
                                <h1 className="text-2xl font-bold text-slate-800 mb-2 flex items-center">
                                    <AlertTriangle className="w-8 h-8 text-red-500 mr-3"/>
                                    Application Error
                                </h1>
                                <p className="text-slate-600 mb-4">Something went wrong while loading the app.</p>
                                <div className="bg-slate-100 p-4 rounded-lg overflow-auto text-xs font-mono text-red-600 mb-6 max-h-40">
                                    {this.state.error?.toString() || "Unknown Error"}
                                </div>
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition-colors">
                                    Reload Application
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Global Constants and Firebase Initialization ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // User's Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
          authDomain: "library-booking-83e2a.firebaseapp.com",
          projectId: "library-booking-83e2a",
          storageBucket: "library-booking-83e2a.firebasestorage.app",
          messagingSenderId: "712017475970",
          appId: "1:712017475970:web:760a61d2bcbde376eff79b",
          measurementId: "G-XEHSTZ2SYD"
        };

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = "cabin_bookings";

        // UPDATED: Specific Cabin Capacities
        const initialCabins = Array.from({ length: CABIN_COUNT }, (_, i) => {
            const num = i + 1;
            let capacity = 4; // Default for "all others"
            
            // "cabin 1 and 2 has 6 member capacity"
            if (num === 1 || num === 2) {
                capacity = 6;
            } 
            // "2=5,6 has 5 members" (Assuming Cabins 5 and 6)
            else if (num === 5 || num === 6) {
                capacity = 5;
            }
            
            return {
                id: `C${num}`,
                name: `Cabin ${num}`,
                capacity: capacity,
            };
        });

        // --- Helper Functions ---

        const useAlert = () => {
            const [alert, setAlert] = useState({ message: '', classes: '', visible: false });

            const alertUser = useCallback((message, classes) => {
                setAlert({ message, classes, visible: true });
                const timer = setTimeout(() => setAlert(prev => ({ ...prev, visible: false })), 6000);
                return () => clearTimeout(timer);
            }, []);

            const AlertComponent = () => (
                <div
                    className={`fixed top-20 right-6 px-6 py-4 rounded-xl text-left font-medium shadow-2xl transition-all duration-500 ease-out z-[60] 
                        ${alert.classes} ${alert.visible ? 'opacity-100 translate-x-0 scale-100' : 'opacity-0 translate-x-10 scale-95 pointer-events-none'}
                        flex items-center space-x-3 backdrop-blur-xl border border-white/10
                    `}
                    role="alert"
                >
                    {alert.message}
                </div>
            );

            return [alertUser, AlertComponent];
        };

        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime && 
                b.timestamp && 
                typeof b.timestamp.getTime === 'function' && 
                (b.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000) > now.getTime()
            );

            if (activeBooking) {
                return { 
                    status: 'Occupied', 
                    name: activeBooking.requesterName, 
                    endTime: activeBooking.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000,
                    role: activeBooking.role || 'student' 
                };
            }

            const pendingBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Pending'
            );

            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName, role: pendingBooking.role || 'student' };
            }

            return { status: 'Available', name: null };
        };

        // --- Components ---

        const ConfirmationModal = ({ modal, setModal }) => {
            if (!modal) return null;

            const closeModal = () => setModal(null);
            const handleConfirm = () => {
                if (modal.action) modal.action();
                closeModal();
            };

            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex justify-center items-center z-[70] transition-all duration-300 px-4">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-enter">
                        <h3 className="text-2xl font-bold text-slate-800 mb-3">{modal.title}</h3>
                        <p className="text-slate-600 mb-8 leading-relaxed">{modal.message}</p>
                        
                        {modal.inputProps && (
                            <div className="mb-6">
                                <input 
                                    {...modal.inputProps}
                                    className="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                />
                            </div>
                        )}

                        <div className="flex justify-end space-x-3">
                            <button 
                                onClick={closeModal} 
                                className="py-2.5 px-6 rounded-xl font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={handleConfirm} 
                                className={`py-2.5 px-6 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 ${modal.confirmClass || 'bg-red-600 hover:bg-red-700 shadow-red-600/20'}`}
                            >
                                {modal.confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            
            const [isDemoMode, setIsDemoMode] = useState(false);
            const [isLoading, setIsLoading] = useState(true); 

            const [studentBookings, setStudentBookings] = useState([]);
            const [facultyBookings, setFacultyBookings] = useState([]);
            
            const [userBooking, setUserBooking] = useState(null);
            
            const [selectedCabinId, setSelectedCabinId] = useState('');
            const [selectedCapacity, setSelectedCapacity] = useState(0);
            const [groupMembers, setGroupMembers] = useState([]);
            
            const [bookingRole, setBookingRole] = useState('student');
            const [isSpecialRequest, setIsSpecialRequest] = useState(false);
            const [specialReason, setSpecialReason] = useState('Interview');
            const [specialSize, setSpecialSize] = useState(1);
            const [specialComment, setSpecialComment] = useState('');
            
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [adminViewRole, setAdminViewRole] = useState('student');
            
            const [capacityFilter, setCapacityFilter] = useState(''); 

            const [modal, setModal] = useState(null);
            const [alertUser, AlertComponent] = useAlert();

            const allBookings = useMemo(() => {
                return [...studentBookings, ...facultyBookings];
            }, [studentBookings, facultyBookings]);

            const setDemoModeActive = useCallback((reason = "") => {
                console.log("Switching to Demo Mode:", reason);
                setIsDemoMode(true);
                setUserId("demo-user-123");
                setIsAuthReady(true);
                
                const mockStudent = {
                    id: 'mock-1', cabinId: 'C1', status: 'Approved', requesterId: 'other', requesterName: 'Alice', groupMembers: ['Alice', 'Bob'], timestamp: new Date(), durationHours: 2, capacity: 6, role: 'student'
                };
                const mockFaculty = {
                    id: 'mock-2', cabinId: 'C5', status: 'Pending', requesterId: 'prof', requesterName: 'Dr. Smith', groupMembers: ['Dr. Smith'], timestamp: new Date(), durationHours: 2, capacity: 5, role: 'faculty'
                };
                setStudentBookings([mockStudent]);
                setFacultyBookings([mockFaculty]);
                setIsLoading(false); 
                
                if (reason) {
                    alertUser(React.createElement("div", { className: "flex items-center" }, 
                        React.createElement(WifiOff, { className: "w-5 h-5 mr-2" }), 
                        React.createElement("span", null, reason)
                    ), "bg-slate-700 text-white");
                }
            }, [alertUser]);

            useEffect(() => {
                if (!firebaseConfig) {
                    setDemoModeActive("Local Mode (No Config)");
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auther = getAuth(app);
                    setDb(firestore);
                    setAuth(auther);

                    const initAuth = async () => { await signInAnonymously(auther); };
                    
                    initAuth().catch(error => { 
                        console.warn("Auth failed, switching to demo:", error); 
                        setDemoModeActive("Auth failed. Switched to Offline Mode.");
                    });

                    const unsubscribe = onAuthStateChanged(auther, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                            setIsLoading(false); 
                        }
                    });
                    return () => unsubscribe();
                } catch (err) { 
                    console.error("Init Error:", err);
                    setDemoModeActive("Config Error. Switched to Offline Mode.");
                }
            }, [setDemoModeActive]);

            // Database Listener
            useEffect(() => {
                if (isDemoMode) {
                    const current = allBookings.find(b => b.requesterId === userId && b.status !== 'Completed' && b.status !== 'Rejected' && !b.completionTime);
                    setUserBooking(current);
                    return;
                }

                if (!db || !isAuthReady || !userId) return;

                const q = query(collection(db, BOOKINGS_COLLECTION));
                const unsub = onSnapshot(q, (snapshot) => {
                    const students = [];
                    const faculty = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const b = { id: doc.id, ...data };
                        
                        if (b.timestamp?.toDate) b.timestamp = b.timestamp.toDate();
                        if (b.completionTime?.toDate) b.completionTime = b.completionTime.toDate();
                        
                        if (b.role === 'faculty') {
                            faculty.push(b);
                        } else {
                            students.push({ ...b, role: 'student' });
                        }
                    });
                    
                    setStudentBookings(students);
                    setFacultyBookings(faculty);
                    setIsLoading(false); 
                }, (error) => {
                    if (error.code === 'permission-denied' || error.message.includes('permission') || error.message.includes('Missing or insufficient permissions')) {
                        console.warn("Firebase Permission Denied. Falling back to Demo Mode.");
                        setDemoModeActive("Database Locked (Rules). Switched to Demo.");
                    } else {
                        console.error("Firestore Error:", error);
                    }
                });

                return () => unsub();
            }, [db, isAuthReady, userId, isDemoMode, setDemoModeActive]);

            useEffect(() => {
                if (!isDemoMode && allBookings.length > 0) {
                    const current = allBookings.find(b => 
                        b.requesterId === userId && 
                        b.status !== 'Completed' && 
                        b.status !== 'Rejected' && 
                        !b.completionTime
                    );
                    setUserBooking(current);
                }
            }, [allBookings, userId, isDemoMode]);

            // Logic
            const selectCabin = useCallback((cabinId, capacity) => {
                setSelectedCabinId(cabinId);
                setSelectedCapacity(capacity);
                setIsSpecialRequest(false);
                setSpecialSize(1);
                setSpecialComment('');
                setGroupMembers(new Array(capacity).fill(''));
                
                const formElement = document.getElementById('booking-form-anchor');
                if (formElement) {
                    window.scrollTo({top: formElement.getBoundingClientRect().top + window.pageYOffset - 120, behavior: 'smooth'});
                }
            }, []);

            const submitBooking = useCallback(async () => {
                if (!isAuthReady || userBooking) {
                    alertUser(React.createElement("div", {className: "flex items-center"}, React.createElement(AlertTriangle, {className:"w-5 h-5 mr-2"}), "Active request exists."), 'bg-amber-500 text-slate-900 border-amber-400/20');
                    return;
                }
                if (!selectedCabinId) return;

                const filledMembers = groupMembers.map(n => n.trim());
                if (filledMembers.some(n => !n)) {
                     alertUser("All names required", "bg-red-500 text-white");
                     return;
                }

                if (getCabinStatus(selectedCabinId, allBookings).status !== 'Available') {
                    alertUser("Cabin taken!", "bg-red-500 text-white");
                    return;
                }
                
                const newBookingData = {
                    cabinId: selectedCabinId,
                    capacity: isSpecialRequest ? specialSize : selectedCapacity,
                    requesterName: filledMembers[0],
                    requesterId: userId,
                    groupMembers: filledMembers,
                    timestamp: isDemoMode ? new Date() : Timestamp.now(),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    bookingType: isSpecialRequest ? 'Special' : 'Standard',
                    specialReason: isSpecialRequest ? specialReason : null,
                    specialComment: isSpecialRequest ? specialComment : null,
                    role: bookingRole
                };

                if (isDemoMode) {
                    const mock = { ...newBookingData, id: `demo-${Date.now()}`, timestamp: new Date() };
                    if (bookingRole === 'student') setStudentBookings(p => [...p, mock]);
                    else setFacultyBookings(p => [...p, mock]);
                    alertUser("Submitted (Demo)", "bg-emerald-500 text-white");
                    setSelectedCabinId('');
                    return;
                }
                
                try {
                    await addDoc(collection(db, BOOKINGS_COLLECTION), newBookingData);
                    setSelectedCabinId('');
                    alertUser("Request Submitted!", "bg-emerald-500 text-white");
                } catch (error) {
                    console.error(error);
                    if (error.code === 'permission-denied') {
                        setDemoModeActive("Permission Denied. Switched to Demo.");
                    } else {
                        alertUser("Submission Failed", "bg-red-500 text-white");
                    }
                }
            }, [isAuthReady, userBooking, selectedCabinId, groupMembers, allBookings, userId, bookingRole, isSpecialRequest, specialSize, specialReason, specialComment, db, isDemoMode, setDemoModeActive]);

            const cancelBooking = useCallback(async () => {
                if (!userBooking) return;
                
                if (isDemoMode) {
                    if (userBooking.role === 'student') setStudentBookings(p => p.filter(b => b.id !== userBooking.id));
                    else setFacultyBookings(p => p.filter(b => b.id !== userBooking.id));
                    setUserBooking(null);
                    alertUser("Cancelled (Demo)", "bg-sky-500 text-white");
                    return;
                }

                if (!db) return;
                try {
                    await deleteDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id));
                    alertUser("Cancelled", "bg-sky-500 text-white");
                } catch (error) { console.error(error); }
            }, [userBooking, db, isDemoMode]);
            
            const completeBooking = useCallback(async () => {
                if (!userBooking) return;
                
                if (isDemoMode) {
                    const updater = userBooking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    updater(prev => prev.map(b => b.id === userBooking.id ? { ...b, status: 'Completed', completionTime: new Date() } : b));
                    alertUser("Checked Out (Demo)", "bg-emerald-500 text-white");
                    return;
                }

                if (!db) return;
                try {
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, userBooking.id), { status: 'Completed', completionTime: Timestamp.now() });
                    alertUser("Checked Out", "bg-emerald-500 text-white");
                } catch (error) { console.error(error); }
            }, [userBooking, db, isDemoMode]);

            const performAdminLogin = (password) => {
                if (password === 'admin123') {
                    setIsAdminLoggedIn(true);
                    alertUser("Librarian Access Granted", "bg-emerald-500 text-white");
                } else {
                    alertUser("Invalid Password", "bg-red-500 text-white");
                }
            };
            
            const passwordRef = useRef('');
            
            const handleLoginClick = () => {
                passwordRef.current = ''; 
                setModal({
                    title: "Librarian Login",
                    message: "Enter password to manage requests.",
                    confirmText: "Access Panel",
                    confirmClass: "bg-indigo-600",
                    inputProps: {
                        type: "password",
                        placeholder: "Password",
                        onChange: (e) => { passwordRef.current = e.target.value; }
                    },
                    action: () => performAdminLogin(passwordRef.current)
                });
            };

            const updateBookingStatus = useCallback(async (booking, newStatus) => {
                if (isDemoMode) {
                    const updater = booking.role === 'student' ? setStudentBookings : setFacultyBookings;
                    updater(prev => prev.map(b => b.id === booking.id ? { ...b, status: newStatus } : b));
                    return;
                }

                if (!db) return;
                try {
                    const updateData = { status: newStatus };
                    if (newStatus === 'Approved') {
                        updateData.approvedBy = 'Librarian';
                        updateData.timestamp = Timestamp.now();
                    }
                    await updateDoc(doc(db, BOOKINGS_COLLECTION, booking.id), updateData);
                } catch (error) { console.error(error); }
            }, [db, isDemoMode]);

            const useCountdown = (booking) => {
                const [time, setTime] = useState(null);
                useEffect(() => {
                    if (!booking || booking.status !== 'Approved' || !booking.timestamp) { setTime(null); return; }
                    const interval = setInterval(() => {
                        const end = booking.timestamp.getTime() + booking.durationHours * 3600000;
                        const diff = end - new Date().getTime();
                        if (diff < 0) setTime("00:00");
                        else {
                            const m = Math.floor(diff / 60000);
                            const s = Math.floor((diff % 60000) / 1000);
                            setTime(`${Math.floor(m/60)}:${m%60}:${s < 10 ? '0'+s : s}`);
                        }
                    }, 1000);
                    return () => clearInterval(interval);
                }, [booking]);
                return { remainingTime: time };
            };

            const filteredCabins = useMemo(() => {
                let list = initialCabins;
                if (capacityFilter) list = list.filter(c => c.capacity === parseInt(capacityFilter));
                return list;
            }, [capacityFilter]);

            const CabinGrid = useMemo(() => filteredCabins.map(cabin => {
                const statusInfo = getCabinStatus(cabin.id, allBookings);
                const isAvailable = statusInfo.status === 'Available';
                const isSelected = selectedCabinId === cabin.id;
                
                let roleBadge = null;
                if (statusInfo.role === 'student') roleBadge = <span className="text-[10px] bg-blue-100 text-blue-700 px-1.5 rounded border border-blue-200">Student</span>;
                if (statusInfo.role === 'faculty') roleBadge = <span className="text-[10px] bg-orange-100 text-orange-700 px-1.5 rounded border border-orange-200">Faculty</span>;

                return (
                    <div key={cabin.id} 
                        onClick={isAvailable && !userBooking ? () => selectCabin(cabin.id, cabin.capacity) : undefined}
                        className={`relative p-6 bg-white rounded-2xl shadow-sm border transition-all duration-300
                            ${isSelected ? 'ring-2 ring-indigo-500 border-transparent bg-indigo-50/50' : 
                              isAvailable ? 'border-slate-200 hover:border-indigo-300 hover:shadow-lg hover:-translate-y-1 cursor-pointer' : 
                              'border-slate-100 opacity-70 grayscale-[0.3] cursor-not-allowed'}
                        `}
                    >
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800">{cabin.name}</h3>
                                <div className="text-xs text-slate-500 mt-1 flex items-center"><Users className="w-3 h-3 mr-1"/> {cabin.capacity}</div>
                            </div>
                            {isAvailable ? (
                                <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></div>Free</span>
                            ) : (
                                <div className="flex flex-col items-end gap-1">
                                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600">Occupied</span>
                                    {roleBadge}
                                </div>
                            )}
                        </div>
                        {isSelected && <div className="text-xs font-bold text-indigo-600 uppercase tracking-wider mt-4">Selected</div>}
                    </div>
                );
            }), [selectedCabinId, allBookings, userBooking, selectCabin, filteredCabins]);

            const AdminQueue = useMemo(() => {
                const list = adminViewRole === 'student' ? studentBookings : facultyBookings;
                const active = list.filter(b => b.status === 'Pending' || b.status === 'Approved').sort((a,b) => a.timestamp - b.timestamp);

                if (active.length === 0) return <div className="text-center text-slate-400 py-12 italic">No active requests.</div>;

                return active.map(b => (
                    <div key={b.id} className="flex flex-col md:flex-row justify-between items-center p-5 bg-white border border-slate-100 rounded-xl shadow-sm mb-3 hover:shadow-md transition-all">
                        <div className="mb-4 md:mb-0">
                            <div className="flex items-center gap-3 mb-2">
                                <span className={`w-2.5 h-2.5 rounded-full ${b.status === 'Pending' ? 'bg-amber-500' : 'bg-emerald-500'}`}></span>
                                <span className="font-bold text-lg text-slate-800">{b.cabinId}</span>
                                {b.bookingType === 'Special' && <span className="bg-purple-100 text-purple-700 text-[10px] px-2 rounded-full font-bold uppercase"><Star className="w-3 h-3 inline mr-1"/>Special</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex items-center gap-2">
                                <User className="w-3 h-3"/> {b.requesterName} <span className="text-slate-300">|</span> 
                                <Users className="w-3 h-3"/> {b.groupMembers.length}
                            </div>
                            {b.specialComment && <div className="mt-1 text-xs bg-slate-50 p-1.5 rounded text-slate-600 border border-slate-100 italic">"{b.specialComment}"</div>}
                        </div>
                        <div className="flex gap-2">
                            {b.status === 'Pending' ? (
                                <React.Fragment>
                                    <button onClick={() => updateBookingStatus(b, 'Approved')} className="py-2 px-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-lg text-sm font-bold hover:bg-emerald-100">Approve</button>
                                    <button onClick={() => updateBookingStatus(b, 'Rejected')} className="py-2 px-4 bg-red-50 text-red-700 border border-red-100 rounded-lg text-sm font-bold hover:bg-red-100">Reject</button>
                                </React.Fragment>
                            ) : (
                                <button onClick={() => updateBookingStatus(b, 'Completed')} className="py-2 px-4 bg-slate-100 text-slate-600 border border-slate-200 rounded-lg text-sm font-bold hover:bg-slate-200">End</button>
                            )}
                        </div>
                    </div>
                ));
            }, [studentBookings, facultyBookings, adminViewRole, updateBookingStatus]);

            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="text-center">
                            <Loader2 className="w-12 h-12 text-indigo-600 animate-spin mx-auto mb-4"/>
                            <h2 className="text-xl font-bold text-slate-700">Connecting to System...</h2>
                            <p className="text-slate-500">Checking permissions & loading data</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20">
                    <AlertComponent />
                    <ConfirmationModal modal={modal} setModal={setModal} />

                    <header className="glass-header sticky top-0 z-40 px-6 py-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Zap className="w-6 h-6"/></div>
                                <h1 className="text-xl font-bold text-slate-900 tracking-tight">CabinControl</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                {isDemoMode && <div className="text-[10px] font-bold bg-slate-200 text-slate-600 px-2 py-1 rounded border border-slate-300">OFFLINE MODE</div>}
                                
                                {!isAdminLoggedIn ? (
                                    <button onClick={handleLoginClick} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-bold text-slate-600 transition-colors">
                                        <Lock className="w-3 h-3"/> Librarian
                                    </button>
                                ) : (
                                    <button onClick={() => setIsAdminLoggedIn(false)} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-xs font-bold text-indigo-600 transition-colors border border-indigo-200">
                                        <Unlock className="w-3 h-3"/> Logout
                                    </button>
                                )}
                                
                                <div className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200">
                                    <div className={`w-2 h-2 rounded-full ${isAuthReady ? 'bg-emerald-500' : 'bg-amber-500 animate-pulse'}`}></div>
                                    <span className="text-xs font-mono text-slate-600">{userId ? userId.substring(0, 6) + '...' : 'Connecting...'}</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 pt-8 space-y-12">
                        <section className="animate-enter">
                            {userBooking ? (
                                <div className="relative overflow-hidden bg-white rounded-3xl shadow-xl border border-slate-100 p-8">
                                    <div className={`absolute top-0 left-0 right-0 h-1.5 ${userBooking.status === 'Approved' ? 'bg-emerald-500' : 'bg-amber-500'}`}></div>
                                    <div className="flex justify-between items-center mb-6">
                                        <div>
                                            <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white mb-2 ${userBooking.status === 'Approved' ? 'bg-emerald-500' : 'bg-amber-500'}`}>{userBooking.status}</span>
                                            <h2 className="text-4xl font-extrabold text-slate-800">{userBooking.cabinId}</h2>
                                            <p className="text-sm text-slate-500 mt-1">Booked as: <span className="font-semibold uppercase text-slate-700">{userBooking.role}</span></p>
                                        </div>
                                        {userBooking.status === 'Approved' && (
                                            <div className="text-right">
                                                <p className="text-xs font-bold text-slate-400 uppercase">Remaining</p>
                                                <div className="text-4xl font-mono font-bold text-slate-800">{useCountdown(userBooking).remainingTime || '--:--'}</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex gap-4">
                                        {userBooking.status === 'Approved' && <button onClick={() => setModal({ title: "End Session?", message: "Free up cabin?", confirmText: "Check Out", action: completeBooking, confirmClass: "bg-emerald-600" })} className="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl">Check Out</button>}
                                        <button onClick={() => setModal({ title: "Cancel?", message: "Cancel booking?", confirmText: "Cancel", action: cancelBooking, confirmClass: "bg-red-600" })} className="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl border border-slate-200">Cancel</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="glass-panel p-8 rounded-3xl text-center border-dashed border-2 border-slate-300">
                                    <BookOpen className="w-10 h-10 mx-auto text-indigo-400 mb-4"/>
                                    <h3 className="text-lg font-bold text-slate-700">Ready to Book</h3>
                                    <p className="text-slate-500">Select a cabin below to begin.</p>
                                </div>
                            )}
                        </section>

                        <section className="animate-enter" style={{animationDelay: '0.1s'}}>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-slate-800">Available Spaces</h2>
                                <div className="relative">
                                    <Filter className="w-4 h-4 text-slate-500 absolute left-3 top-3"/>
                                    <select value={capacityFilter} onChange={(e) => setCapacityFilter(e.target.value)} className="pl-9 pr-8 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium outline-none">
                                        <option value="">All</option><option value="4">4 Pax</option><option value="5">5 Pax</option><option value="6">6 Pax</option>
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">{CabinGrid}</div>
                        </section>

                        {selectedCabinId && !userBooking && (
                            <section id="booking-form-anchor" className="animate-enter">
                                <div className="glass-panel p-8 rounded-3xl shadow-xl max-w-2xl mx-auto border-l-4 border-indigo-600">
                                    <h2 className="text-2xl font-bold text-slate-900 mb-6">Booking Details for {selectedCabinId}</h2>
                                    
                                    <div className="mb-6">
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-2">I am booking as:</label>
                                        <div className="flex bg-slate-100 p-1 rounded-xl">
                                            <button onClick={() => setBookingRole('student')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${bookingRole === 'student' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}><GraduationCap className="w-4 h-4 inline mr-2"/>Student</button>
                                            <button onClick={() => setBookingRole('faculty')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${bookingRole === 'faculty' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500'}`}><Briefcase className="w-4 h-4 inline mr-2"/>Faculty</button>
                                        </div>
                                    </div>

                                    <div className="flex gap-4 mb-6 text-sm">
                                        <label className="flex items-center cursor-pointer">
                                            <input type="radio" checked={!isSpecialRequest} onChange={() => { setIsSpecialRequest(false); setGroupMembers(new Array(selectedCapacity).fill('')); }} className="mr-2 accent-indigo-600"/>
                                            <span className="font-medium text-slate-700">Standard (Full Capacity)</span>
                                        </label>
                                        <label className="flex items-center cursor-pointer">
                                            <input type="radio" checked={isSpecialRequest} onChange={() => { setIsSpecialRequest(true); setGroupMembers(['']); }} className="mr-2 accent-purple-600"/>
                                            <span className="font-medium text-slate-700">Special Request (1-2 Pax)</span>
                                        </label>
                                    </div>

                                    {isSpecialRequest && (
                                        <div className="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100">
                                            <div className="grid grid-cols-2 gap-4 mb-3">
                                                <div>
                                                    <label className="text-xs font-bold text-purple-700 uppercase">Reason</label>
                                                    <select value={specialReason} onChange={(e) => setSpecialReason(e.target.value)} className="w-full mt-1 p-2 rounded-lg border-purple-200 text-sm">
                                                        <option>Interview</option><option>Meeting</option><option>Other</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-purple-700 uppercase">Pax</label>
                                                    <select value={specialSize} onChange={(e) => { setSpecialSize(parseInt(e.target.value)); setGroupMembers(arr => new Array(parseInt(e.target.value)).fill('').map((_,i) => arr[i] || '')); }} className="w-full mt-1 p-2 rounded-lg border-purple-200 text-sm">
                                                        <option value="1">1 Person</option><option value="2">2 People</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <textarea value={specialComment} onChange={(e) => setSpecialComment(e.target.value)} placeholder="Additional details..." className="w-full p-2 rounded-lg border-purple-200 text-sm h-20 resize-none"></textarea>
                                        </div>
                                    )}

                                    <div className="space-y-3 mb-8">
                                        {groupMembers.map((name, i) => (
                                            <input key={i} type="text" value={name} onChange={(e) => { const n = [...groupMembers]; n[i] = e.target.value; setGroupMembers(n); }} placeholder={`Member ${i+1} Name`} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"/>
                                        ))}
                                    </div>

                                    <button onClick={submitBooking} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-[0.99] ${bookingRole === 'student' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-orange-600 hover:bg-orange-700'}`}>
                                        Confirm {bookingRole === 'student' ? 'Student' : 'Faculty'} Booking
                                    </button>
                                </div>
                            </section>
                        )}

                        <section className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm animate-enter" style={{animationDelay: '0.2s'}}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center">
                                    <LayoutDashboard className="w-5 h-5 mr-2 text-slate-500"/> 
                                    {isAdminLoggedIn ? 'Live Queue' : 'Admin Access Required'}
                                </h3>
                                
                                {isAdminLoggedIn && (
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        <button onClick={() => setAdminViewRole('student')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${adminViewRole === 'student' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Students</button>
                                        <button onClick={() => setAdminViewRole('faculty')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${adminViewRole === 'faculty' ? 'bg-white shadow text-orange-600' : 'text-slate-500'}`}>Faculty</button>
                                    </div>
                                )}
                            </div>

                            {isAdminLoggedIn ? (
                                <div className="space-y-3">{AdminQueue}</div>
                            ) : (
                                <div className="text-center py-12 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                                    <ShieldCheck className="w-12 h-12 mx-auto text-slate-300 mb-4"/>
                                    <h4 className="text-lg font-bold text-slate-700">Restricted Area</h4>
                                    <p className="text-sm text-slate-500 mb-6">Only authorized librarians can approve or reject booking requests.</p>
                                    <button 
                                        onClick={handleLoginClick}
                                        className="px-6 py-2.5 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors shadow-lg shadow-slate-200"
                                    >
                                        Login as Librarian
                                    </button>
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>