<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinControl - Study Space Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple icon styles for visibility */
        .icon { display: inline-block; width: 1.25rem; height: 1.25rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="app">
        <!-- Application will be rendered here by JavaScript -->
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center p-6 text-gray-500">Loading Application...</div>
        </div>
    </div>

    <!-- Confirmation Modal Container -->
    <div id="modal-root"></div>

    <!-- Alert Container -->
    <div id="alert-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Constants and Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Provided Firebase Configuration
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyCHimNRSSB4ZoqLCu5Okq4yL0i85EMzUIU",
            authDomain: "library-booking-83e2a.firebaseapp.com",
            projectId: "library-booking-83e2a",
            storageBucket: "library-booking-83e2a.firebasestorage.app",
            messagingSenderId: "712017475970",
            appId: "1:712017475970:web:760a61d2bcbde376eff79b",
            measurementId: "G-XEHSTZ2SYD"
        };
        
        // Use the environment variable if available, otherwise use the hardcoded config
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : hardcodedFirebaseConfig;

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const CABIN_COUNT = 15;
        const BOOKING_DURATION_HOURS = 2;
        const BOOKINGS_COLLECTION = `artifacts/${appId}/public/data/cabinBookings`;

        // --- CUSTOM CABIN CAPACITIES (Updated based on user request) ---
        const initialCabins = [
            { id: 'C1', name: 'Cabin 1', capacity: 6 },
            { id: 'C2', name: 'Cabin 2', capacity: 6 },
            { id: 'C3', name: 'Cabin 3', capacity: 4 },
            { id: 'C4', name: 'Cabin 4', capacity: 4 },
            { id: 'C5', name: 'Cabin 5', capacity: 5 },
            { id: 'C6', name: 'Cabin 6', capacity: 5 },
            { id: 'C7', name: 'Cabin 7', capacity: 4 },
            { id: 'C8', name: 'Cabin 8', capacity: 4 },
            { id: 'C9', name: 'Cabin 9', capacity: 4 },
            { id: 'C10', name: 'Cabin 10', capacity: 4 },
            { id: 'C11', name: 'Cabin 11', capacity: 4 },
            { id: 'C12', name: 'Cabin 12', capacity: 4 },
            { id: 'C13', name: 'Cabin 13', capacity: 4 },
            { id: 'C14', name: 'Cabin 14', capacity: 4 },
            { id: 'C15', name: 'Cabin 15', capacity: 4 },
        ];
        
        // setLogLevel('debug'); // Enable for detailed logging

        // --- Global State ---
        let state = {
            db: null,
            auth: null,
            isAuthReady: false,
            userId: null,
            allBookings: [],
            userBooking: null,
            selectedCabinId: '',
            selectedCapacity: 0,
            groupMembers: [],
            capacityFilter: '',
            countdownInterval: null,
            modal: null, // Added modal state
        };

        // --- Utility Functions ---

        /**
         * Simple deep merge state setter that triggers a re-render.
         * @param {object} newState 
         */
        const setState = (newState) => {
            Object.assign(state, newState);
            renderApp();
        };

        /**
         * Shows a temporary status message (toast).
         * @param {string} message - The message content.
         * @param {string} classes - Tailwind classes for styling (e.g., 'bg-emerald-600 text-white').
         * @param {string} iconSvg - Inline SVG icon for visual feedback.
         */
        const alertUser = (message, classes, iconSvg) => {
            const alertRoot = document.getElementById('alert-root');
            const alertDiv = document.createElement('div');
            
            // Generate a unique ID to ensure only one alert is active for transition
            const alertId = 'current-alert';
            const existingAlert = document.getElementById(alertId);
            if (existingAlert) {
                existingAlert.remove();
            }

            alertDiv.id = alertId;
            alertDiv.className = `fixed top-6 right-6 p-5 rounded-xl text-left font-semibold shadow-2xl transition-all duration-300 ease-out z-50 
                ${classes} opacity-0 translate-x-full 
                flex items-center space-x-3 backdrop-blur-md border border-white/20`;
            alertDiv.innerHTML = `${iconSvg} <span>${message}</span>`;
            alertRoot.appendChild(alertDiv);

            // Animate in
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0', 'translate-x-full');
                alertDiv.classList.add('opacity-100', 'translate-x-0');
            }, 10);

            // Animate out
            setTimeout(() => {
                alertDiv.classList.remove('opacity-100', 'translate-x-0');
                alertDiv.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => alertDiv.remove(), 700); // Remove after transition
            }, 6000);
        };

        /**
         * Calculates cabin status based on current bookings.
         */
        const getCabinStatus = (cabinId, allBookings) => {
            const now = new Date();
            
            // Look for an Approved booking that is active (not completed, time remaining)
            const activeBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Approved' &&
                !b.completionTime && 
                b.timestamp && 
                (b.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000) > now.getTime()
            );

            if (activeBooking) {
                return { 
                    status: 'Occupied', 
                    name: activeBooking.requesterName, 
                    endTime: activeBooking.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000 
                };
            }

            const pendingBooking = allBookings.find(b =>
                b.cabinId === cabinId &&
                b.status === 'Pending'
            );

            if (pendingBooking) {
                return { status: 'Pending Approval', name: pendingBooking.requesterName };
            }

            return { status: 'Available', name: null };
        };

        const generateSvg = (icon, classes) => {
            const icons = {
                // Simplified SVG paths (using only minimal paths for common icons)
                'clock': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
                'user': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
                'logout': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
                'download': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
                'alert-triangle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
                'check-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                'x-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
                'users': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                'book-open': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
                'zap': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
                'filter': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>`,
            };
            return icons[icon] || `<span class="${classes}">[${icon}]</span>`;
        };

        // --- Confirmation Modal Logic ---
        const renderModal = (modalData) => {
            const modalRoot = document.getElementById('modal-root');
            if (!modalData) {
                modalRoot.innerHTML = '';
                return;
            }

            const modalHtml = `
                <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex justify-center items-center z-50 transition-all duration-300">
                    <div id="modal-content" class="bg-white text-gray-900 p-8 rounded-3xl shadow-2xl w-full max-w-md mx-4 border border-gray-100 animate-in fade-in zoom-in-95 duration-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">${modalData.title}</h3>
                        <p class="text-gray-600 mb-8 leading-relaxed">${modalData.message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="py-2.5 px-5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button id="modal-confirm" class="py-2.5 px-5 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg shadow-red-600/20 transition-all transform active:scale-95">
                                ${modalData.confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modalRoot.innerHTML = modalHtml;

            const closeModal = () => setState({ modal: null });

            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-confirm').onclick = () => {
                if (modalData.action) modalData.action();
                closeModal();
            };
        };


        // --- Booking Action Functions ---

        const selectCabin = (cabinId, capacity) => {
            const groupMembers = new Array(capacity).fill('');
            setState({ 
                selectedCabinId: cabinId, 
                selectedCapacity: capacity, 
                groupMembers: groupMembers 
            });

            // Scroll to the request form
            setTimeout(() => {
                document.getElementById('student-request-form')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100); 
        };
        
        window.selectCabin = selectCabin; // Expose to global scope for inline HTML onClick

        const submitBooking = async () => {
            if (!state.isAuthReady || state.userBooking) {
                alertUser('Active request exists. Wait for completion.', 'bg-amber-500 text-gray-900', generateSvg('alert-triangle', 'w-5 h-5'));
                return;
            }

            if (!state.selectedCabinId || state.selectedCapacity === 0) {
                alertUser('Please select a cabin.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
                return;
            }
            
            const formInputs = document.querySelectorAll('#booking-members-form input');
            const filledMembers = Array.from(formInputs).map(input => (input.value || '').trim());
            
            if (filledMembers.length === 0 || filledMembers.some(name => !name)) {
                 alertUser('All member names are required.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
                 return;
            }

            if (getCabinStatus(state.selectedCabinId, state.allBookings).status !== 'Available') {
                alertUser('Cabin taken! Please select another.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
                return;
            }
            
            try {
                await addDoc(collection(state.db, BOOKINGS_COLLECTION), {
                    cabinId: state.selectedCabinId,
                    capacity: state.selectedCapacity,
                    requesterName: filledMembers[0],
                    requesterId: state.userId,
                    groupMembers: filledMembers,
                    timestamp: Timestamp.now(),
                    durationHours: BOOKING_DURATION_HOURS,
                    status: 'Pending',
                    approvedBy: null,
                    completionTime: null,
                    exportTimestamp: new Date().toISOString()
                });
                
                setState({
                    selectedCabinId: '',
                    selectedCapacity: 0,
                    groupMembers: [],
                });

                alertUser('Request submitted for approval!', 'bg-emerald-600 text-white', generateSvg('check-circle', 'w-5 h-5'));
            } catch (error) {
                console.error("Submission error:", error);
                alertUser('Submission failed.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
            }
        };

        window.submitBooking = submitBooking; // Expose to global scope for inline HTML onClick

        const cancelBooking = async () => {
            if (!state.userBooking || !state.db) return;
            try {
                await deleteDoc(doc(state.db, BOOKINGS_COLLECTION, state.userBooking.id));
                alertUser('Request cancelled.', 'bg-sky-600 text-white', generateSvg('logout', 'w-5 h-5'));
            } catch (error) {
                console.error("Cancel error:", error);
                alertUser('Error cancelling request.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
            }
        };
        
        const completeBookingEarly = async () => {
            if (!state.userBooking || state.userBooking.status !== 'Approved' || !state.db) return;
            
            try {
                await updateDoc(doc(state.db, BOOKINGS_COLLECTION, state.userBooking.id), {
                    status: 'Completed',
                    completionTime: Timestamp.now(),
                });
                alertUser('Checked out. Session complete.', 'bg-emerald-600 text-white', generateSvg('check-circle', 'w-5 h-5'));
            } catch (error) {
                console.error("Checkout error:", error);
                alertUser('Checkout failed.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
            }
        };

        const confirmCancelBooking = () => {
            setState({
                modal: {
                    title: "Terminate Request?",
                    message: "This will permanently remove your booking request. You will need to start over.",
                    confirmText: "Yes, Terminate",
                    action: cancelBooking,
                }
            });
        };
        
        window.confirmCancelBooking = confirmCancelBooking; // Expose to global scope for event listener
        
        const confirmCheckOut = () => {
            setState({
                modal: {
                    title: "End Session Early?",
                    message: "This will free up the cabin for other groups immediately.",
                    confirmText: "Yes, Check Out",
                    action: completeBookingEarly,
                }
            });
        };

        window.confirmCheckOut = confirmCheckOut; // Expose to global scope for event listener
        
        const updateBookingStatus = async (bookingId, newStatus) => {
            if (!state.isAuthReady || !state.db) return;
            
            const facultyName = 'Faculty Admin';
            const updateData = { status: newStatus };

            if (newStatus === 'Approved') {
                updateData.approvedBy = facultyName;
                updateData.timestamp = Timestamp.now();
            }

            try {
                await updateDoc(doc(state.db, BOOKINGS_COLLECTION, bookingId), updateData);
            } catch (error) {
                console.error("Update error:", error);
                alertUser('Action failed.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
            }
        };
        
        window.updateBookingStatus = updateBookingStatus; // Expose to global scope for inline HTML onClick

        // --- Timer Logic (Updates only the timer element, not the whole app) ---
        const startCountdown = () => {
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
                state.countdownInterval = null;
            }

            if (!state.userBooking || state.userBooking.status !== 'Approved' || state.userBooking.completionTime) {
                const timerDisplay = document.getElementById('countdown-timer');
                if(timerDisplay) timerDisplay.innerHTML = '--:--';
                return;
            }
            
            const booking = state.userBooking;
            const updateTimer = () => {
                const timerDisplay = document.getElementById('countdown-timer');
                if (!timerDisplay) {
                    clearInterval(state.countdownInterval);
                    state.countdownInterval = null;
                    return;
                }

                if (typeof booking.timestamp.getTime !== 'function') return;

                const startTime = booking.timestamp.getTime();
                const endTime = startTime + booking.durationHours * 60 * 60 * 1000;
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    timerDisplay.innerHTML = 'EXPIRED';
                    timerDisplay.closest('.text-right').classList.remove('text-emerald-600', 'animate-pulse');
                    timerDisplay.closest('.text-right').classList.add('text-red-600');
                    clearInterval(state.countdownInterval);
                    state.countdownInterval = null;
                    // Trigger a re-render to update the userBooking status if it was approved and has expired
                    if (state.userBooking.status === 'Approved') {
                         setState({});
                    }
                } else {
                    const minutesLeft = Math.floor(distance / (1000 * 60));
                    const isCritical = minutesLeft <= 5;

                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    timerDisplay.innerHTML = timeStr;
                    
                    const timerContainer = timerDisplay.closest('.text-right');
                    if (timerContainer) {
                        if (isCritical) {
                            timerDisplay.className = 'text-3xl font-mono font-bold text-red-600';
                            timerContainer.classList.add('animate-pulse');
                        } else {
                            timerDisplay.className = 'text-3xl font-mono font-bold text-emerald-600';
                            timerContainer.classList.remove('animate-pulse');
                        }
                    }
                }
            };

            updateTimer();
            state.countdownInterval = setInterval(updateTimer, 1000);
        };
        
        // --- Rendering Functions ---

        const renderHeader = () => {
            const headerHtml = `
                <header class="bg-indigo-600 text-white pt-12 pb-24 px-4 sm:px-8 shadow-xl">
                    <div class="max-w-7xl mx-auto flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">CabinControl</h1>
                            <p class="text-indigo-200 mt-2">Campus Study Space Management</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-mono bg-indigo-700/50 px-3 py-1 rounded-full text-indigo-200">
                                Current User ID: ${state.userId ? state.userId.substring(0, 8) + '...' : 'Connecting...'}
                            </div>
                            ${state.userId ? `
                                <div class="text-xs font-mono mt-1 text-indigo-300 break-all max-w-xs ml-auto">
                                    Full ID: ${state.userId}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </header>
            `;
            return headerHtml;
        };

        const renderStatusCard = () => {
            if (!state.userBooking) {
                return `
                    <div class="p-8 bg-white border-2 border-dashed border-gray-300 rounded-2xl text-center">
                        ${generateSvg('book-open', 'w-10 h-10 mx-auto text-gray-400 mb-3 icon')}
                        <h3 class="text-lg font-semibold text-gray-700">No Active Sessions</h3>
                        <p class="text-sm text-gray-500">Select a cabin below to start booking.</p>
                    </div>
                `;
            }
            
            const booking = state.userBooking;
            const isApproved = booking.status === 'Approved';
            const statusColor = isApproved ? 'bg-emerald-500' : 'bg-amber-500';
            const statusIcon = isApproved ? generateSvg('check-circle', 'w-3 h-3 mr-1 icon') : generateSvg('clock', 'w-3 h-3 mr-1 icon');

            // Immediately call startCountdown to initialize the timer display
            startCountdown();

            return `
                <div class="bg-white border-l-4 border-indigo-600 rounded-r-2xl shadow-lg overflow-hidden">
                    <div class="p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white mb-2 ${statusColor}">
                                    ${statusIcon}
                                    ${booking.status.toUpperCase()}
                                </span>
                                <h2 class="text-3xl font-bold text-gray-900">
                                    ${booking.cabinId} 
                                    <span class="text-lg font-normal text-gray-500 ml-2">(${booking.capacity} Pax)</span>
                                </h2>
                            </div>
                            ${isApproved ? `
                                <div class="text-right text-emerald-600">
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Time Remaining</p>
                                    <div id="countdown-timer" class="text-3xl font-mono font-bold">--:--</div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-gray-50 rounded-xl p-4 mb-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                ${booking.groupMembers.map((name, i) => `
                                    <div class="flex items-center text-sm text-gray-700">
                                        <div class="w-2 h-2 rounded-full mr-2 ${i===0 ? 'bg-indigo-500' : 'bg-gray-400'}"></div>
                                        <span class="${i===0 ? 'font-semibold' : ''}">${name} ${i===0 ? '(Host)' : ''}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            ${isApproved ? `
                                <button id="btn-checkout" class="flex-1 py-3 px-4 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-bold rounded-xl transition-colors flex items-center justify-center">
                                    ${generateSvg('logout', 'w-4 h-4 mr-2 icon')} Check Out
                                </button>
                            ` : ''}
                            <button id="btn-cancel" class="py-3 px-4 bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 font-bold rounded-xl transition-colors flex items-center justify-center ${!isApproved ? 'w-full' : 'flex-1'}">
                                Cancel Request
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCabinGrid = () => {
            const allCapacities = [...new Set(initialCabins.map(c => c.capacity))];
            
            const filteredCabins = initialCabins.filter(c => 
                !state.capacityFilter || c.capacity === parseInt(state.capacityFilter)
            );

            return filteredCabins.map(cabin => {
                const statusInfo = getCabinStatus(cabin.id, state.allBookings);
                const isAvailable = statusInfo.status === 'Available';
                const isOccupied = statusInfo.status === 'Occupied';
                const isSelected = state.selectedCabinId === cabin.id;
                
                let statusText, statusRing, statusIcon, borderColor, buttonText;
                
                if (isAvailable) {
                    statusText = 'Available';
                    statusRing = 'ring-emerald-400';
                    statusIcon = generateSvg('check-circle', 'w-5 h-5 text-emerald-600 mr-2 icon');
                    borderColor = isSelected ? 'border-amber-500' : 'border-emerald-400/30';
                    buttonText = isSelected ? 'Selected' : 'Select';
                } else if (statusInfo.status === 'Pending Approval') {
                    statusText = 'Pending';
                    statusRing = 'ring-amber-400';
                    statusIcon = generateSvg('clock', 'w-5 h-5 text-amber-600 mr-2 icon');
                    borderColor = 'border-amber-200';
                    buttonText = 'Unavailable';
                } else {
                    statusText = 'Occupied';
                    statusRing = 'ring-red-400';
                    statusIcon = generateSvg('x-circle', 'w-5 h-5 text-red-600 mr-2 icon');
                    borderColor = 'border-red-200';
                    buttonText = 'Unavailable';
                }

                const isDisabled = !isAvailable || !!state.userBooking;
                
                return `
                    <div 
                        data-cabin-id="${cabin.id}"
                        data-capacity="${cabin.capacity}"
                        class="
                            relative p-5 bg-white rounded-2xl shadow-sm transition-all duration-300 
                            border-2 ${borderColor}
                            ${isSelected ? `ring-2 ${statusRing} shadow-lg scale-[1.02]` : ''}
                            ${isDisabled ? 'opacity-60 grayscale-[0.3]' : 'hover:shadow-md hover:-translate-y-1 cursor-pointer'}
                        "
                        onclick="${!isDisabled ? `selectCabin('${cabin.id}', ${cabin.capacity})` : ''}"
                    >
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${cabin.name}</h3>
                            <div class="bg-indigo-50 text-indigo-600 p-1.5 rounded-lg">
                                ${generateSvg('users', 'w-4 h-4 icon')}
                            </div>
                        </div>
                        
                        <div class="flex items-center text-sm text-gray-500 mb-4">
                            <span class="font-medium">${cabin.capacity} Seats</span>
                        </div>

                        <div class="flex items-center text-sm font-semibold mb-2">
                             ${statusIcon}
                             <span class="${isOccupied ? 'text-red-600' : isAvailable ? 'text-emerald-600' : 'text-amber-600'}">
                                ${statusText}
                             </span>
                        </div>

                        ${statusInfo.name ? `
                            <div class="text-xs bg-gray-100 p-2 rounded-lg text-gray-600 truncate">
                                By: ${statusInfo.name}
                            </div>
                        ` : ''}
                        
                        <button 
                            class="
                                mt-4 w-full py-2 rounded-lg font-bold text-sm transition-colors
                                ${isSelected ? 'bg-amber-500 text-white' : 
                                  isDisabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 
                                  'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'}
                            "
                            disabled
                        >
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
        };

        const renderBookingForm = () => {
            if (!state.selectedCabinId || state.userBooking) return '';

            const inputs = [];
            for (let i = 0; i < state.selectedCapacity; i++) {
                const isRequester = i === 0;
                inputs.push(`
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">
                            ${isRequester ? 'Primary Requester (Your Name)' : `Member ${i + 1}`}
                        </label>
                        <input 
                            type="text"
                            id="member-input-${i}"
                            value="${state.groupMembers[i] || ''}"
                            oninput="updateGroupMember(${i}, this.value)"
                            placeholder="${isRequester ? 'Your Full Name' : 'Group Member Full Name'}"
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                        />
                    </div>
                `);
            }
            
            return `
                <section id="student-request-form" class="animate-in slide-in-from-bottom-10 fade-in duration-500">
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 max-w-3xl mx-auto">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="p-3 bg-amber-100 text-amber-600 rounded-xl">
                                ${generateSvg('zap', 'w-6 h-6 icon')}
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Finalize Request</h2>
                                <p class="text-gray-500">Booking <span class="font-bold text-gray-900">${state.selectedCabinId}</span> for ${BOOKING_DURATION_HOURS} hours</p>
                            </div>
                        </div>

                        <div id="booking-members-form" class="space-y-4 mb-8">
                            ${inputs.join('')}
                        </div>

                        <button 
                            onclick="submitBooking()"
                            class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-[0.99]"
                            ${!state.isAuthReady || state.userBooking ? 'disabled' : ''}
                        >
                            Submit Request
                        </button>
                    </div>
                </section>
            `;
        };

        window.updateGroupMember = (index, value) => {
            const newMembers = [...state.groupMembers];
            newMembers[index] = value;
            setState({ groupMembers: newMembers });
        };

        const renderAdminPanel = () => {
            const activeBookings = state.allBookings
                .filter(b => b.status === 'Pending' || b.status === 'Approved')
                .sort((a, b) => (a.timestamp?.getTime() || 0) - (b.timestamp?.getTime() || 0));

            const queueItems = activeBookings.map(b => {
                const isPending = b.status === 'Pending';
                
                return `
                    <div class="flex flex-col md:flex-row justify-between items-center p-4 bg-white border border-gray-100 rounded-xl shadow-sm mb-3 hover:shadow-md transition-shadow">
                        <div class="mb-3 md:mb-0 w-full md:w-auto">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-2 h-2 rounded-full ${isPending ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
                                <span class="font-bold text-gray-800">${b.cabinId}</span>
                                <span class="text-sm text-gray-500">- ${b.requesterName}</span>
                            </div>
                            <div class="text-xs text-gray-400 pl-4">
                                ${b.groupMembers.length} Members â€¢ ${b.timestamp?.toLocaleTimeString ? b.timestamp.toLocaleTimeString() : 'N/A'}
                            </div>
                        </div>
                        
                        <div class="flex gap-2 w-full md:w-auto">
                            ${isPending ? `
                                <button onclick="updateBookingStatus('${b.id}', 'Approved')" class="flex-1 md:flex-none py-1.5 px-3 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-semibold hover:bg-emerald-200">Approve</button>
                                <button onclick="updateBookingStatus('${b.id}', 'Rejected')" class="flex-1 md:flex-none py-1.5 px-3 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200">Reject</button>
                            ` : `
                                <button onclick="updateBookingStatus('${b.id}', 'Completed')" class="w-full md:w-auto py-1.5 px-3 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Force Complete</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <section class="bg-white rounded-2xl p-8 border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            ${generateSvg('users', 'w-5 h-5 mr-2 text-indigo-500 icon')}
                            Admin Queue
                        </h3>
                        <button onclick="exportCSV()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                            ${generateSvg('download', 'w-4 h-4 mr-1 icon')} Export Data
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${queueItems.length > 0 ? queueItems : '<div class="text-center text-gray-400 py-8">No active queue.</div>'}
                    </div>
                </section>
            `;
        };

        window.exportCSV = () => {
            if (!state.allBookings.length) {
                alertUser('No data to export.', 'bg-amber-500 text-gray-900', generateSvg('alert-triangle', 'w-5 h-5'));
                return;
            }

            const headers = ["ID","Cabin","Capacity","Status","Requester Name","Requester ID","Group Members","Time Booked (ISO)","Duration (Hours)","Approved By","Completion Time (ISO)"];
            const rows = state.allBookings.map(b => {
                 const timeStr = b.timestamp?.toISOString ? b.timestamp.toISOString() : '';
                 const completionStr = b.completionTime?.toISOString ? b.completionTime.toISOString() : '';
                 // Simple CSV escaping for group members
                 const groupMembersStr = `"${(b.groupMembers || []).map(m => m.replace(/"/g, '""')).join('|')}"`; 
                 
                 return [
                    b.id,
                    b.cabinId,
                    b.capacity,
                    b.status,
                    `"${b.requesterName.replace(/"/g, '""')}"`,
                    b.requesterId,
                    groupMembersStr,
                    timeStr,
                    b.durationHours,
                    `"${b.approvedBy || ''}"`,
                    completionStr
                 ].join(',');
            });
            
            const csvContent = [headers.join(',')].concat(rows).join('\n');
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
            link.download = `bookings-${Date.now()}.csv`;
            link.click();
            alertUser('Export Successful.', 'bg-indigo-600 text-white', generateSvg('download', 'w-5 h-5'));
        };

        const renderMainContent = () => {
            const main = document.createElement('main');
            main.className = "max-w-7xl mx-auto px-4 sm:px-8 -mt-16 space-y-12";
            
            // Generate filter options dynamically based on available capacities
            const allCapacities = [...new Set(initialCabins.map(c => c.capacity))].sort((a, b) => a - b);
            const filterOptions = allCapacities.map(cap => 
                `<option value="${cap}" ${state.capacityFilter === String(cap) ? 'selected' : ''}>${cap} Person</option>`
            ).join('');

            main.innerHTML = `
                <!-- 1. Status Section -->
                <section id="status-section">${renderStatusCard()}</section>

                <!-- 2. Selection Section -->
                <section>
                    <div class="flex flex-col sm:flex-row justify-between items-end mb-6 border-b border-gray-200 pb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Available Spaces</h2>
                            <p class="text-gray-500">Select a cabin for a ${BOOKING_DURATION_HOURS}-hour session</p>
                        </div>
                        <div class="mt-4 sm:mt-0 relative">
                            ${generateSvg('filter', 'w-4 h-4 text-gray-500 absolute left-3 top-3.5 icon')}
                            <select 
                                id="capacity-filter"
                                onchange="setState({ capacityFilter: this.value })"
                                class="pl-9 pr-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm appearance-none"
                            >
                                <option value="" ${!state.capacityFilter ? 'selected' : ''}>All Capacities</option>
                                ${filterOptions}
                            </select>
                            <svg class="w-4 h-4 absolute right-3 top-3.5 pointer-events-none text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    
                    <div id="cabin-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                        ${renderCabinGrid()}
                    </div>
                </section>

                <!-- 3. Booking Form -->
                ${renderBookingForm()}

                <!-- 4. Admin Panel -->
                <div id="admin-panel">
                    ${renderAdminPanel()}
                </div>
            `;
            return main.outerHTML;
        };

        const attachEventHandlers = () => {
            // Re-attach event listeners after every render, especially for Status Card buttons
            if (state.userBooking) {
                const btnCancel = document.getElementById('btn-cancel');
                if (btnCancel) btnCancel.onclick = confirmCancelBooking;
                
                const btnCheckout = document.getElementById('btn-checkout');
                if (btnCheckout) btnCheckout.onclick = confirmCheckOut;
            }
        };

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = renderHeader() + renderMainContent();
            renderModal(state.modal);
            attachEventHandlers();
        };

        // --- Firebase Initialization and Listener Setup ---
        const setupFirestoreListener = () => {
            if (!state.db || !state.isAuthReady || !state.userId) return;

            const q = query(collection(state.db, BOOKINGS_COLLECTION));
            
            onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const booking = { id: doc.id, ...data };
                    // Convert Firestore Timestamps to JS Dates
                    if (booking.timestamp && typeof booking.timestamp.toDate === 'function') {
                        booking.timestamp = booking.timestamp.toDate();
                    }
                    if (booking.completionTime && typeof booking.completionTime.toDate === 'function') {
                        booking.completionTime = booking.completionTime.toDate();
                    }
                    bookings.push(booking);
                });
                
                const now = new Date().getTime();
                
                const currentBooking = bookings.find(b => 
                    b.requesterId === state.userId && 
                    b.status === 'Pending' // User can only have one pending request
                );
                
                // Check if user has an active, unexpired, approved booking
                const activeApprovedBooking = bookings.find(b =>
                    b.requesterId === state.userId &&
                    b.status === 'Approved' &&
                    !b.completionTime &&
                    b.timestamp && 
                    (b.timestamp.getTime() + BOOKING_DURATION_HOURS * 60 * 60 * 1000) > now
                );
                
                const userBooking = activeApprovedBooking || currentBooking || null;

                setState({ 
                    allBookings: bookings, 
                    userBooking: userBooking 
                });
            }, (error) => {
                console.error("Error fetching bookings:", error);
                alertUser('Connection error. Retrying...', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
            });
        };

        const initFirebase = async () => {
            if (!firebaseConfig) {
                alertUser('Firebase config missing.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                setState({ db, auth });

                // Authentication
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth failed:", error);
                    alertUser('Auth failed. Refresh page.', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setState({ userId: user.uid, isAuthReady: true });
                        setupFirestoreListener(); // Start listening once authenticated
                    }
                });

            } catch (err) {
                console.error("Firebase init failed:", err);
                alertUser('App Initialization Failed', 'bg-red-600 text-white', generateSvg('x-circle', 'w-5 h-5'));
            }
        };

        // Initialize the app on load
        window.onload = initFirebase;
    </script>
</body>
</html>